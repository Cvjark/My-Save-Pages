<!DOCTYPE html>
<!-- saved from url=(0039)https://bbs.pediy.com/thread-269534.htm -->
<html lang="zh-cn"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		
	
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="XiunoBBS 4.0">
	<meta name="keywords" content="AFL二三事 -- 源码分析 1">
	<meta name="description" content="AFL二三事 -- 源码分析 1">
	<meta name="application-name" content="AFL二三事 -- 源码分析 1-二进制漏洞-看雪论坛-安全社区|安全招聘|bbs.pediy.com">
	<meta name="csrf-token" content="955e3c849f04bfea92fbc871746f9ddf">
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<title>
		AFL二三事 -- 源码分析 1-二进制漏洞-看雪论坛-安全社区|安全招聘|bbs.pediy.com	</title>

	<link rel="shortcut icon" href="https://bbs.pediy.com/view/img/favicon.ico">
	<link rel="icon" sizes="32x32" href="https://bbs.pediy.com/view/img/favicon.ico">
	<link rel="Bookmark" href="https://bbs.pediy.com/view/img/favicon.ico">
	<link rel="stylesheet" href="./AFL二三事 -- 源码分析 1/bootstrap.css">
	<link rel="stylesheet" href="./AFL二三事 -- 源码分析 1/bootstrap-bbs.css">
	<!-- <link rel="stylesheet" href="view/css/bootstrap-icon.css"> -->

	<link rel="stylesheet" href="./AFL二三事 -- 源码分析 1/kanxue.css">

	<style>
		@media only screen and (max-width: 780px) {

			.card>.card-body {
				padding: 0.3rem 0.5rem;
			}

			#body {
				padding: 0.5rem 0.5rem;
			}

			.container {
				padding-left: 0;
				padding-right: 0;
			}

		}

		.content_box ul.nav .nav-link.active {
			border-bottom: 3px solid #0099ee;
		}

		.avatar-3 {
			width: 3.5rem;
			height: 3.5rem;
			border-radius: 3.5rem;
		}

		main#body {
			background: #e9ecef;
		}
	</style>

	<style>
		/* .photo_frame {
			padding: 0.36rem;
		}
		.photo_frame::after {
			content: '';
			background-size: 102%;
			background-position: right top;
			background-repeat: no-repeat;
			width: 100%;
			height: 100%;

			display: inline-block;
			vertical-align: middle;
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			z-index: 1;
		}

		.photo_frame_image1::after {
			background-image: url(view/img/20photo_frame1.png);
		}

		.photo_frame_image2::after {
			background-image: url(view/img/20photo_frame2.png);
		}

		.photo_frame_image3::after {
			background-image: url(view/img/20photo_frame3.png);
		} */
	</style>

	    <link rel="stylesheet" href="./AFL二三事 -- 源码分析 1/user_tree.css" type="text/css">
    <link rel="stylesheet" href="./AFL二三事 -- 源码分析 1/folder-tree.css" type="text/css">
<style>
/*
box-shadow: 0 0 5px red;
*/
@keyframes xndigest {
	0% { color: red; text-shadow: 0 0 3px #FF8D8D;} 
	20% { color: orange; text-shadow: 0 0 3px #FFE1AD;} 
	40% { color: green; text-shadow: 0 0 3px #B3FFAF;} 
	65% { color: blue; text-shadow: 0 0 3px #AFE4FF;} 
	80% { color: purple; text-shadow: 0 0 3px #FFC9F3;} 
	100% { color: red; text-shadow: 0 0 3px #FF8D8D;} 
}

/*水晶闪烁效果 占内存*/
i.icon-diamond.flash{color: #D53D38;  /*animation: xndigest 5s linear infinite;*/ }

i.icon-digest-1 {  text-shadow: 0 0 3px #AFE4FF; }
i.icon-digest-2 {  text-shadow: 0 0 3px #FFF177; }
i.icon-digest-3 {  text-shadow: 0 0 3px #FF8D8D; }
.icon-digest-1:before { content: "\f219";  color: #5BC0DE;} /* "\f0a5" */
.icon-digest-2:before { content: "\f219";  color: #ECA541;}
.icon-digest-3:before { content: "\f219"; color: #D53D38;}
.icon-digest-3:afteer { content: "精"; color: #D53D38;}
</style><style>
.deleted div.subject > a { text-decoration: line-through; color: grey !important; }
.deleted div.message { text-decoration: line-through; color: grey !important; }
</style><style>
/*
.toggle_more {
	max-height: 100px;
}
*/
.update_log_list a.update_log_history, 
.update_log_list a.update_log_delete {
	display: none;
}

.update_log_list > li:hover {
	background: var(--gray-300);
}
.update_log_list > li:hover > a.update_log_history, 
.update_log_list > li:hover > a.update_log_delete {
	display: inline-block;
}

</style><style>
.icon-new { width: 26px; height: 12px; display: inline-block; background: url(view/img/new.gif)}
</style>

<link rel="stylesheet" href="./AFL二三事 -- 源码分析 1/layer.css" id="layuicss-skinlayercss"><script charset="utf-8" src="chrome-extension://jgphnjokjhjlcnnajmfjlacjnjkhleah/js/btype.js"></script><script type="text/javascript" charset="utf-8" src="chrome-extension://jgphnjokjhjlcnnajmfjlacjnjkhleah/js/chrome.js"></script><script src="./AFL二三事 -- 源码分析 1/ga.js"></script></head>

<body><svg aria-hidden="true" style="position: absolute; width: 0px; height: 0px; overflow: hidden;"><symbol id="icon-group_101" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#93E4D8"></path><path d="M569.6 224v588.8h57.6V224zM1004.8 505.6v300.8h-57.6v-25.6h-204.8v32h-57.6V505.6h320z m-57.6 57.6h-70.4v160h70.4V563.2z m-128 0h-76.8v160h76.8V563.2zM851.2 364.8l-44.8 32c32 32 64 64 83.2 96l44.8-32c-19.2-25.6-44.8-57.6-83.2-96zM460.8 300.8V704h64V300.8z" fill="#FFFFFF"></path><path d="M761.6 358.4h256v-64h-224l12.8-44.8c0-6.4 6.4-12.8 6.4-19.2l-57.6-12.8c-32 89.6-70.4 153.6-108.8 204.8l38.4 51.2c32-32 57.6-76.8 76.8-115.2zM1363.2 268.8v480h-57.6V704h-76.8v57.6h-64V268.8h198.4zM1305.6 512h-76.8v140.8h76.8V512z m0-192h-76.8v134.4h76.8V320zM1459.2 460.8l-51.2 32c38.4 57.6 70.4 115.2 89.6 160l51.2-38.4c-19.2-44.8-51.2-96-89.6-153.6z" fill="#FFFFFF"></path><path d="M1600 806.4h-115.2l-12.8-57.6h108.8c12.8 0 25.6-6.4 25.6-25.6V390.4h-211.2v-57.6h211.2V224h64v108.8h70.4v57.6h-70.4v345.6c-6.4 51.2-32 70.4-70.4 70.4z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_102" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#81E2ED"></path><path d="M608 499.2c12.8 25.6 32 51.2 51.2 83.2l38.4-51.2c-25.6-32-57.6-64-83.2-96v-32h70.4v-57.6H608V224h-64v121.6H460.8v57.6h83.2C524.8 473.6 492.8 544 448 601.6l25.6 64c32-44.8 57.6-102.4 70.4-160v300.8h64V499.2z" fill="#FFFFFF"></path><path d="M972.8 243.2v38.4c-12.8 51.2-25.6 102.4-32 140.8h76.8v32c-12.8 83.2-44.8 160-83.2 217.6 32 32 70.4 64 115.2 89.6l-44.8 51.2c-38.4-32-76.8-57.6-108.8-96-38.4 38.4-83.2 70.4-134.4 96l-38.4-57.6c51.2-25.6 96-51.2 128-89.6-32-44.8-57.6-89.6-70.4-140.8-19.2 121.6-57.6 217.6-108.8 281.6l-51.2-38.4c70.4-83.2 108.8-224 108.8-409.6v-57.6h-64v-57.6h307.2z m-64 57.6h-121.6v89.6c12.8 89.6 51.2 166.4 102.4 236.8 32-44.8 51.2-96 64-147.2h-89.6c12.8-38.4 25.6-83.2 32-134.4l12.8-44.8zM1644.8 608v204.8h-57.6v-25.6h-256v25.6h-57.6V608h371.2z m-57.6 51.2h-256v76.8h256v-76.8z" fill="#FFFFFF"></path><path d="M1363.2 326.4l57.6 12.8c-6.4 12.8-12.8 25.6-25.6 32h230.4v51.2c-25.6 32-57.6 64-102.4 89.6 64 25.6 134.4 38.4 217.6 38.4l-12.8 57.6c-102.4-6.4-192-25.6-268.8-64-76.8 32-166.4 57.6-281.6 76.8l-25.6-57.6c96-12.8 179.2-32 243.2-57.6-25.6-12.8-51.2-32-70.4-51.2l-76.8 57.6-38.4-44.8c57.6-38.4 108.8-83.2 153.6-140.8z m185.6 96h-185.6c32 25.6 57.6 44.8 96 57.6 38.4-12.8 70.4-32 89.6-57.6z" fill="#FFFFFF"></path><path d="M1715.2 262.4v128h-64V320h-409.6v76.8h-64v-128H1408l-19.2-38.4 70.4-12.8c6.4 12.8 12.8 32 19.2 44.8h236.8z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_7" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#C1D5E4"></path><path d="M563.2 486.4v51.2h435.2v-51.2H563.2zM512 576v57.6h249.6v102.4c0 12.8-6.4 19.2-19.2 19.2-19.2 0-32 0-51.2-6.4l12.8 57.6h57.6c38.4 0 64-19.2 64-57.6V633.6h230.4V576H512z m409.6 76.8l-32 44.8c44.8 25.6 89.6 64 128 108.8l32-51.2c-32-38.4-76.8-76.8-128-102.4z m-294.4 0c-32 38.4-70.4 70.4-121.6 102.4l38.4 51.2c51.2-32 89.6-70.4 128-115.2l-44.8-38.4zM512 262.4V320h96c-32 38.4-64 70.4-108.8 96l32 51.2c32-25.6 64-57.6 83.2-102.4v102.4h57.6V364.8c12.8 12.8 32 32 51.2 57.6l32-51.2c-19.2-12.8-51.2-32-76.8-51.2H768v-57.6h-89.6v-51.2h-64v51.2H512z m281.6 0V320h64c-25.6 38.4-57.6 70.4-96 96l32 51.2c32-32 57.6-70.4 83.2-115.2v115.2h57.6V345.6c19.2 38.4 51.2 76.8 83.2 115.2l38.4-51.2c-38.4-25.6-70.4-57.6-89.6-89.6h89.6v-57.6h-108.8v-51.2h-57.6v51.2h-96z m691.2-44.8h64v204.8h192v57.6h-192v243.2h230.4v57.6h-569.6v-57.6h102.4V326.4h64v390.4h121.6V217.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_104" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#72D6FF"></path><path d="M460.8 384v57.6h236.8c-32 147.2-115.2 256-249.6 320l38.4 51.2c128-70.4 217.6-172.8 256-320 51.2 134.4 134.4 243.2 256 320l38.4-51.2c-128-76.8-211.2-179.2-256-320H1024V384h-256c6.4-38.4 6.4-76.8 6.4-121.6v-38.4h-64v57.6c0 38.4 0 70.4-6.4 108.8H460.8zM1216 480v332.8h64V384c25.6-44.8 44.8-89.6 57.6-140.8l-57.6-25.6c-25.6 96-70.4 185.6-128 262.4l19.2 64c12.8-25.6 32-44.8 44.8-64zM1644.8 371.2c-12.8 44.8-25.6 83.2-44.8 115.2l51.2 19.2c19.2-32 32-70.4 44.8-115.2l-51.2-19.2zM1395.2 371.2l-51.2 19.2c12.8 32 25.6 70.4 38.4 108.8l51.2-12.8c-12.8-44.8-25.6-76.8-38.4-115.2z" fill="#FFFFFF"></path><path d="M1337.6 294.4h160V224h57.6v70.4h160v57.6h-160v70.4c0 32 0 64-6.4 89.6H1728v57.6h-160c38.4 70.4 96 134.4 179.2 185.6l-44.8 51.2c-83.2-64-140.8-134.4-179.2-211.2-32 96-102.4 166.4-198.4 211.2l-38.4-51.2c96-25.6 160-89.6 185.6-179.2h-153.6v-57.6h166.4c6.4-25.6 6.4-51.2 6.4-76.8V352h-160v-57.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_114" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FFA966"></path><path d="M1030.4 352h-121.6c19.2-25.6 44.8-64 64-102.4l-64-25.6c-19.2 44.8-44.8 89.6-70.4 128H601.6l38.4-19.2c-19.2-38.4-38.4-70.4-57.6-102.4l-57.6 25.6c19.2 25.6 44.8 57.6 64 89.6H473.6v153.6h57.6V409.6h435.2v96h57.6V352z" fill="#FFFFFF"></path><path d="M576 448v51.2h256l-19.2 12.8c-25.6 12.8-51.2 25.6-83.2 38.4v51.2h-256v57.6h256v76.8c0 12.8-6.4 25.6-19.2 25.6H633.6l12.8 57.6h83.2c38.4 0 57.6-19.2 57.6-57.6v-102.4H1024v-57.6h-236.8V576c51.2-25.6 96-51.2 134.4-76.8V448H576zM736 217.6l-57.6 25.6c19.2 32 44.8 64 64 102.4l51.2-25.6c-19.2-38.4-38.4-70.4-57.6-102.4zM1459.2 224v64H1600v57.6h-140.8v64H1536c51.2-38.4 96-76.8 134.4-121.6l19.2-25.6 44.8 32c-25.6 32-51.2 57.6-83.2 89.6l-25.6 19.2h115.2v57.6h-192l-25.6 12.8c-19.2 12.8-38.4 25.6-64 32l-19.2 6.4h217.6v294.4h-64v-12.8h-256v25.6h-64V588.8l-102.4 38.4-25.6-57.6c89.6-19.2 172.8-51.2 249.6-89.6l32-12.8h-268.8v-64h230.4v-57.6H1216v-57.6h172.8v-64h70.4z m147.2 454.4h-256v57.6h256v-57.6z m0-102.4h-256v57.6h256V576z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_21" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#63AFFF"></path><path d="M729.6 217.6C652.8 300.8 563.2 371.2 448 422.4l32 57.6c108.8-57.6 204.8-128 268.8-211.2 76.8 89.6 160 160 268.8 211.2l32-57.6c-102.4-44.8-198.4-115.2-275.2-204.8h-44.8z" fill="#FFFFFF"></path><path d="M736 390.4v332.8H627.2V480h-57.6v243.2H480v64h537.6v-64h-217.6V582.4h166.4v-57.6h-166.4V390.4zM1356.8 224v499.2h-185.6v64h569.6v-64h-185.6V224h-64v499.2h-76.8V224z" fill="#FFFFFF"></path><path d="M1670.4 339.2c-25.6 115.2-57.6 211.2-96 281.6l57.6 19.2c38.4-83.2 70.4-179.2 96-288l-57.6-12.8zM1235.2 339.2c32 83.2 64 185.6 89.6 294.4l-57.6 12.8c-19.2-102.4-51.2-198.4-83.2-288l51.2-19.2z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_118" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FF997D"></path><path d="M473.6 371.2v57.6h236.8c-32 147.2-115.2 256-249.6 320l38.4 51.2c128-70.4 217.6-172.8 256-320 51.2 134.4 134.4 243.2 256 313.6l38.4-51.2c-128-76.8-211.2-179.2-256-320h243.2v-51.2h-256c6.4-38.4 6.4-76.8 6.4-121.6v-38.4h-64v57.6c0 38.4 0 70.4-6.4 108.8H473.6zM1190.4 300.8V640h57.6V300.8z" fill="#FFFFFF"></path><path d="M1292.8 211.2v307.2c0 108.8-38.4 192-108.8 243.2l44.8 38.4c76.8-57.6 121.6-153.6 121.6-281.6V211.2h-57.6zM1388.8 230.4h358.4v57.6h-153.6v70.4H1728v313.6c0 38.4-19.2 64-51.2 64h-44.8l-12.8-57.6 38.4 6.4c12.8-6.4 19.2-12.8 19.2-25.6V416H1600v384h-57.6v-384h-76.8v320H1408V358.4h134.4V288h-153.6v-57.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_2" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#798FEC"></path><path d="M1011.2 505.6v204.8h-256V505.6h256z m-57.6 51.2h-140.8v102.4h140.8V556.8z" fill="#FFFFFF"></path><path d="M480 294.4H576V211.2h57.6v83.2h89.6v51.2H633.6v83.2h89.6v57.6h-76.8v76.8h76.8v57.6h-76.8v96h6.4c32 12.8 115.2 19.2 236.8 19.2h19.2c57.6 0 96 0 128-6.4l-6.4 64h-108.8c-160 0-262.4-6.4-307.2-25.6-32-12.8-57.6-38.4-83.2-76.8-6.4 38.4-19.2 76.8-32 108.8l-44.8-38.4c25.6-76.8 38.4-153.6 44.8-243.2l51.2 6.4c0 38.4-6.4 70.4-6.4 96 12.8 25.6 32 44.8 44.8 57.6v-192H473.6v-57.6h96V345.6H480v-51.2z" fill="#FFFFFF"></path><path d="M742.4 294.4v-57.6H1024c0 115.2-6.4 179.2-19.2 204.8-19.2 25.6-38.4 32-64 32h-51.2l-12.8-51.2h51.2c12.8 0 25.6-6.4 25.6-19.2 6.4-12.8 6.4-51.2 6.4-108.8h-83.2c-6.4 44.8-19.2 76.8-32 102.4-19.2 32-44.8 57.6-76.8 83.2l-44.8-44.8c32-19.2 51.2-38.4 70.4-64 12.8-19.2 19.2-44.8 25.6-76.8h-76.8zM1312 217.6h57.6V384h38.4v64h-147.2v70.4h121.6v281.6h-57.6V576h-64c-6.4 89.6-25.6 166.4-51.2 211.2l-51.2-32c25.6-57.6 38.4-153.6 38.4-281.6V230.4h57.6V384h51.2V217.6z" fill="#FFFFFF"></path><path d="M1708.8 217.6l25.6 51.2c-76.8 19.2-153.6 32-249.6 38.4v83.2h230.4v51.2c-6.4 89.6-32 160-70.4 217.6 32 38.4 64 70.4 108.8 89.6l-32 51.2c-44.8-25.6-83.2-51.2-115.2-96-32 38.4-70.4 70.4-121.6 96l-25.6-51.2c44.8-25.6 83.2-51.2 115.2-89.6-32-57.6-57.6-128-70.4-204.8h-12.8v51.2c0 121.6-25.6 224-64 294.4l-44.8-44.8c32-57.6 51.2-140.8 51.2-249.6V256c102.4 0 192-12.8 275.2-38.4zM1664 454.4h-108.8c12.8 64 32 115.2 51.2 153.6 32-51.2 44.8-102.4 57.6-153.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_8" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#CDA6F4"></path><path d="M550.4 268.8l185.6 512H832l185.6-512h-83.2l-147.2 422.4-153.6-422.4H550.4z m518.4 0v512h76.8v-512h-76.8z m172.8 0v512h76.8V582.4h134.4c121.6 0 185.6-51.2 185.6-153.6 0-102.4-57.6-153.6-179.2-153.6h-217.6z m83.2 64h128c38.4 0 64 6.4 83.2 19.2 19.2 12.8 25.6 38.4 25.6 64s-12.8 64-25.6 76.8c-19.2 12.8-44.8 19.2-83.2 19.2h-128V332.8z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_6" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#C1D5E4"></path><path d="M774.4 416V448h179.2v-38.4c19.2 19.2 38.4 44.8 64 64l32-51.2c-76.8-57.6-128-128-160-204.8h-51.2c-38.4 83.2-89.6 153.6-160 211.2l32 51.2 64-64z m166.4-19.2h-147.2c25.6-32 51.2-76.8 76.8-121.6 12.8 44.8 38.4 83.2 70.4 121.6z m-243.2 326.4v57.6h345.6v-57.6H960c25.6-64 44.8-140.8 57.6-230.4l-57.6-12.8c-19.2 96-38.4 179.2-57.6 243.2h-204.8zM768 499.2l-51.2 19.2c19.2 57.6 38.4 115.2 51.2 172.8l51.2-12.8c-19.2-64-32-128-51.2-179.2z m96-19.2l-51.2 19.2c19.2 51.2 32 108.8 44.8 166.4l51.2-12.8c-12.8-64-32-121.6-44.8-172.8zM620.8 294.4l-25.6 211.2h-64l25.6-166.4h-57.6l-25.6 217.6h160v32c0 70.4-6.4 115.2-6.4 128-6.4 19.2-25.6 25.6-51.2 25.6-6.4 0-25.6 0-44.8-6.4l12.8 51.2h44.8c38.4 0 70.4-12.8 83.2-32 12.8-25.6 19.2-108.8 19.2-256h-38.4l32-262.4H473.6v57.6h147.2z m-12.8 307.2c-44.8 12.8-89.6 25.6-147.2 32l6.4 57.6c51.2-12.8 96-25.6 140.8-38.4v-51.2z m934.4-300.8v422.4H1472V396.8h-57.6v326.4h-57.6v57.6h390.4v-57.6h-134.4V518.4H1728v-57.6h-115.2V300.8H1728v-57.6h-358.4v57.6h172.8z m-294.4-76.8l-38.4 38.4c44.8 32 76.8 64 102.4 96l32-44.8c-25.6-32-57.6-57.6-96-89.6z m-89.6 179.2h140.8v262.4c19.2-12.8 32-32 57.6-51.2l12.8 64c-38.4 38.4-76.8 70.4-121.6 96l-25.6-57.6c12.8-6.4 12.8-19.2 12.8-32V460.8h-89.6v-57.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_110" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FFC55F"></path><path d="M460.8 403.2v64h160c-12.8 44.8-25.6 83.2-44.8 128h307.2c-32 38.4-76.8 70.4-128 102.4-32-12.8-76.8-25.6-121.6-38.4l-32 44.8c102.4 25.6 198.4 64 294.4 108.8l32-51.2c-32-12.8-64-25.6-102.4-38.4 64-44.8 108.8-89.6 134.4-128v-57.6h-294.4c12.8-25.6 19.2-44.8 25.6-70.4h345.6v-64H704l12.8-38.4c0-6.4 6.4-12.8 6.4-25.6h281.6v-57.6h-268.8c6.4-19.2 6.4-44.8 12.8-70.4h-64l-12.8 70.4H505.6v57.6h153.6l-19.2 64H460.8zM1548.8 563.2c32 83.2 76.8 160 147.2 217.6l44.8-51.2c-64-44.8-115.2-108.8-140.8-179.2 38.4-19.2 76.8-38.4 108.8-57.6l-38.4-38.4c-51.2 32-102.4 57.6-160 70.4-12.8-25.6-25.6-44.8-44.8-64l19.2-19.2c6.4-6.4 12.8-6.4 12.8-12.8h140.8v-57.6h-377.6v57.6h140.8c-12.8 6.4-25.6 12.8-44.8 19.2-51.2 19.2-108.8 38.4-166.4 51.2l38.4 51.2c76.8-25.6 134.4-44.8 179.2-64h6.4c6.4 6.4 12.8 12.8 19.2 25.6-57.6 44.8-140.8 76.8-243.2 102.4l32 51.2c102.4-32 179.2-64 236.8-108.8 6.4 12.8 12.8 25.6 12.8 38.4-70.4 57.6-166.4 102.4-294.4 134.4l32 51.2c108.8-32 204.8-76.8 268.8-128v19.2c0 38.4-6.4 57.6-12.8 70.4-6.4 12.8-32 12.8-70.4 12.8h-32l19.2 51.2h19.2c57.6 0 96-12.8 115.2-32 12.8-19.2 19.2-57.6 19.2-108.8 0-32-6.4-64-12.8-96 12.8 0 19.2-6.4 25.6-6.4z" fill="#FFFFFF"></path><path d="M1472 211.2c6.4 19.2 12.8 32 19.2 57.6h243.2v121.6h-57.6v-64h-428.8v64h-64V268.8h249.6c-6.4-19.2-12.8-32-19.2-44.8l57.6-12.8z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_4" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#93ABF4"></path><path d="M595.2 217.6V384h-51.2V230.4h-57.6v236.8c0 128-12.8 224-38.4 288l44.8 38.4c25.6-51.2 44.8-121.6 51.2-217.6h64v224h57.6V518.4H544v-32V448h140.8V384h-32V217.6h-57.6z" fill="#FFFFFF"></path><path d="M992 217.6l32 51.2c-76.8 25.6-160 38.4-249.6 38.4v83.2h236.8v51.2c-19.2 89.6-44.8 160-83.2 224 32 38.4 64 70.4 108.8 89.6l-32 51.2c-44.8-25.6-83.2-57.6-115.2-96-32 38.4-70.4 70.4-115.2 96l-32-51.2c44.8-25.6 83.2-57.6 115.2-96-32-57.6-57.6-121.6-70.4-204.8h-12.8v51.2c0 121.6-25.6 224-64 294.4l-44.8-44.8c32-57.6 51.2-140.8 51.2-249.6V256c102.4 0 192-12.8 275.2-38.4z m-44.8 236.8h-102.4c12.8 57.6 25.6 108.8 51.2 153.6 25.6-44.8 44.8-96 51.2-153.6zM1414.4 377.6h-230.4V320h230.4c-12.8-32-19.2-64-38.4-89.6l57.6-19.2c12.8 38.4 25.6 70.4 38.4 102.4h236.8v57.6h-230.4v134.4h204.8v57.6h-204.8v160h256v57.6h-569.6v-57.6h256V569.6h-211.2V512H1408V377.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_107" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#96C7F9"></path><path d="M486.4 371.2v57.6h236.8c-32 147.2-115.2 256-249.6 320l38.4 51.2c128-70.4 217.6-179.2 256-320 51.2 134.4 134.4 243.2 256 320l38.4-51.2c-128-76.8-211.2-179.2-256-320h243.2v-57.6h-256c6.4-38.4 6.4-83.2 6.4-121.6v-44.8h-64v57.6c0 38.4 0 70.4-6.4 108.8H486.4zM1292.8 396.8c-19.2 44.8-44.8 76.8-70.4 115.2l-38.4-51.2c44.8-57.6 83.2-134.4 115.2-230.4l57.6 12.8-38.4 96h134.4V204.8h64v128H1728v64h-211.2v147.2h243.2v57.6h-243.2v192h-64v-192h-268.8v-64h268.8V396.8h-160z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_117" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FFA966"></path><path d="M1030.4 352h-121.6c19.2-25.6 44.8-64 64-102.4l-64-25.6c-19.2 44.8-44.8 89.6-70.4 128H601.6l38.4-19.2c-19.2-38.4-38.4-70.4-57.6-102.4l-57.6 25.6c19.2 25.6 44.8 57.6 64 89.6H473.6v153.6h57.6V409.6h435.2v96h57.6V352z" fill="#FFFFFF"></path><path d="M576 448v51.2h256l-19.2 12.8c-25.6 12.8-51.2 25.6-83.2 38.4v51.2h-256v57.6h256v76.8c0 12.8-6.4 25.6-19.2 25.6H633.6l12.8 57.6h83.2c38.4 0 57.6-19.2 57.6-57.6v-102.4H1024v-57.6h-236.8V576c51.2-25.6 96-51.2 134.4-76.8V448H576zM736 217.6l-57.6 25.6c19.2 32 44.8 64 64 102.4l51.2-25.6c-19.2-38.4-38.4-70.4-57.6-102.4zM1459.2 224v64H1600v57.6h-140.8v64H1536c51.2-38.4 96-76.8 134.4-121.6l19.2-25.6 44.8 32c-25.6 32-51.2 57.6-83.2 89.6l-25.6 19.2h115.2v57.6h-192l-25.6 12.8c-19.2 12.8-38.4 25.6-64 32l-19.2 6.4h217.6v294.4h-64v-12.8h-256v25.6h-64V588.8l-102.4 38.4-25.6-57.6c89.6-19.2 172.8-51.2 249.6-89.6l32-12.8h-268.8v-64h230.4v-57.6H1216v-57.6h172.8v-64h70.4z m147.2 454.4h-256v57.6h256v-57.6z m0-102.4h-256v57.6h256V576z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_115" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FFA966"></path><path d="M1030.4 352h-121.6c19.2-25.6 44.8-64 64-102.4l-64-25.6c-19.2 44.8-44.8 89.6-70.4 128H601.6l38.4-19.2c-19.2-38.4-38.4-70.4-57.6-102.4l-57.6 25.6c19.2 25.6 44.8 57.6 64 89.6H473.6v153.6h57.6V409.6h435.2v96h57.6V352z" fill="#FFFFFF"></path><path d="M576 448v51.2h256l-19.2 12.8c-25.6 12.8-51.2 25.6-83.2 38.4v51.2h-256v57.6h256v76.8c0 12.8-6.4 25.6-19.2 25.6H633.6l12.8 57.6h83.2c38.4 0 57.6-19.2 57.6-57.6v-102.4H1024v-57.6h-236.8V576c51.2-25.6 96-51.2 134.4-76.8V448H576zM736 217.6l-57.6 25.6c19.2 32 44.8 64 64 102.4l51.2-25.6c-19.2-38.4-38.4-70.4-57.6-102.4zM1459.2 224v64H1600v57.6h-140.8v64H1536c51.2-38.4 96-76.8 134.4-121.6l19.2-25.6 44.8 32c-25.6 32-51.2 57.6-83.2 89.6l-25.6 19.2h115.2v57.6h-192l-25.6 12.8c-19.2 12.8-38.4 25.6-64 32l-19.2 6.4h217.6v294.4h-64v-12.8h-256v25.6h-64V588.8l-102.4 38.4-25.6-57.6c89.6-19.2 172.8-51.2 249.6-89.6l32-12.8h-268.8v-64h230.4v-57.6H1216v-57.6h172.8v-64h70.4z m147.2 454.4h-256v57.6h256v-57.6z m0-102.4h-256v57.6h256V576z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_116" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FFA966"></path><path d="M1030.4 352h-121.6c19.2-25.6 44.8-64 64-102.4l-64-25.6c-19.2 44.8-44.8 89.6-70.4 128H601.6l38.4-19.2c-19.2-38.4-38.4-70.4-57.6-102.4l-57.6 25.6c19.2 25.6 44.8 57.6 64 89.6H473.6v153.6h57.6V409.6h435.2v96h57.6V352z" fill="#FFFFFF"></path><path d="M576 448v51.2h256l-19.2 12.8c-25.6 12.8-51.2 25.6-83.2 38.4v51.2h-256v57.6h256v76.8c0 12.8-6.4 25.6-19.2 25.6H633.6l12.8 57.6h83.2c38.4 0 57.6-19.2 57.6-57.6v-102.4H1024v-57.6h-236.8V576c51.2-25.6 96-51.2 134.4-76.8V448H576zM736 217.6l-57.6 25.6c19.2 32 44.8 64 64 102.4l51.2-25.6c-19.2-38.4-38.4-70.4-57.6-102.4zM1459.2 224v64H1600v57.6h-140.8v64H1536c51.2-38.4 96-76.8 134.4-121.6l19.2-25.6 44.8 32c-25.6 32-51.2 57.6-83.2 89.6l-25.6 19.2h115.2v57.6h-192l-25.6 12.8c-19.2 12.8-38.4 25.6-64 32l-19.2 6.4h217.6v294.4h-64v-12.8h-256v25.6h-64V588.8l-102.4 38.4-25.6-57.6c89.6-19.2 172.8-51.2 249.6-89.6l32-12.8h-268.8v-64h230.4v-57.6H1216v-57.6h172.8v-64h70.4z m147.2 454.4h-256v57.6h256v-57.6z m0-102.4h-256v57.6h256V576z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_103" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#81E2ED"></path><path d="M608 499.2c12.8 25.6 32 51.2 51.2 83.2l38.4-51.2c-25.6-32-57.6-64-83.2-96v-32h70.4v-57.6H608V224h-64v121.6H460.8v57.6h83.2C524.8 473.6 492.8 544 448 601.6l25.6 64c32-44.8 57.6-102.4 70.4-160v300.8h64V499.2z" fill="#FFFFFF"></path><path d="M972.8 243.2v38.4c-12.8 51.2-25.6 102.4-32 140.8h76.8v32c-12.8 83.2-44.8 160-83.2 217.6 32 32 70.4 64 115.2 89.6l-44.8 51.2c-38.4-32-76.8-57.6-108.8-96-38.4 38.4-83.2 70.4-134.4 96l-38.4-57.6c51.2-25.6 96-51.2 128-89.6-32-44.8-57.6-89.6-70.4-140.8-19.2 121.6-57.6 217.6-108.8 281.6l-51.2-38.4c70.4-83.2 108.8-224 108.8-409.6v-57.6h-64v-57.6h307.2z m-64 57.6h-121.6v89.6c12.8 89.6 51.2 166.4 102.4 236.8 32-44.8 51.2-96 64-147.2h-89.6c12.8-38.4 25.6-83.2 32-134.4l12.8-44.8zM1644.8 608v204.8h-57.6v-25.6h-256v25.6h-57.6V608h371.2z m-57.6 51.2h-256v76.8h256v-76.8z" fill="#FFFFFF"></path><path d="M1363.2 326.4l57.6 12.8c-6.4 12.8-12.8 25.6-25.6 32h230.4v51.2c-25.6 32-57.6 64-102.4 89.6 64 25.6 134.4 38.4 217.6 38.4l-12.8 57.6c-102.4-6.4-192-25.6-268.8-64-76.8 32-166.4 57.6-281.6 76.8l-25.6-57.6c96-12.8 179.2-32 243.2-57.6-25.6-12.8-51.2-32-70.4-51.2l-76.8 57.6-38.4-44.8c57.6-38.4 108.8-83.2 153.6-140.8z m185.6 96h-185.6c32 25.6 57.6 44.8 96 57.6 38.4-12.8 70.4-32 89.6-57.6z" fill="#FFFFFF"></path><path d="M1715.2 262.4v128h-64V320h-409.6v76.8h-64v-128H1408l-19.2-38.4 70.4-12.8c6.4 12.8 12.8 32 19.2 44.8h236.8z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_105" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#72D6FF"></path><path d="M460.8 384v57.6h236.8c-32 147.2-115.2 256-249.6 320l38.4 51.2c128-70.4 217.6-172.8 256-320 51.2 134.4 134.4 243.2 256 320l38.4-51.2c-128-76.8-211.2-179.2-256-320H1024V384h-256c6.4-38.4 6.4-76.8 6.4-121.6v-38.4h-64v57.6c0 38.4 0 70.4-6.4 108.8H460.8zM1216 480v332.8h64V384c25.6-44.8 44.8-89.6 57.6-140.8l-57.6-25.6c-25.6 96-70.4 185.6-128 262.4l19.2 64c12.8-25.6 32-44.8 44.8-64zM1644.8 371.2c-12.8 44.8-25.6 83.2-44.8 115.2l51.2 19.2c19.2-32 32-70.4 44.8-115.2l-51.2-19.2zM1395.2 371.2l-51.2 19.2c12.8 32 25.6 70.4 38.4 108.8l51.2-12.8c-12.8-44.8-25.6-76.8-38.4-115.2z" fill="#FFFFFF"></path><path d="M1337.6 294.4h160V224h57.6v70.4h160v57.6h-160v70.4c0 32 0 64-6.4 89.6H1728v57.6h-160c38.4 70.4 96 134.4 179.2 185.6l-44.8 51.2c-83.2-64-140.8-134.4-179.2-211.2-32 96-102.4 166.4-198.4 211.2l-38.4-51.2c96-25.6 160-89.6 185.6-179.2h-153.6v-57.6h166.4c6.4-25.6 6.4-51.2 6.4-76.8V352h-160v-57.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_106" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#72D6FF"></path><path d="M460.8 384v57.6h236.8c-32 147.2-115.2 256-249.6 320l38.4 51.2c128-70.4 217.6-172.8 256-320 51.2 134.4 134.4 243.2 256 320l38.4-51.2c-128-76.8-211.2-179.2-256-320H1024V384h-256c6.4-38.4 6.4-76.8 6.4-121.6v-38.4h-64v57.6c0 38.4 0 70.4-6.4 108.8H460.8zM1216 480v332.8h64V384c25.6-44.8 44.8-89.6 57.6-140.8l-57.6-25.6c-25.6 96-70.4 185.6-128 262.4l19.2 64c12.8-25.6 32-44.8 44.8-64zM1644.8 371.2c-12.8 44.8-25.6 83.2-44.8 115.2l51.2 19.2c19.2-32 32-70.4 44.8-115.2l-51.2-19.2zM1395.2 371.2l-51.2 19.2c12.8 32 25.6 70.4 38.4 108.8l51.2-12.8c-12.8-44.8-25.6-76.8-38.4-115.2z" fill="#FFFFFF"></path><path d="M1337.6 294.4h160V224h57.6v70.4h160v57.6h-160v70.4c0 32 0 64-6.4 89.6H1728v57.6h-160c38.4 70.4 96 134.4 179.2 185.6l-44.8 51.2c-83.2-64-140.8-134.4-179.2-211.2-32 96-102.4 166.4-198.4 211.2l-38.4-51.2c96-25.6 160-89.6 185.6-179.2h-153.6v-57.6h166.4c6.4-25.6 6.4-51.2 6.4-76.8V352h-160v-57.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_108" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#96C7F9"></path><path d="M486.4 371.2v57.6h236.8c-32 147.2-115.2 256-249.6 320l38.4 51.2c128-70.4 217.6-179.2 256-320 51.2 134.4 134.4 243.2 256 320l38.4-51.2c-128-76.8-211.2-179.2-256-320h243.2v-57.6h-256c6.4-38.4 6.4-83.2 6.4-121.6v-44.8h-64v57.6c0 38.4 0 70.4-6.4 108.8H486.4zM1292.8 396.8c-19.2 44.8-44.8 76.8-70.4 115.2l-38.4-51.2c44.8-57.6 83.2-134.4 115.2-230.4l57.6 12.8-38.4 96h134.4V204.8h64v128H1728v64h-211.2v147.2h243.2v57.6h-243.2v192h-64v-192h-268.8v-64h268.8V396.8h-160z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_109" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#96C7F9"></path><path d="M486.4 371.2v57.6h236.8c-32 147.2-115.2 256-249.6 320l38.4 51.2c128-70.4 217.6-179.2 256-320 51.2 134.4 134.4 243.2 256 320l38.4-51.2c-128-76.8-211.2-179.2-256-320h243.2v-57.6h-256c6.4-38.4 6.4-83.2 6.4-121.6v-44.8h-64v57.6c0 38.4 0 70.4-6.4 108.8H486.4zM1292.8 396.8c-19.2 44.8-44.8 76.8-70.4 115.2l-38.4-51.2c44.8-57.6 83.2-134.4 115.2-230.4l57.6 12.8-38.4 96h134.4V204.8h64v128H1728v64h-211.2v147.2h243.2v57.6h-243.2v192h-64v-192h-268.8v-64h268.8V396.8h-160z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_119" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FF997D"></path><path d="M473.6 371.2v57.6h236.8c-32 147.2-115.2 256-249.6 320l38.4 51.2c128-70.4 217.6-172.8 256-320 51.2 134.4 134.4 243.2 256 313.6l38.4-51.2c-128-76.8-211.2-179.2-256-320h243.2v-51.2h-256c6.4-38.4 6.4-76.8 6.4-121.6v-38.4h-64v57.6c0 38.4 0 70.4-6.4 108.8H473.6zM1190.4 300.8V640h57.6V300.8z" fill="#FFFFFF"></path><path d="M1292.8 211.2v307.2c0 108.8-38.4 192-108.8 243.2l44.8 38.4c76.8-57.6 121.6-153.6 121.6-281.6V211.2h-57.6zM1388.8 230.4h358.4v57.6h-153.6v70.4H1728v313.6c0 38.4-19.2 64-51.2 64h-44.8l-12.8-57.6 38.4 6.4c12.8-6.4 19.2-12.8 19.2-25.6V416H1600v384h-57.6v-384h-76.8v320H1408V358.4h134.4V288h-153.6v-57.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_120" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FF997D"></path><path d="M473.6 371.2v57.6h236.8c-32 147.2-115.2 256-249.6 320l38.4 51.2c128-70.4 217.6-172.8 256-320 51.2 134.4 134.4 243.2 256 313.6l38.4-51.2c-128-76.8-211.2-179.2-256-320h243.2v-51.2h-256c6.4-38.4 6.4-76.8 6.4-121.6v-38.4h-64v57.6c0 38.4 0 70.4-6.4 108.8H473.6zM1190.4 300.8V640h57.6V300.8z" fill="#FFFFFF"></path><path d="M1292.8 211.2v307.2c0 108.8-38.4 192-108.8 243.2l44.8 38.4c76.8-57.6 121.6-153.6 121.6-281.6V211.2h-57.6zM1388.8 230.4h358.4v57.6h-153.6v70.4H1728v313.6c0 38.4-19.2 64-51.2 64h-44.8l-12.8-57.6 38.4 6.4c12.8-6.4 19.2-12.8 19.2-25.6V416H1600v384h-57.6v-384h-76.8v320H1408V358.4h134.4V288h-153.6v-57.6z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_111" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FFC55F"></path><path d="M460.8 403.2v64h160c-12.8 44.8-25.6 83.2-44.8 128h307.2c-32 38.4-76.8 70.4-128 102.4-32-12.8-76.8-25.6-121.6-38.4l-32 44.8c102.4 25.6 198.4 64 294.4 108.8l32-51.2c-32-12.8-64-25.6-102.4-38.4 64-44.8 108.8-89.6 134.4-128v-57.6h-294.4c12.8-25.6 19.2-44.8 25.6-70.4h345.6v-64H704l12.8-38.4c0-6.4 6.4-12.8 6.4-25.6h281.6v-57.6h-268.8c6.4-19.2 6.4-44.8 12.8-70.4h-64l-12.8 70.4H505.6v57.6h153.6l-19.2 64H460.8zM1548.8 563.2c32 83.2 76.8 160 147.2 217.6l44.8-51.2c-64-44.8-115.2-108.8-140.8-179.2 38.4-19.2 76.8-38.4 108.8-57.6l-38.4-38.4c-51.2 32-102.4 57.6-160 70.4-12.8-25.6-25.6-44.8-44.8-64l19.2-19.2c6.4-6.4 12.8-6.4 12.8-12.8h140.8v-57.6h-377.6v57.6h140.8c-12.8 6.4-25.6 12.8-44.8 19.2-51.2 19.2-108.8 38.4-166.4 51.2l38.4 51.2c76.8-25.6 134.4-44.8 179.2-64h6.4c6.4 6.4 12.8 12.8 19.2 25.6-57.6 44.8-140.8 76.8-243.2 102.4l32 51.2c102.4-32 179.2-64 236.8-108.8 6.4 12.8 12.8 25.6 12.8 38.4-70.4 57.6-166.4 102.4-294.4 134.4l32 51.2c108.8-32 204.8-76.8 268.8-128v19.2c0 38.4-6.4 57.6-12.8 70.4-6.4 12.8-32 12.8-70.4 12.8h-32l19.2 51.2h19.2c57.6 0 96-12.8 115.2-32 12.8-19.2 19.2-57.6 19.2-108.8 0-32-6.4-64-12.8-96 12.8 0 19.2-6.4 25.6-6.4z" fill="#FFFFFF"></path><path d="M1472 211.2c6.4 19.2 12.8 32 19.2 57.6h243.2v121.6h-57.6v-64h-428.8v64h-64V268.8h249.6c-6.4-19.2-12.8-32-19.2-44.8l57.6-12.8z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_112" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FFC55F"></path><path d="M460.8 403.2v64h160c-12.8 44.8-25.6 83.2-44.8 128h307.2c-32 38.4-76.8 70.4-128 102.4-32-12.8-76.8-25.6-121.6-38.4l-32 44.8c102.4 25.6 198.4 64 294.4 108.8l32-51.2c-32-12.8-64-25.6-102.4-38.4 64-44.8 108.8-89.6 134.4-128v-57.6h-294.4c12.8-25.6 19.2-44.8 25.6-70.4h345.6v-64H704l12.8-38.4c0-6.4 6.4-12.8 6.4-25.6h281.6v-57.6h-268.8c6.4-19.2 6.4-44.8 12.8-70.4h-64l-12.8 70.4H505.6v57.6h153.6l-19.2 64H460.8zM1548.8 563.2c32 83.2 76.8 160 147.2 217.6l44.8-51.2c-64-44.8-115.2-108.8-140.8-179.2 38.4-19.2 76.8-38.4 108.8-57.6l-38.4-38.4c-51.2 32-102.4 57.6-160 70.4-12.8-25.6-25.6-44.8-44.8-64l19.2-19.2c6.4-6.4 12.8-6.4 12.8-12.8h140.8v-57.6h-377.6v57.6h140.8c-12.8 6.4-25.6 12.8-44.8 19.2-51.2 19.2-108.8 38.4-166.4 51.2l38.4 51.2c76.8-25.6 134.4-44.8 179.2-64h6.4c6.4 6.4 12.8 12.8 19.2 25.6-57.6 44.8-140.8 76.8-243.2 102.4l32 51.2c102.4-32 179.2-64 236.8-108.8 6.4 12.8 12.8 25.6 12.8 38.4-70.4 57.6-166.4 102.4-294.4 134.4l32 51.2c108.8-32 204.8-76.8 268.8-128v19.2c0 38.4-6.4 57.6-12.8 70.4-6.4 12.8-32 12.8-70.4 12.8h-32l19.2 51.2h19.2c57.6 0 96-12.8 115.2-32 12.8-19.2 19.2-57.6 19.2-108.8 0-32-6.4-64-12.8-96 12.8 0 19.2-6.4 25.6-6.4z" fill="#FFFFFF"></path><path d="M1472 211.2c6.4 19.2 12.8 32 19.2 57.6h243.2v121.6h-57.6v-64h-428.8v64h-64V268.8h249.6c-6.4-19.2-12.8-32-19.2-44.8l57.6-12.8z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_113" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#FFC55F"></path><path d="M460.8 403.2v64h160c-12.8 44.8-25.6 83.2-44.8 128h307.2c-32 38.4-76.8 70.4-128 102.4-32-12.8-76.8-25.6-121.6-38.4l-32 44.8c102.4 25.6 198.4 64 294.4 108.8l32-51.2c-32-12.8-64-25.6-102.4-38.4 64-44.8 108.8-89.6 134.4-128v-57.6h-294.4c12.8-25.6 19.2-44.8 25.6-70.4h345.6v-64H704l12.8-38.4c0-6.4 6.4-12.8 6.4-25.6h281.6v-57.6h-268.8c6.4-19.2 6.4-44.8 12.8-70.4h-64l-12.8 70.4H505.6v57.6h153.6l-19.2 64H460.8zM1548.8 563.2c32 83.2 76.8 160 147.2 217.6l44.8-51.2c-64-44.8-115.2-108.8-140.8-179.2 38.4-19.2 76.8-38.4 108.8-57.6l-38.4-38.4c-51.2 32-102.4 57.6-160 70.4-12.8-25.6-25.6-44.8-44.8-64l19.2-19.2c6.4-6.4 12.8-6.4 12.8-12.8h140.8v-57.6h-377.6v57.6h140.8c-12.8 6.4-25.6 12.8-44.8 19.2-51.2 19.2-108.8 38.4-166.4 51.2l38.4 51.2c76.8-25.6 134.4-44.8 179.2-64h6.4c6.4 6.4 12.8 12.8 19.2 25.6-57.6 44.8-140.8 76.8-243.2 102.4l32 51.2c102.4-32 179.2-64 236.8-108.8 6.4 12.8 12.8 25.6 12.8 38.4-70.4 57.6-166.4 102.4-294.4 134.4l32 51.2c108.8-32 204.8-76.8 268.8-128v19.2c0 38.4-6.4 57.6-12.8 70.4-6.4 12.8-32 12.8-70.4 12.8h-32l19.2 51.2h19.2c57.6 0 96-12.8 115.2-32 12.8-19.2 19.2-57.6 19.2-108.8 0-32-6.4-64-12.8-96 12.8 0 19.2-6.4 25.6-6.4z" fill="#FFFFFF"></path><path d="M1472 211.2c6.4 19.2 12.8 32 19.2 57.6h243.2v121.6h-57.6v-64h-428.8v64h-64V268.8h249.6c-6.4-19.2-12.8-32-19.2-44.8l57.6-12.8z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_5" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#A6DEF4"></path><path d="M768 672c83.2 32 166.4 76.8 243.2 128l32-51.2c-70.4-44.8-153.6-83.2-243.2-121.6 6.4 0 6.4-6.4 12.8-12.8h224v-57.6h-198.4c12.8-38.4 19.2-83.2 19.2-128V352h-57.6v76.8c0 44.8-12.8 89.6-25.6 128H492.8v57.6h249.6l-12.8 12.8c-44.8 51.2-121.6 89.6-243.2 121.6l32 51.2c115.2-32 198.4-70.4 249.6-128z" fill="#FFFFFF"></path><path d="M582.4 435.2l-32 44.8c44.8 19.2 89.6 38.4 128 70.4l32-51.2c-38.4-25.6-83.2-44.8-128-64zM646.4 345.6l-32 44.8c44.8 19.2 83.2 38.4 128 70.4l32-51.2c-38.4-25.6-83.2-44.8-128-64z" fill="#FFFFFF"></path><path d="M1030.4 262.4h-230.4c-6.4-19.2-12.8-38.4-25.6-57.6l-64 12.8c6.4 12.8 12.8 32 19.2 51.2H492.8v128h57.6V320h416v76.8h57.6V262.4zM1555.2 499.2c-96 57.6-211.2 108.8-345.6 147.2l25.6 57.6c134.4-44.8 243.2-96 332.8-147.2l-12.8-57.6zM1312 352l-44.8 44.8c57.6 44.8 96 76.8 128 115.2l38.4-44.8c-25.6-38.4-70.4-70.4-121.6-115.2z" fill="#FFFFFF"></path><path d="M1491.2 793.6l-19.2-57.6h108.8c19.2 0 32-6.4 38.4-25.6 6.4-12.8 12.8-51.2 12.8-102.4V524.8 294.4h-409.6v-51.2h480l-6.4 166.4c0 115.2-6.4 192-6.4 224v6.4c0 57.6-12.8 102.4-25.6 121.6-12.8 19.2-38.4 32-70.4 32h-102.4z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_1" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#A69FF4"></path><path d="M691.2 249.6v57.6h307.2v-57.6zM665.6 428.8v57.6h115.2c-25.6 83.2-44.8 147.2-70.4 198.4-6.4 12.8-25.6 19.2-44.8 25.6l12.8 57.6 96-12.8c83.2-12.8 147.2-19.2 192-32 6.4 19.2 12.8 44.8 19.2 64l57.6-12.8c-25.6-89.6-57.6-172.8-96-243.2l-57.6 19.2 57.6 115.2c-57.6 12.8-115.2 25.6-172.8 32 25.6-51.2 44.8-121.6 70.4-211.2h192v-57.6h-371.2zM454.4 371.2v57.6h70.4v217.6l-76.8 19.2 12.8 64c76.8-19.2 140.8-44.8 204.8-76.8v-64c-25.6 12.8-57.6 25.6-76.8 38.4v-192h64v-64h-64V211.2h-64v160H454.4zM1420.8 371.2h-230.4v-57.6h230.4c-12.8-32-25.6-64-38.4-89.6l64-19.2c12.8 38.4 25.6 70.4 38.4 102.4h236.8v57.6h-230.4v134.4h204.8v57.6h-204.8v160h256v57.6h-569.6v-57.6h256V563.2h-198.4v-57.6h198.4V371.2z" fill="#FFFFFF"></path></symbol><symbol id="icon-group_0" viewBox="0 0 2176 1024"><path d="M512 64h1152c249.6 0 448 198.4 448 448s-198.4 448-448 448H512c-249.6 0-448-198.4-448-448s198.4-448 448-448z" fill="#AAE3C5"></path><path d="M870.4 358.4h172.8v-57.6h-153.6l19.2-76.8-57.6-12.8c-12.8 83.2-38.4 153.6-76.8 198.4l38.4 44.8c19.2-25.6 38.4-57.6 57.6-96zM499.2 224l-44.8 38.4c38.4 32 64 57.6 83.2 83.2l44.8-44.8c-19.2-25.6-51.2-51.2-83.2-76.8zM492.8 384l-38.4 38.4c38.4 32 70.4 64 89.6 89.6l44.8-44.8c-25.6-25.6-57.6-51.2-96-83.2zM524.8 556.8C505.6 633.6 480 704 448 774.4l57.6 25.6c25.6-64 51.2-140.8 76.8-217.6l-57.6-25.6z" fill="#FFFFFF"></path><path d="M633.6 371.2v32c0 166.4-25.6 281.6-76.8 358.4l44.8 38.4c44.8-70.4 76.8-166.4 83.2-294.4h44.8v102.4c0 57.6-6.4 89.6-6.4 102.4 0 19.2-6.4 32-19.2 32h-51.2l12.8 51.2h44.8c38.4 0 57.6-19.2 64-57.6v-12.8c6.4-44.8 6.4-134.4 6.4-275.2h-89.6V371.2h108.8v-57.6h-70.4c-12.8-38.4-19.2-70.4-25.6-102.4l-64 12.8c6.4 25.6 19.2 57.6 25.6 89.6H582.4v57.6h51.2zM844.8 416v51.2h108.8l-12.8 19.2c-12.8 12.8-25.6 32-38.4 44.8v38.4h-89.6v51.2h89.6V704c0 25.6-6.4 32-12.8 32h-51.2l12.8 57.6h57.6c32 6.4 51.2-19.2 51.2-64V627.2h83.2v-57.6H960v-32c25.6-19.2 44.8-44.8 64-70.4v-51.2h-179.2zM1644.8 601.6v204.8h-57.6v-25.6h-256v25.6h-57.6V601.6h371.2z m-57.6 51.2h-256v76.8h256v-76.8z" fill="#FFFFFF"></path><path d="M1363.2 320l57.6 12.8c-6.4 12.8-12.8 25.6-25.6 32h230.4v51.2c-25.6 32-57.6 64-102.4 89.6 64 25.6 134.4 38.4 217.6 38.4l-12.8 57.6c-102.4-6.4-192-25.6-268.8-64-76.8 32-166.4 57.6-281.6 76.8l-25.6-57.6c96-12.8 179.2-32 243.2-57.6-25.6-19.2-51.2-32-76.8-57.6l-76.8 57.6-38.4-44.8c64-32 115.2-76.8 160-134.4z m192 96h-185.6c32 25.6 57.6 44.8 96 57.6 32-12.8 64-32 89.6-57.6z" fill="#FFFFFF"></path><path d="M1715.2 256v128h-64V313.6h-409.6v76.8h-64v-128H1408l-19.2-38.4 64-12.8c6.4 12.8 12.8 32 19.2 44.8h243.2z" fill="#FFFFFF"></path></symbol></svg>
	
<style>
	.top-banner {
		height: 100px;
		overflow: hidden;
		display: none;
		background:#0d1e28 url('');
		background-repeat: no-repeat;
		background-position: center center;
		background-size: cover;
	}
	@media only screen and (max-width: 780px) {
		.top-banner-section {
			display: none;
		}
	}
</style>
<!-- 顶部广告条 -->
<!-- 顶部广告条结束 -->	
	<style>
.btn-default {
    color: #333;
    background-color: #fff;
    border-color: #ccc;
}
#header {
    /* border-top: 3px solid #0099ee; */
    box-shadow: 0px 2px 10px 0px rgba(0, 0, 0, 0.1), 0 1px rgba(0, 0, 0, 0.1);
    background: #fafafa;
}

#header .container {
    height: 64px;
    line-height: 64px;
}

#header .navbar {
    padding: 0;
}

#header nav li.nav-item {
    line-height: 34px;
}

#header nav a.nav-link {
    font-size: 16px;
    color: #757575;
    font-weight: 500;
    text-decoration: none;
}
#header .login_btn,  #header .reg_btn{
	font-size: 13px;
	padding: 4px 16px;
	
	font-weight: 500;
	color: #0099ee;
	text-decoration: none;
	border: 1px solid #0099ee;
}
#header .reg_btn {
	color: #fff;
	background: #0099ee;
}
#header nav a.nav-link,
#header nav .dropdown {
    padding: 0 1rem;
}

#header nav a.nav-link:hover {
    background-color: #F3F3F3;
}

#header nav li.nav-item.active a {
    color: #0099ee;
    font-weight: 600;
}

#header nav .home_seach_form {
    border: 1px solid #ccc;
    border-radius: 4px;
}

#header nav .dropdown a.dropdown-item:hover {
    color: #0099ee;
    text-decoration: none;
    background-color: #f3f3f3;
}

.dropup .dropdown-toggle::after {
    display: none !important;
}

.bottom-nav {
    /* display: none; */
    background-color: #fafafa;
    box-shadow: 0 -1px rgba(0,0,0,0.1), 0 -2px 10px rgba(0,0,0,0.1);
}
.bottom-nav .opts-group {
    position: relative;
    display: inline-block;
    /* padding-top: 6px; */
    line-height: 20px;
    color: #9e9e9e;
    cursor: pointer;
}
.bottom-nav .opts-group.active {
    color: #0099ee;
}

@media only screen and (min-width: 992px) {
    .bottom-nav, .header_seach_but {
        display: none !important;
    }
    
}
@media only screen and (max-width: 992px) {
    .nav-logo {
        margin-right: 0 !important;
    }

	.nav_user_item {
		width: 96px;
	}
	.nav_user_item .login_btn,  .nav_user_item .reg_btn {
		padding: 3px 6px !important;
	}
}

.seach_li {
    margin-left: 40px;
}

@media only screen and (max-width: 1200px) {
    .seach_li {
        margin-left: 0px !important;
        width: 100%;
        max-width: 120px !important;
    }
}
.dropdown i.angle-down {
    display: inline-block;
    transition: transform linear .2s, -webkit-transform linear .2s, -o-transform linear .2s;
    
}
.dropdown.active i.angle-down {
    transform: rotate(180deg);
}

</style>

<header id="header">
    <div class="container" style="padding-right: 15px;padding-left: 15px;">
        <nav class="navbar navbar-expand-lg navbar-light">
            <a href="https://bbs.pediy.com/search.htm" class="header_seach_but" style="display:block; width: 96px;"><i class="icon-search" aria-hidden="true"></i></a>
            <a class="navbar-brand nav-logo" href="https://bbs.pediy.com/" style="line-height: 0px;" title="看雪论坛-安全社区|安全招聘|bbs.pediy.com">
                <img src="./AFL二三事 -- 源码分析 1/kanxuelogo.png" height="25" alt="看雪论坛-安全社区|安全招聘|bbs.pediy.com">
            </a>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="https://www.kanxue.com/">首页</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://www.kanxue.com/course.htm">课程</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://www.kanxue.com/question-list.htm">问答</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://ctf.pediy.com/">CTF</a>
                    </li>
                    <!-- <li class="nav-item  position-relative">
                        <div class="dropdown">
                            <a class="dropdown-toggle nav-link px-0" href="#" role="button" id="ctfdropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                CTF
                            </a>
                            <img class="position-absolute" style="width: 27px; top: -5px; right: -7px; z-index: 3;" src="//passport.kanxue.com/pc/view/img/hot.png" alt="">
                            <div class="dropdown-menu " aria-labelledby="ctfdropdownMenuLink">
                                <a class="dropdown-item" style="color: #212529; font-weight: 400;" href="//ctf.pediy.com">CTF竞赛</a>
                                <a class="dropdown-item" style="color: #212529; font-weight: 400;" href="//ctf.pediy.com/itembank.htm">题库</a>
                                
                            </div>
                        </div>
                    </li> -->
                    <li class="nav-item active">
                        <a class="nav-link" href="https://bbs.pediy.com/">论坛</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://job.kanxue.com/">招聘</a>
                    </li>
                    <li class="nav-item position-relative">
                            <a class="nav-link" href="https://www.kanxue.com/conference.htm">看雪峰会</a>
                            <!-- <img class="position-absolute" style="width: 27px; top: -5px; right: -7px; z-index: 3;" src="//passport.kanxue.com/pc/view/img/hot.png" alt=""> -->
                    </li>
                    <li class="nav-item">
                        <div class="dropdown">
                            <a class="dropdown-toggle nav-link px-0" href="https://bbs.pediy.com/thread-269534.htm#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                发现
                            </a>
                            <div class="dropdown-menu " aria-labelledby="dropdownMenuLink">
                                <!-- <a class="dropdown-item" href="//ctf.pediy.com">CTF</a> -->
                                <a class="dropdown-item" href="https://qifu.kanxue.com/">企服</a>
                                <a class="dropdown-item" href="https://ce.kanxue.com/">众测</a>
                                <a class="dropdown-item" href="https://www.kanxue.com/rank.htm">排行榜</a>
                                <a class="dropdown-item" href="https://www.kanxue.com/chm.htm">知识库</a>
                                <a class="dropdown-item" href="https://www.kanxue.com/tool.htm">工具下载</a>
                                <!-- <a class="dropdown-item" href="//www.kanxue.com/conference.htm">看雪峰会</a> -->
                                <a class="dropdown-item" href="https://www.kanxue.com/mrt.htm">看雪20年</a>
                                <a class="dropdown-item" href="https://www.kanxue.com/shop.htm">看雪商城</a>
                                <a class="dropdown-item " href="https://www.kanxue.com/certificate.htm">证书查询</a>
                            </div>
                        </div>
                    </li>
                    <li class="seach_li">
                        <form class="form-inline my-2 my-lg-0 mr-auto" action="https://bbs.pediy.com/search.htm" id="search_form" style="margin-right: 20px; max-width: 150px;">
                            <div class="input-group home_seach_form">
                                <input type="text" class="form-control border-0" name="keyword" placeholder="论坛关键词 回车搜索">
                                <div class="input-group-append">
                                    <button class="btn px-2" type="submit" id="button-addon2">
                                        <i class="icon-search"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </li>
                </ul>
                
            </div>
            <div class="text-right nav_user_item" style="white-space: nowrap;">
                                    
                <a class="login_btn" href="https://passport.kanxue.com/user-login.htm">登录</a>
                <a class="reg_btn ml-2" href="https://passport.kanxue.com/user-mobile-1.htm">注册</a>
                            </div>
            
        </nav>
    </div>
</header>
<div class="position-fixed w-100 header_fiexd bottom-nav" style="width: 100%; height: 50px; bottom: 0; z-index: 2; background: #fafafa;">
    <div class="row mx-0 text-center align-items-center" style="height: 50px;">
        <a href="https://www.kanxue.com/" class="d-inline-blok col px-0 header_nav_a opts-group " style="max-width: 20%;">
            <div>
                <i class="icon-home"></i>
            </div>
            <div>
                首页
            </div>
        </a>
        <a href="https://bbs.pediy.com/" class="d-inline-blok col px-0 header_nav_a opts-group active" style="max-width: 20%;">
            <div>
                <i class="icon-comments"></i>
            </div>
            <div>
                论坛
            </div>
        </a>
        
        <a href="https://www.kanxue.com/course.htm" class="d-inline-blok col px-0 header_nav_a opts-group" style="max-width: 20%;">
            <div>
                <i class="icon-book"></i>
            </div>
            <div>
                课程
            </div>
        </a>
        <a href="https://job.kanxue.com/" class="d-inline-blok col px-0 header_nav_a opts-group" style="max-width: 20%;">
            <div>
                <i class="icon-clipboard"></i>
            </div>
            <div>
                招聘
            </div>
        </a>
        
        <div class=" dropup d-inline-blok col px-0" style="max-width: 20%;">
            <a class="dropdown-toggle d-inline-block header_nav_a opts-group" href="https://bbs.pediy.com/thread-269534.htm#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <div>

                    <i class="icon-list"></i>
                </div>
                <div>
                    发现
                </div>
            </a>
            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                <a class="dropdown-item" href="https://www.kanxue.com/question-list.htm">问答</a>
                <a class="dropdown-item" href="https://qifu.kanxue.com/">企服</a>
                <a class="dropdown-item" href="https://zhuanlan.kanxue.com/">专栏</a>
                <a class="dropdown-item" href="https://ctf.pediy.com/">CTF</a>
                <!-- <a class="dropdown-item" href="//ctf.pediy.com/itembank.htm">题库</a> -->
                <a class="dropdown-item" href="https://ce.kanxue.com/">众测</a>
                <a class="dropdown-item" href="https://www.kanxue.com/rank.htm">排行榜</a>
                <a class="dropdown-item" href="https://www.kanxue.com/chm.htm">知识库</a>
                <a class="dropdown-item" href="https://www.kanxue.com/tool.htm">工具下载</a>
                <a class="dropdown-item" href="https://www.kanxue.com/conference.htm">看雪峰会</a>
                <a class="dropdown-item" href="https://www.kanxue.com/mrt.htm">看雪20年</a>
                <a class="dropdown-item" href="https://www.kanxue.com/shop.htm">看雪商城</a>
                <a class="dropdown-item" href="https://www.kanxue.com/certificate.htm">证书查询</a>
            </div>
        </div>
       
    </div>
</div>


		<main id="body">
	<div class="container">
		





	
		

	





<link rel="stylesheet" type="text/css" href="./AFL二三事 -- 源码分析 1/syntax.css">

<style>

	.table thead th {

		vertical-align: bottom;

		border-bottom: unset !important;

	}

	.postlist tr.post:first-child td {

		border-top: unset !important;

	}

	.postlist tr.post, .postlist tr.post:last-child td {

		border-bottom: unset !important;

	}

	.qqFace img:hover {

		border-color: #0066cc !important;

	}

	.btn-0099ee {

		background-color: #0099ee;

		color: #fff!important;

	}

	.btn-followed {

		background-color: #c0c5cc;

		color: #fff!important;

	}

	.thread-poptip-box {

		display: none;

		top: 0%;

		left: 100%;

		z-index: 1;

		width: 380px; 

		border-radius: 5px;

		box-shadow: 0 4px 12px 0 rgba(37,77,157,.1)!important; 

		color: #494b4d!important;

		transition: all 500ms;

	}

	.thread-poptip-box1 {

		display: none;

		top: 100%;

		right: 0;

		z-index: 1;

		width: 380px; 

		border-radius: 5px;

		box-shadow: 0 4px 12px 0 rgba(37,77,157,.1)!important; 

		color: #494b4d!important;

		transition: all 500ms;

	}

	@media screen and (min-width: 992px) {

		.post_online_time {

			cursor: pointer;

		}

		img.huoyue_num {

			transition: all 200ms ease;

		}

		img.huoyue_num:hover {

			transform: scale(1.5);

		}

	}

	svg.icon {

		width: 3rem;

		height: 1.3rem;

		vertical-align: middle;

		fill: currentColor;

		overflow: hidden;

	}

	.breadcrumb {

		background-color: unset !important;

		border: unset !important;

		box-shadow: unset !important;

	}

	.breadcrumb:hover {

		background-color: unset !important;

	}

	.nav .active {

		font-weight: 800;

		color: #0099ee !important;

	}

	

	.card > .card-header {

		color: #161616;

		text-shadow: unset !important;

		padding: 0.6rem 1rem;

		border-bottom: 1px solid #eeeeee;

		background: #fff !important;

	}	

	div.btn-group.mod-button {

		flex-wrap: wrap;

	}

	div.btn-group.mod-button button {

		margin-top: 0.5rem;

	}



	.collection_thumb_left i { font-size: 18px;}

</style>

<style>

	/* 收藏点赞区样式 */

	.card_collection { border-radius: 5px; width: 70px; vertical-align: middle; display: inline-block;}

	.card_collection div { margin-bottom: 0px;font-size: 14px;}

	.card_collection div>a>i {font-size: 22px;}

	.card_collection div a { text-decoration: none; }

	.alipay-bg { width: 60px;height: 20px;display: inline-block;vertical-align: middle;background: url(view/img/reward_alipay.png) 0 0 no-repeat;}

	.color4A4A4A {

		color: #C4C4C4;

	}

	.bbsshare_modal {position: absolute;z-index: 2; top: 0; right: -155px;}

	.likes_box_hide {display: none;}

	.likes_box_show {display: inline;}



	.position-sticky {

		position: -webkit-sticky; 

		position: sticky; 

	}

	

	/* 右侧目录样式 */





	.is-collapsible {

		max-height: 1000px;

		overflow: hidden;

		transition: all 300ms ease-in-out

	}



	.is-collapsed {

		max-height: 0

	}



	.is-position-fixed {

		position: fixed !important;

		top: 0

	}



	.is-active-link {

		font-weight: 700

	}

	.js-toc {

		max-height: 21rem;

		overflow: auto;

	}

	.js-toc ol {

		margin:0;

		padding-left: 1rem;

		list-style-type: none;

	}

	.js-toc a {

		width: 100%;

		margin: 0.2rem 0 0;

		white-space: nowrap;

		overflow: hidden;

		text-overflow: ellipsis;

		display: inline-block;

		

	}

	.js-toc li.is-active-li a.is-active-link {

		color: #0099ee;

		font-weight: bolder;

	}

	.show_tocbot {

		display: none;

	}

</style>



<ol class="breadcrumb mb-3">

	<li class="breadcrumb-item"><a href="https://bbs.pediy.com/" aria-label="首页"><i class="icon-home"></i> 看雪论坛</a></li>

	<li class="breadcrumb-item"><a href="https://bbs.pediy.com/forum-150.htm">二进制漏洞</a></li>

	

	<div class="media-body text-right">

	
		<a href="https://bbs.pediy.com/thread-create-150.htm" role="button" class="btn btn-sm btn-primary" style="float: right; border: 1px solid #0099ee;">发新帖</a>

	
	</div>

</ol>

<div class="row mx-0">

	<div class="col-12 col-md-9 px-0">	

		<div class="position-fixed text-center collection_thumb_left" style="z-index: 2; width: 70px; margin-left: -70px;">

			<div>

				
				<a href="javascript:void(0)" class="favorite d-inline-block bg-white" title="收藏" style="text-decoration: none; border: 1px solid #DDDDDD; border-radius: 100%; width: 40px; height: 40px; line-height: 40px;">

				<i class="icon-star-o color4A4A4A"></i>

				
				</a>

				<div>

					<span class="likes_box likes_box_show" style="font-size: 13px;color: #0099ee;"><span class="likes">25</span></span>

				</div>

			</div>

			<div class="mt-3">

					
					<a href="javascript:void(0)" class="d-inline-block bg-white thumb" style="text-decoration: none; border: 1px solid #DDDDDD; border-radius: 100%; width: 40px; height: 40px; line-height: 40px;">

					<i class="icon-thumbs-o-up color4A4A4A"></i>

					
					</a>

					<div>

						<span class="thumbs_num_box" style="font-size: 13px;color: #0099ee;"><span class="thumbs_num">7</span></span>

					</div>

			</div>

			<div class="mt-3">

				<a href="javascript:void(0)" id="exampleModalLabel" class="d-inline-block bg-white" style="text-decoration: none; border: 1px solid #DDDDDD; border-radius: 100%; width: 40px; height: 40px; line-height: 40px;" data-toggle="modal" data-target=".reward">

					<i class="icon-rmb color4A4A4A"></i>

				</a>

			</div>

		</div>

		

		<div class="card message_card">

			<div class="mb-0">

				<div class="card-body">

					<div class="d-none d-lg-block">

						<dl class="row">

							<dd class="vtop">

								<dl class="row small" style="height: 34px; line-height: 34px;">

									<dt style="padding: 0px;">

										

										<div class="break-all m-0">

																	
											

											<span style="font-size: 1.4rem;">AFL二三事 -- 源码分析 1</span>

											
												

											
																		
									<i class="icon-digest-2" aria-hidden="true" title="优秀"></i>
							

										</div>

										

									</dt>

									

								</dl>

								<dl class="row small mt-1">

									<dt style="padding: 0px;">

										

										<div>

											<span class="date text-grey ml-1"><i class="icon-clock-o" aria-hidden="true"></i> 2021-9-27 16:48</span>

											<span class="text-grey ml-3 hidden-md-down"><i class="icon-eye" aria-hidden="true"></i> 28430</span>

											
											<!-- <span class="post_online_time" style="vertical-align: text-bottom;" data-online_time="2942945" data-desc="" onmouseenter="show_online_level(event)"> </span> -->

										</div>

										

									</dt>

									<dd class="text-right">

										
										

										
										

										
										

										
									</dd>

								</dl>

								

								
							</dd>

						</dl>

					</div>

					<!-- choadi 手机端适配 开始-->

					<div class="px-3 pt-3 d-block d-lg-none">

						

						<h3 class="break-all subject m-0">

													
							AFL二三事 -- 源码分析 1
							
							
																		
									<i class="icon-digest-2" aria-hidden="true" title="优秀"></i>
							

						</h3>

						

						<div class="row mx-0 mt-2">

							<div class="col-8 px-0">

								<a href="https://bbs.pediy.com/user-home-779730.htm" style="text-decoration: none;" aria-hidden="true" tabindex="-1">

									<img style="width: 2rem; height: 2rem; border-radius: 6rem;" src="./AFL二三事 -- 源码分析 1/779730.png">

								</a>

								

								<a class="small" href="https://bbs.pediy.com/user-home-779730.htm" style="text-decoration: none;">有毒</a>					

								<img class="huoyue_num" src="./AFL二三事 -- 源码分析 1/12.png" width="22" alt="活跃值">		

								
									<div class="d-inline-block" style="font-size: 12px;">

										<span class="icon-diamond text-danger" title="精华数"></span>

										<span class="font-weight-bold text-danger"> 10</span>

									</div>

								
							</div>

							<div class="col px-0 text-right">

									
								

									
									

									
									

									
							</div>

							<!-- <img style="" src="//bbs.pediy.com/view/img/stars04.gif" alt="">  -->

							

							

						</div>

						<div class="small row mx-0 mt-2">

							<div class="col px-0">

								<svg class="icon" aria-hidden="true">

									<use xlink:href="#icon-group_4"></use>

								</svg>

								<span class="post_online_time" style="vertical-align: text-bottom;" data-online_time="2942945" data-desc="817 小时，  18 级" onmouseenter="show_online_level(event)"><img src="./AFL二三事 -- 源码分析 1/sun.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/star.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/star.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"></span>

							</div>

							<div class="col px-0 text-right">

								
								

								

								
							</div>

						</div>

						<div class="small row mx-0 mt-2">

							<div class="col px-0"><span class="date text-grey">2021-9-27 16:48</span></div>

							<div class="col px-0 text-right"><span class="text-grey hidden-md-down"><i class="icon-eye" aria-hidden="true"></i> 28430</span></div>

						</div>

						

						
					</div>

					<!-- choadi 手机端适配 结束-->



					

					<hr aria-hidden="true">

					

					<div class="message " isfirst="1">

					
					

						

						<h1 id="msg_header_h1_0"><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>AFL二三事 —— 源码分析 1</h1><p></p><fieldset class="fieldset toc"><legend>目录</legend><div class="tocs"><ul class="toc-tree" style="padding-left:0;"><li class="toc-item toc-level-1"><a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">AFL二三事 —— 源码分析 1</span></a></li><li class="toc-item toc-level-2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm#%E5%89%8D%E8%A8%80"><span class="toc-number"></span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm#%E5%AE%8F%E8%A7%82"><span class="toc-number"></span> <span class="toc-text">宏观</span></a></li><li class="toc-item toc-level-2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">一、AFL 的 gcc —— afl-gcc.c</span></a></li><li class="toc-item toc-level-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">2. 源码</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">1. 关键变量</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">2. main函数</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">3. find_as 函数</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">4. edit_params 函数</span></a></li><li class="toc-item toc-level-2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">二、AFL 的源码插桩 —— afl-as.c</span></a></li><li class="toc-item toc-level-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">2. 源码</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">1. 关键变量</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">2. main函数</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">3. add_instrumentation函数</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">4. edit_params函数</span></a></li><li class="toc-item toc-level-3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">3. instrumentation trampoline 和 main_payload</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">1. trampoline_fmt_64/32</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">2. __afl_maybe_log</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">3. __afl_setup</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">4. __afl_setup_first</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">5. __afl_forkserver</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">6. __afl_fork_wait_loop</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">7. __afl_fork_resume</span></a></li><li class="toc-item toc-level-4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm"><span class="toc-number"></span> <span class="toc-text">8. __afl_store</span></a></li><li class="toc-item toc-level-2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm#%E4%B8%89%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number"></span> <span class="toc-text">三、总结</span></a></li><li class="toc-item toc-level-2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="toc-link" href="https://bbs.pediy.com/thread-269534.htm#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%EF%BC%9A"><span class="toc-number"></span> <span class="toc-text">参考文献：</span></a></li></ul></div></fieldset><p></p>
<h2 id="msg_header_h2_0"><a name="前言" class="anchor" href="https://bbs.pediy.com/thread-269534.htm#%E5%89%8D%E8%A8%80"><span class="header-link"></span></a>前言</h2><p>深入分析AFL源码，对理解AFL的设计理念和其中用到的技巧有着巨大的帮助，对于后期进行定制化Fuzzer开发也具有深刻的指导意义。所以，阅读AFL源码是学习AFL必不可少的一个关键步骤。</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>考虑到AFL源码规模，源码分析部分将分为几期进行。</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><strong>当别人都要快的时候，你要慢下来。</strong></p>
<h2 id="msg_header_h2_1"><a name="宏观" class="anchor" href="https://bbs.pediy.com/thread-269534.htm#%E5%AE%8F%E8%A7%82"><span class="header-link"></span></a>宏观</h2><p>首先在宏观上看一下AFL的源码结构：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_8QXGCAXH83KUXSV.jpg" style="max-width: 100%; cursor: pointer;" alt="MetricsTreemap-AFL" class="div_message_boxShadow"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>主要的代码在 <code>afl-fuzz.c</code> 文件中，然后是几个独立功能的实现代码，<code>llvm_mode</code> 和 <code>qemu_mode</code> 的代码量大致相当，所以分析的重点应该还是在AFL的根目录下的几个核心功能的实现上，尤其是 <code>afl-fuzz.c</code>，属于核心中的重点。</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>各个模块的主要功能和作用：</p>
<ul>
<li><p><strong>插桩模块</strong></p>
<ol>
<li><code>afl-as.h, afl-as.c, afl-gcc.c</code>：一般插桩模式，针对源码插桩，编译器可以使用gcc， clang；</li>
<li><code>llvm_mode</code>：llvm 插桩模式，针对源码插桩，编译器使用clang；</li>
<li><code>qemu_mode</code>：qemu 插桩模式，针对二进制文件插桩。</li>
</ol>
</li>
<li><p>fuzzer 模块</p>
<p><code>afl-fuzz.c</code>：fuzzer 实现的核心代码，AFL 的主体。</p>
</li>
<li><p>其他辅助模块</p>
<ol>
<li><code>afl-analyze</code>：对测试用例进行分析，通过分析给定的用例，确定是否可以发现用例中有意义的字段；</li>
<li><code>afl-plot</code>：生成测试任务的状态图；</li>
<li><code>afl-tmin</code>：对测试用例进行最小化；</li>
<li><code>afl-cmin</code>：对语料库进行精简操作；</li>
<li><code>afl-showmap</code>：对单个测试用例进行执行路径跟踪；</li>
<li><code>afl-whatsup</code>：各并行例程fuzzing结果统计；</li>
<li><code>afl-gotcpu</code>：查看当前CPU状态。</li>
</ol>
</li>
<li><p>部分头文件说明</p>
<ol>
<li><code>alloc-inl.h</code>：定义带检测功能的内存分配和释放操作；</li>
<li><code>config.h</code>：定义配置信息；</li>
<li><code>debug.h</code>：与提示信息相关的宏定义；</li>
<li><code>hash.h</code>：哈希函数的实现定义；</li>
<li><code>types.h</code>：部分类型及宏的定义。</li>
</ol>
</li>
</ul>
<h2 id="msg_header_h2_2"><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>一、AFL 的 gcc —— afl-gcc.c</h2><h3 id="msg_header_h3_0"><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>1. 概述</h3><p><code>afl-gcc</code> 是GCC 或 clang 的一个wrapper（封装），常规的使用方法是在调用 <code>./configure</code> 时通过 <code>CC</code> 将路径传递给 <code>afl-gcc</code> 或 <code>afl-clang</code>。（对于 C++ 代码，使用 <code>CXX</code> 并将其指向 <code>afl-g++</code> / <code>afl-clang++</code>。）<code>afl-clang</code>, <code>afl-clang++</code>， <code>afl-g++</code> 均为指向 <code>afl-gcc</code> 的一个符号链接。</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><code>afl-gcc</code> 的主要作用是实现对于关键节点的代码插桩，属于汇编级，从而记录程序执行路径之类的关键信息，对程序的运行情况进行反馈。</p>
<h3 id="msg_header_h3_1"><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>2. 源码</h3><h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>1. 关键变量</h4><p>在开始函数代码分析前，首先要明确几个关键变量：</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">static u8</code><code class="python keyword">*</code>&nbsp; <code class="python plain">as_path;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Path to the AFL </code><code class="python string">'as'</code> <code class="python plain">wrapper，AFL的as的路径&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number2 index1 alt1"><code class="python plain">static u8</code><code class="python keyword">*</code><code class="python keyword">*</code> <code class="python plain">cc_params;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Parameters passed to the real CC，CC实际使用的编译器参数 </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number3 index2 alt2"><code class="python plain">static u32&nbsp; cc_par_cnt </code><code class="python keyword">=</code> <code class="python value">1</code><code class="python plain">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Param count, including argv0 ，参数计数 </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number4 index3 alt1"><code class="python plain">static u8&nbsp;&nbsp; be_quiet,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Quiet mode，静默模式&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">clang_mode;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Invoked as afl</code><code class="python keyword">-</code><code class="python plain">clang</code><code class="python keyword">*</code><code class="python plain">? ，是否使用afl</code><code class="python keyword">-</code><code class="python plain">clang</code><code class="python keyword">*</code><code class="python plain">模式 </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="python comments"># 数据类型说明</code></div><div class="line number8 index7 alt1"><code class="python comments"># typedef uint8_t&nbsp; u8;</code></div><div class="line number9 index8 alt2"><code class="python comments"># typedef uint16_t u16;</code></div><div class="line number10 index9 alt1"><code class="python comments"># typedef uint32_t u32;</code></div></div></td></tr></tbody></table>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>2. main函数</h4><p>main 函数全部逻辑如下：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_WK6NXBU63ESFT5B.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210825105002088" class="div_message_boxShadow"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>其中主要有如下三个函数的调用：</p>
<ul>
<li><code>find_as(argv[0])</code> ：查找使用的汇编器</li>
<li><code>edit_params(argc, argv)</code>：处理传入的编译参数，将确定好的参数放入 <code>cc_params[]</code> 数组</li>
<li>调用 <code>execvp(cc_params[0], (cahr**)cc_params)</code> 执行 <code>afl-gcc</code></li>
</ul>
<p><img src="./AFL二三事 -- 源码分析 1/779730_KMXHBXPMNTPCUEX.jpg" style="max-width: 100%; cursor: pointer;" alt="20210825115404" class="div_message_boxShadow"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>这里添加了部分代码打印出传入的参数 arg[0] - arg[7] ，其中一部分是我们指定的参数，另外一部分是自动添加的编译选项（之前的<a href="https://www.v4ler1an.com/afl%E4%BA%8C%E4%B8%89%E4%BA%8B2/">原理</a>文章的插桩部分有简单介绍）。</p>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>3. find_as 函数</h4><p>函数的核心作用：寻找 <code>afl-as</code> </p>
<blockquote class="blockquote">
<p>/<em> Try to find our "fake" GNU assembler in AFL_PATH or at the location derived  from argv[0]. If that fails, abort. </em>/ </p>
</blockquote>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>函数内部大概的流程如下（软件自动生成，控制流程图存在误差，但关键逻辑没有问题）：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_V9BWQ8W4PTN8XXC.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210825145618543" class="div_message_boxShadow"></p>
<ol>
<li>首先检查环境变量 <code>AFL_PATH</code> ，如果存在直接赋值给 <code>afl_path</code> ，然后检查 <code>afl_path/as</code> 文件是否可以访问，如果可以，<code>as_path = afl_path</code>。</li>
<li>如果不存在环境变量 <code>AFL_PATH</code> ，检查 <code>argv[0]</code> （如“/Users/v4ler1an/AFL/afl-gcc”）中是否存在 "/" ，如果存在则取最后“/” 前面的字符串作为 <code>dir</code>，然后检查 <code>dir/afl-as</code> 是否可以访问，如果可以，将 <code>as_path = dir</code> 。</li>
<li>以上两种方式都失败，抛出异常。</li>
</ol>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>4. edit_params 函数</h4><p>核心作用：将 <code>argv</code> 拷贝到 <code>u8 **cc_params</code>，然后进行相应的处理。</p>
<blockquote class="blockquote">
<p>/<em> Copy argv to cc_params, making the necessary edits. </em>/</p>
</blockquote>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>函数内部的大概流程如下：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_H7WCZRTR9BR4AYG.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210825150938293" class="div_message_boxShadow"></p>
<ol>
<li><p>调用 <code>ch_alloc()</code> 为 <code>cc_params</code> 分配大小为 <code>(argc + 128) * 8</code> 的内存（u8的类型为1byte无符号整数）</p>
</li>
<li><p>检查 <code>argv[0]</code> 中是否存在<code>/</code>，如果不存在则 <code>name = argv[0]</code>，如果存在则一直找到最后一个<code>/</code>，并将其后面的字符串赋值给 <code>name</code></p>
</li>
<li><p>对比 <code>name</code>和固定字符串<code>afl-clang</code>：</p>
<ol>
<li><p>若相同，设置<code>clang_mode = 1</code>，设置环境变量<code>CLANG_ENV_VAR</code>为1</p>
<ol>
<li>对比<code>name</code>和固定字符串<code>afl-clang++</code>:：<ol>
<li>若相同，则获取环境变量<code>AFL_CXX</code>的值，如果存在，则将该值赋值给<code>cc_params[0]</code>，否则将<code>afl-clang++</code>赋值给<code>cc_params[0]</code>。这里的<code>cc_params</code>为保存编译参数的数组；</li>
<li>若不相同，则获取环境变量<code>AFL_CC</code>的值，如果存在，则将该值赋值给<code>cc_params[0]</code>，否则将<code>afl-clang</code>赋值给<code>cc_params[0]</code>。</li>
</ol>
</li>
</ol>
</li>
<li><p>如果不相同，并且是Apple平台，会进入 <code>#ifdef __APPLE__</code>。在Apple平台下，开始对 <code>name</code> 进行对比，并通过 <code>cc_params[0] = getenv("")</code> 对<code>cc_params[0]</code>进行赋值；如果是非Apple平台，对比 <code>name</code> 和 固定字符串<code>afl-g++</code>（此处忽略对Java环境的处理过程）：</p>
<ol>
<li><p>若相同，则获取环境变量<code>AFL_CXX</code>的值，如果存在，则将该值赋值给<code>cc_params[0]</code>，否则将<code>g++</code>赋值给<code>cc_params[0]</code>；</p>
</li>
<li><p>若不相同，则获取环境变量<code>AFL_CC</code>的值，如果存在，则将该值赋值给<code>cc_params[0]</code>，否则将<code>gcc</code>赋值给<code>cc_params[0]</code>。</p>
</li>
</ol>
</li>
</ol>
</li>
<li><p>进入 while 循环，遍历从<code>argv[1]</code>开始的<code>argv</code>参数：</p>
<ul>
<li><p>如果扫描到 <code>-B</code> ，<code>-B</code>选项用于设置编译器的搜索路径，直接跳过。（因为在这之前已经处理过<code>as_path</code>了）；</p>
</li>
<li><p>如果扫描到 <code>-integrated-as</code>，跳过；</p>
</li>
<li><p>如果扫描到 <code>-pipe</code>，跳过；</p>
</li>
<li><p>如果扫描到 <code>-fsanitize=address</code> 和 <code>-fsanitize=memory</code> 告诉 gcc 检查内存访问的错误，比如数组越界之类，设置 <code>asan_set = 1；</code></p>
</li>
<li><p>如果扫描到 <code>FORTIFY_SOURCE</code> ，设置 <code>fortify_set = 1</code> 。<code>FORTIFY_SOURCE</code> 主要进行缓冲区溢出问题的检查，检查的常见函数有<code>memcpy, mempcpy, memmove, memset, strcpy, stpcpy, strncpy, strcat, strncat, sprintf, vsprintf, snprintf, gets</code> 等；</p>
</li>
<li><p>对 <code>cc_params</code> 进行赋值：<code>cc_params[cc_par_cnt++] = cur;</code></p>
</li>
</ul>
</li>
<li><p>跳出 <code>while</code> 循环，设置其他参数：</p>
<ol>
<li>取出前面计算出的 <code>as_path</code> ，设置 <code>-B as_path</code> ；</li>
</ol>
</li>
<li>如果为 <code>clang_mode</code> ，则设置<code>-no-integrated-as</code>；<ol>
<li>如果存在环境变量 <code>AFL_HARDEN</code>，则设置<code>-fstack-protector-all</code>。且如果没有设置 <code>fortify_set</code> ，追加 <code>-D_FORTIFY_SOURCE=2</code> ；</li>
</ol>
</li>
<li><p>sanitizer相关，通过多个if进行判断：</p>
<ul>
<li>如果 <code>asan_set</code> 在前面被设置为1，则设置环境变量 <code>AFL_USE_ASAN</code> 为1；<ul>
<li>如果 <code>asan_set</code> 不为1且，存在 <code>AFL_USE_ASAN</code> 环境变量，则设置<code>-U_FORTIFY_SOURCE -fsanitize=address</code>；</li>
</ul>
</li>
<li><p>如果不存在 <code>AFL_USE_ASAN</code> 环境变量，但存在 <code>AFL_USE_MSAN</code> 环境变量，则设置<code>-fsanitize=memory</code>（不能同时指定<code>AFL_USE_ASAN</code>或者<code>AFL_USE_MSAN</code>，也不能同时指定 <code>AFL_USE_MSAN</code> 和 <code>AFL_HARDEN</code>，因为这样运行时速度过慢；</p>
<ul>
<li>如果不存在 <code>AFL_DONT_OPTIMIZE</code> 环境变量，则设置<code>-g -O3 -funroll-loops -D__AFL_COMPILER=1 -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</code>；</li>
<li>如果存在 <code>AFL_NO_BUILTIN</code> 环境变量，则表示允许进行优化，设置<code>-fno-builtin-strcmp -fno-builtin-strncmp -fno-builtin-strcasecmp -fno-builtin-strncasecmp -fno-builtin-memcmp -fno-builtin-strstr -fno-builtin-strcasestr</code>。</li>
</ul>
</li>
</ul>
</li>
<li>最后补充<code>cc_params[cc_par_cnt] = NULL;</code>，<code>cc_params</code> 参数数组编辑完成。</li>
</ol>
<h2 id="msg_header_h2_3"><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>二、AFL 的源码插桩 —— afl-as.c</h2><h3 id="msg_header_h3_2"><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>1. 概述</h3><p><code>afl-gcc</code> 是 GNU as 的一个wrapper（封装），唯一目的是预处理由 GCC/clang 生成的汇编文件，并注入包含在 <code>afl-as.h</code> 中的插桩代码。 使用 <code>afl-gcc / afl-clang</code> 编译程序时，工具链会自动调用它。该wapper的目标并不是为了实现向 <code>.s</code> 或 <code>asm</code> 代码块中插入手写的代码。</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p> <code>experiment/clang_asm_normalize/</code> 中可以找到可能允许 clang 用户进行手动插入自定义代码的解决方案，GCC并不能实现该功能。</p>
<h3 id="msg_header_h3_3"><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>2. 源码</h3><h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>1. 关键变量</h4><p>在开始函数代码分析前，首先要明确几个关键变量：</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">static u8</code><code class="python keyword">*</code><code class="python keyword">*</code> <code class="python plain">as_params;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Parameters passed to the real </code><code class="python string">'as'</code><code class="python plain">，传递给as的参数&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python plain">static u8</code><code class="python keyword">*</code>&nbsp; <code class="python plain">input_file;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Originally specified </code><code class="python functions">input</code> <code class="python functions">file</code> <code class="python plain">，输入文件&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number4 index3 alt1"><code class="python plain">static u8</code><code class="python keyword">*</code>&nbsp; <code class="python plain">modified_file;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Instrumented </code><code class="python functions">file</code> <code class="python keyword">for</code> <code class="python plain">the real </code><code class="python string">'as'</code><code class="python plain">，as进行插桩处理的文件&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="python plain">static u8&nbsp;&nbsp; be_quiet,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Quiet mode (no stderr output) ，静默模式，没有标准输出&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">clang_mode,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Running </code><code class="python keyword">in</code> <code class="python plain">clang mode?&nbsp;&nbsp;&nbsp; 是否运行在clang模式&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">pass_thru,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Just </code><code class="python keyword">pass</code> <code class="python plain">data through?&nbsp;&nbsp; 只通过数据&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">just_version,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Just show version?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 只显示版本&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">sanitizer;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Using ASAN </code><code class="python keyword">/</code> <code class="python plain">MSAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 是否使用ASAN</code><code class="python keyword">/</code><code class="python plain">MSAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="python plain">static u32&nbsp; inst_ratio </code><code class="python keyword">=</code> <code class="python value">100</code><code class="python plain">,&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Instrumentation probability (</code><code class="python keyword">%</code><code class="python plain">)&nbsp; 插桩覆盖率&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">as_par_cnt </code><code class="python keyword">=</code> <code class="python value">1</code><code class="python plain">;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Number of params to </code><code class="python string">'as'</code>&nbsp;&nbsp;&nbsp; <code class="python plain">传递给as的参数数量初始值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div></div></td></tr></tbody></table>
<p>注：如果在参数中没有指明 <code>--m32</code> 或 <code>--m64</code> ，则默认使用在编译时使用的选项。</p>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>2. main函数</h4><p>main 函数全部逻辑如下：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_XVS2U66V77WGBEA.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210826112703339" class="div_message_boxShadow"></p>
<ol>
<li>首先获取环境变量 <code>AFL_INST_RATIO</code> ，赋值给 <code>inst_ratio_str</code>，该环境变量主要控制检测每个分支的概率，取值为0到100%，设置为0时则只检测函数入口的跳转，而不会检测函数分支的跳转；</li>
<li>通过 <code>gettimeofday(&amp;tv,&amp;tz);</code>获取时区和时间，然后设置 <code>srandom()</code> 的随机种子 <code>rand_seed = tv.tv_sec ^ tv.tv_usec ^ getpid();</code></li>
<li>调用 <code>edit_params(argc, argv)</code> 函数进行参数处理；</li>
<li>检测 <code>inst_ratio_str</code> 的值是否合法范围内，并设置环境变量 <code>AFL_LOOP_ENV_VAR</code>；</li>
<li>读取环境变量<code>`AFL_USE_ASAN</code>和<code>AFL_USE_MSAN</code>的值，如果其中有一个为1，则设置<code>sanitizer</code>为1，且将<code>inst_ratio</code>除3。这是因为在进行ASAN的编译时，AFL无法识别出ASAN特定的分支，导致插入很多无意义的桩代码，所以直接暴力地将插桩概率/3；</li>
<li>调用 <code>add_instrumentation()</code> 函数，这是实际的插桩函数；</li>
<li>fork 一个子进程来执行 <code>execvp(as_params[0], (char**)as_params);</code>。这里采用的是 fork 一个子进程的方式来执行插桩。这其实是因为我们的 <code>execvp</code> 执行的时候，会用 <code>as_params[0]</code> 来完全替换掉当前进程空间中的程序，如果不通过子进程来执行实际的 <code>as</code>，那么后续就无法在执行完实际的as之后，还能unlink掉modified_file；</li>
<li>调用 <code>waitpid(pid, &amp;status, 0)</code> 等待子进程执行结束；</li>
<li>读取环境变量 <code>AFL_KEEP_ASSEMBLY</code> 的值，如果没有设置这个环境变量，就unlink掉 <code>modified_file</code>(已插完桩的文件)。设置该环境变量主要是为了防止 <code>afl-as</code> 删掉插桩后的汇编文件，设置为1则会保留插桩后的汇编文件。</li>
</ol>
<p>可以通过在main函数中添加如下代码来打印实际执行的参数：</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python functions">print</code><code class="python plain">(</code><code class="python string">"\n"</code><code class="python plain">);</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python keyword">for</code> <code class="python plain">(</code><code class="python functions">int</code> <code class="python plain">i </code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">; i &lt; sizeof(as_params); i</code><code class="python keyword">+</code><code class="python keyword">+</code><code class="python plain">){</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">peinrf(</code><code class="python string">"as_params[%d]:%s\n"</code><code class="python plain">, i, as_params[i]);</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="python plain">}</code></div></div></td></tr></tbody></table>
<p><img src="./AFL二三事 -- 源码分析 1/779730_QCTJBRB3YKRG2G6.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210827111515934" class="div_message_boxShadow"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>在插桩完成后，会生成 <code>.s</code> 文件，内容如下（具体的文件位置与设置的环境变量相关）：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_DH2YTFCHGCXGWVU.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210827111738232" class="div_message_boxShadow"></p>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>3. add_instrumentation函数</h4><p><code>add_instrumentation</code> 函数负责处理输入文件，生成 <code>modified_file</code> ，将 <code>instrumentation</code> 插入所有适当的位置。其整体控制流程如下：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_6PEXKCHGGH8VNQ9.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210826145814976" class="div_message_boxShadow"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>整体逻辑看上去有点复杂，但是关键内容并不算很多。在main函数中调用完 <code>edit_params()</code> 函数完成 <code>as_params</code> 参数数组的处理后，进入到该函数。</p>
<ol>
<li><p>判断 <code>input_file</code> 是否为空，如果不为空则尝试打开文件获取fd赋值给 <code>inf</code>，失败则抛出异常；<code>input_file</code> 为空则 <code>inf</code> 设置为标准输入； </p>
</li>
<li><p>打开 <code>modified_file</code> ，获取fd赋值给 <code>outfd</code>，失败返回异常；进一步验证该文件是否可写，不可写返回异常；</p>
</li>
<li><p><code>while</code> 循环读取 <code>inf</code> 指向文件的每一行到 <code>line</code> 数组，每行最多 <code>MAX_LINE = 8192</code>个字节（含末尾的‘\0’），从<code>line</code>数组里将读取到的内容写入到 <code>outf</code> 指向的文件，然后进入到真正的插桩逻辑。这里需要注意的是，插桩只向 <code>.text</code> 段插入，：</p>
<ol>
<li><p>首先跳过标签、宏、注释；</p>
</li>
<li><p>这里结合部分关键代码进行解释。需要注意的是，变量 <code>instr_ok</code> 本质上是一个flag，用于表示是否位于<code>.text</code>段。变量设置为1，表示位于 <code>.text</code> 中，如果不为1，则表示不再。于是，如果<code>instr_ok</code> 为1，就会在分支处执行插桩逻辑，否则就不插桩。</p>
<ol>
<li><p>首先判断读入的行是否以‘\t’ 开头，本质上是在匹配<code>.s</code>文件中声明的段，然后判断<code>line[1]</code>是否为<code>.</code>：</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">if</code> <code class="python plain">(line[</code><code class="python value">0</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'\t'</code> <code class="python plain">&amp;&amp; line[</code><code class="python value">1</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'.'</code><code class="python plain">) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">OpenBSD puts jump tables directly inline with the code, which </code><code class="python keyword">is</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">a bit annoying. They use a specific </code><code class="python functions">format</code> <code class="python plain">of p2align directives</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">around them, so we use that as a signal. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(!clang_mode &amp;&amp; instr_ok &amp;&amp; !strncmp(line </code><code class="python keyword">+</code> <code class="python value">2</code><code class="python plain">, </code><code class="python string">"p2align "</code><code class="python plain">, </code><code class="python value">8</code><code class="python plain">) &amp;&amp;</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">isdigit(line[</code><code class="python value">10</code><code class="python plain">]) &amp;&amp; line[</code><code class="python value">11</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'\n'</code><code class="python plain">) skip_next_label </code><code class="python keyword">=</code> <code class="python value">1</code><code class="python plain">;</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(!strncmp(line </code><code class="python keyword">+</code> <code class="python value">2</code><code class="python plain">, </code><code class="python string">"text\n"</code><code class="python plain">, </code><code class="python value">5</code><code class="python plain">) ||</code></div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">!strncmp(line </code><code class="python keyword">+</code> <code class="python value">2</code><code class="python plain">, </code><code class="python string">"section\t.text"</code><code class="python plain">, </code><code class="python value">13</code><code class="python plain">) ||</code></div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">!strncmp(line </code><code class="python keyword">+</code> <code class="python value">2</code><code class="python plain">, </code><code class="python string">"section\t__TEXT,__text"</code><code class="python plain">, </code><code class="python value">21</code><code class="python plain">) ||</code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">!strncmp(line </code><code class="python keyword">+</code> <code class="python value">2</code><code class="python plain">, </code><code class="python string">"section __TEXT,__text"</code><code class="python plain">, </code><code class="python value">21</code><code class="python plain">)) {</code></div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">instr_ok </code><code class="python keyword">=</code> <code class="python value">1</code><code class="python plain">;</code></div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">continue</code><code class="python plain">; </code></div><div class="line number16 index15 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(!strncmp(line </code><code class="python keyword">+</code> <code class="python value">2</code><code class="python plain">, </code><code class="python string">"section\t"</code><code class="python plain">, </code><code class="python value">8</code><code class="python plain">) ||</code></div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">!strncmp(line </code><code class="python keyword">+</code> <code class="python value">2</code><code class="python plain">, </code><code class="python string">"section "</code><code class="python plain">, </code><code class="python value">8</code><code class="python plain">) ||</code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">!strncmp(line </code><code class="python keyword">+</code> <code class="python value">2</code><code class="python plain">, </code><code class="python string">"bss\n"</code><code class="python plain">, </code><code class="python value">4</code><code class="python plain">) ||</code></div><div class="line number21 index20 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">!strncmp(line </code><code class="python keyword">+</code> <code class="python value">2</code><code class="python plain">, </code><code class="python string">"data\n"</code><code class="python plain">, </code><code class="python value">5</code><code class="python plain">)) {</code></div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">instr_ok </code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">;</code></div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">continue</code><code class="python plain">;</code></div><div class="line number24 index23 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code></div></div></td></tr></tbody></table>
<ol>
<li>'\t'开头，且<code>line[1]=='.'</code>，检查是否为 <code>p2align</code> 指令，如果是，则设置 <code>skip_next_label = 1</code>；</li>
<li>尝试匹配 <code>"text\n"</code> <code>"section\t.text"</code> <code>"section\t__TEXT,__text"</code> <code>"section __TEXT,__text"</code> 其中任意一个，匹配成功， 设置 <code>instr_ok = 1</code>， 表示位于 <code>.text</code> 段中，<code>continue</code> 跳出，进行下一次遍历；</li>
<li>尝试匹配<code>"section\t"</code> <code>"section "</code> <code>"bss\n"</code> <code>"data\n"</code> 其中任意一个，匹配成功，设置 <code>instr_ok = 0</code>，表位于其他段中，<code>continue</code> 跳出，进行下一次遍历；</li>
</ol>
</li>
<li><p>接下来通过几个 <code>if</code> 判断，来设置一些标志信息，包括 <code>off-flavor assembly</code>，<code>Intel/AT&amp;T</code>的块处理方式、<code>ad-hoc __asm__</code>块的处理方式等；</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Detect off</code><code class="python keyword">-</code><code class="python plain">flavor assembly (rare, happens </code><code class="python keyword">in</code> <code class="python plain">gdb). When this </code><code class="python keyword">is</code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">encountered, we </code><code class="python functions">set</code> <code class="python plain">skip_csect until the opposite directive </code><code class="python keyword">is</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">seen, </code><code class="python keyword">and</code> <code class="python plain">we do </code><code class="python keyword">not</code> <code class="python plain">instrument. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="python keyword">if</code> <code class="python plain">(strstr(line, </code><code class="python string">".code"</code><code class="python plain">)) {</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(strstr(line, </code><code class="python string">".code32"</code><code class="python plain">)) skip_csect </code><code class="python keyword">=</code> <code class="python plain">use_64bit;</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(strstr(line, </code><code class="python string">".code64"</code><code class="python plain">)) skip_csect </code><code class="python keyword">=</code> <code class="python plain">!use_64bit;</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="python plain">}</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Detect syntax changes, as could happen with hand</code><code class="python keyword">-</code><code class="python plain">written assembly.</code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">Skip Intel blocks, resume instrumentation when back to AT&amp;T. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="python keyword">if</code> <code class="python plain">(strstr(line, </code><code class="python string">".intel_syntax"</code><code class="python plain">)) skip_intel </code><code class="python keyword">=</code> <code class="python value">1</code><code class="python plain">;</code></div><div class="line number16 index15 alt1"><code class="python keyword">if</code> <code class="python plain">(strstr(line, </code><code class="python string">".att_syntax"</code><code class="python plain">)) skip_intel </code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">;</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Detect </code><code class="python keyword">and</code> <code class="python plain">skip ad</code><code class="python keyword">-</code><code class="python plain">hoc __asm__ blocks, likewise skipping them. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="python keyword">if</code> <code class="python plain">(line[</code><code class="python value">0</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'#'</code> <code class="python plain">|| line[</code><code class="python value">1</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'#'</code><code class="python plain">) {</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(strstr(line, </code><code class="python string">"#APP"</code><code class="python plain">)) skip_app </code><code class="python keyword">=</code> <code class="python value">1</code><code class="python plain">;</code></div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(strstr(line, </code><code class="python string">"#NO_APP"</code><code class="python plain">)) skip_app </code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">;</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="python plain">}</code></div></div></td></tr></tbody></table>
</li>
<li><p>AFL在插桩时重点关注的内容包括：<code>^main, ^.L0, ^.LBB0_0, ^\tjnz foo</code> （_main函数， gcc和clang下的分支标记，条件跳转分支标记），这些内容通常标志了程序的流程变化，因此AFL会重点在这些位置进行插桩：</p>
<p>对于形如<code>\tj[^m].</code>格式的指令，即条件跳转指令，且<code>R(100)</code>产生的随机数小于插桩密度<code>inst_ratio</code>，直接使用<code>fprintf</code>将<code>trampoline_fmt_64</code>(插桩部分的指令)写入 <code>outf</code> 指向的文件，写入大小为小于 <code>MAP_SIZE</code>的随机数——<code>R(MAP_SIZE)</code></p>
<p>，然后插桩计数<code>ins_lines</code>加一，<code>continue</code> 跳出，进行下一次遍历；</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">If we're </code><code class="python keyword">in</code> <code class="python plain">the right mood </code><code class="python keyword">for</code> <code class="python plain">instrumenting, check </code><code class="python keyword">for</code> <code class="python plain">function</code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">names </code><code class="python keyword">or</code> <code class="python plain">conditional labels. This </code><code class="python keyword">is</code> <code class="python plain">a bit messy, but </code><code class="python keyword">in</code> <code class="python plain">essence,</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">we want to catch:</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^main:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">-</code> <code class="python plain">function entry point (always instrumented)</code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^.L0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">-</code> <code class="python plain">GCC branch label</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^.LBB0_0:&nbsp;&nbsp; </code><code class="python keyword">-</code> <code class="python plain">clang branch label (but only </code><code class="python keyword">in</code> <code class="python plain">clang mode)</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^\tjnz foo&nbsp; </code><code class="python keyword">-</code> <code class="python plain">conditional branches</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">...but </code><code class="python keyword">not</code><code class="python plain">:</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^</code><code class="python comments"># BB#0:&nbsp;&nbsp;&nbsp; - clang comments</code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^ </code><code class="python comments"># BB#0:&nbsp;&nbsp; - ditto</code></div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^.Ltmp0:&nbsp;&nbsp;&nbsp; </code><code class="python keyword">-</code> <code class="python plain">clang non</code><code class="python keyword">-</code><code class="python plain">branch labels</code></div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^.LC0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">-</code> <code class="python plain">GCC non</code><code class="python keyword">-</code><code class="python plain">branch labels</code></div><div class="line number16 index15 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^.LBB0_0:&nbsp;&nbsp; </code><code class="python keyword">-</code> <code class="python plain">ditto (when </code><code class="python keyword">in</code> <code class="python plain">GCC mode)</code></div><div class="line number17 index16 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">^\tjmp foo&nbsp; </code><code class="python keyword">-</code> <code class="python plain">non</code><code class="python keyword">-</code><code class="python plain">conditional jumps</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">Additionally, clang </code><code class="python keyword">and</code> <code class="python plain">GCC on MacOS X follow a different convention</code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">with no leading dots on labels, hence the weird maze of </code><code class="python comments">#ifdefs</code></div><div class="line number21 index20 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">later on.</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;</code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="python keyword">if</code> <code class="python plain">(skip_intel || skip_app || skip_csect || !instr_ok ||</code></div><div class="line number26 index25 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">line[</code><code class="python value">0</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'#'</code> <code class="python plain">|| line[</code><code class="python value">0</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">' '</code><code class="python plain">) </code><code class="python keyword">continue</code><code class="python plain">;</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Conditional branch instruction (jnz, etc). We append the instrumentation</code></div><div class="line number29 index28 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">right after the branch (to instrument the </code><code class="python keyword">not</code><code class="python keyword">-</code><code class="python plain">taken path) </code><code class="python keyword">and</code> <code class="python plain">at the</code></div><div class="line number30 index29 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;</code><code class="python plain">branch destination label (handled later on). </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number31 index30 alt2">&nbsp;</div><div class="line number32 index31 alt1"><code class="python keyword">if</code> <code class="python plain">(line[</code><code class="python value">0</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'\t'</code><code class="python plain">) {</code></div><div class="line number33 index32 alt2">&nbsp;</div><div class="line number34 index33 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(line[</code><code class="python value">1</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'j'</code> <code class="python plain">&amp;&amp; line[</code><code class="python value">2</code><code class="python plain">] !</code><code class="python keyword">=</code> <code class="python string">'m'</code> <code class="python plain">&amp;&amp; R(</code><code class="python value">100</code><code class="python plain">) &lt; inst_ratio) {</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">fprintf(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</code></div><div class="line number37 index36 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">R(MAP_SIZE));</code></div><div class="line number38 index37 alt1">&nbsp;</div><div class="line number39 index38 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">ins_lines</code><code class="python keyword">+</code><code class="python keyword">+</code><code class="python plain">;</code></div><div class="line number40 index39 alt1">&nbsp;</div><div class="line number41 index40 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">}</code></div><div class="line number42 index41 alt1">&nbsp;</div><div class="line number43 index42 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">continue</code><code class="python plain">;</code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="python plain">}</code></div></div></td></tr></tbody></table>
</li>
<li><p>对于label的相关评估，有一些label可能是一些分支的目的地，需要自己的评判</p>
<p>首先检查该行中是否存在<code>:</code>，然后检查是否以<code>.</code>开始</p>
<ol>
<li><p>如果以<code>.</code>开始，则代表想要插桩<code>^.L0:</code>或者 <code>^.LBB0_0:</code>这样的branch label，即 style jump destination</p>
<ol>
<li>检查 <code>line[2]</code>是否为数字 或者 如果是在clang_mode下，比较从<code>line[1]</code>开始的三个字节是否为<code>LBB.</code>，前述所得结果和<code>R(100) &lt; inst_ratio)</code>相与。如果结果为真，则设置<code>instrument_next = 1</code>；</li>
</ol>
</li>
<li>否则代表这是一个function，插桩<code>^func:</code>，function entry point，直接设置<code>instrument_next = 1</code>（defer mode）。</li>
</ol>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Label of some sort. This may be a branch destination, but we need to</code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">tread carefully </code><code class="python keyword">and</code> <code class="python plain">account </code><code class="python keyword">for</code> <code class="python plain">several different formatting</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">conventions. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="python comments">#ifdef __APPLE__</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Apple: L&lt;whatever&gt;&lt;digit&gt;: </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">((colon_pos </code><code class="python keyword">=</code> <code class="python plain">strstr(line, </code><code class="python string">":"</code><code class="python plain">))) {</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(line[</code><code class="python value">0</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'L'</code> <code class="python plain">&amp;&amp; isdigit(</code><code class="python keyword">*</code><code class="python plain">(colon_pos </code><code class="python keyword">-</code> <code class="python value">1</code><code class="python plain">))) {</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="python comments">#else</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Everybody </code><code class="python keyword">else</code><code class="python plain">: .L&lt;whatever&gt;: </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(strstr(line, </code><code class="python string">":"</code><code class="python plain">)) {</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(line[</code><code class="python value">0</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'.'</code><code class="python plain">) {</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="python comments">#endif /* __APPLE__ */</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">.L0: </code><code class="python keyword">or</code> <code class="python plain">LBB0_0: style jump destination </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="python comments">#ifdef __APPLE__</code></div><div class="line number26 index25 alt1">&nbsp;</div><div class="line number27 index26 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Apple: L&lt;num&gt; </code><code class="python keyword">/</code> <code class="python plain">LBB&lt;num&gt; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">((isdigit(line[</code><code class="python value">1</code><code class="python plain">]) || (clang_mode &amp;&amp; !strncmp(line, </code><code class="python string">"LBB"</code><code class="python plain">, </code><code class="python value">3</code><code class="python plain">)))</code></div><div class="line number30 index29 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">&amp;&amp; R(</code><code class="python value">100</code><code class="python plain">) &lt; inst_ratio) {</code></div><div class="line number31 index30 alt2">&nbsp;</div><div class="line number32 index31 alt1"><code class="python comments">#else</code></div><div class="line number33 index32 alt2">&nbsp;</div><div class="line number34 index33 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Apple: .L&lt;num&gt; </code><code class="python keyword">/</code> <code class="python plain">.LBB&lt;num&gt; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">((isdigit(line[</code><code class="python value">2</code><code class="python plain">]) || (clang_mode &amp;&amp; !strncmp(line </code><code class="python keyword">+</code> <code class="python value">1</code><code class="python plain">, </code><code class="python string">"LBB"</code><code class="python plain">, </code><code class="python value">3</code><code class="python plain">)))</code></div><div class="line number37 index36 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">&amp;&amp; R(</code><code class="python value">100</code><code class="python plain">) &lt; inst_ratio) {</code></div><div class="line number38 index37 alt1">&nbsp;</div><div class="line number39 index38 alt2"><code class="python comments">#endif /* __APPLE__ */</code></div><div class="line number40 index39 alt1">&nbsp;</div><div class="line number41 index40 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">An optimization </code><code class="python keyword">is</code> <code class="python plain">possible here by adding the code only </code><code class="python keyword">if</code> <code class="python plain">the</code></div><div class="line number42 index41 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">label </code><code class="python keyword">is</code> <code class="python plain">mentioned </code><code class="python keyword">in</code> <code class="python plain">the code </code><code class="python keyword">in</code> <code class="python plain">contexts other than call </code><code class="python keyword">/</code> <code class="python plain">jmp.</code></div><div class="line number43 index42 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">That said, this complicates the code by requiring two</code><code class="python keyword">-</code><code class="python keyword">pass</code></div><div class="line number44 index43 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">processing (messy with stdin), </code><code class="python keyword">and</code> <code class="python plain">results </code><code class="python keyword">in</code> <code class="python plain">a speed gain</code></div><div class="line number45 index44 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">typically under </code><code class="python value">10</code><code class="python keyword">%</code><code class="python plain">, because compilers are generally pretty good</code></div><div class="line number46 index45 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">about </code><code class="python keyword">not</code> <code class="python plain">generating spurious intra</code><code class="python keyword">-</code><code class="python plain">function jumps.</code></div><div class="line number47 index46 alt2">&nbsp;</div><div class="line number48 index47 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">We use deferred output chiefly to avoid disrupting</code></div><div class="line number49 index48 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">.Lfunc_begin0</code><code class="python keyword">-</code><code class="python plain">style exception handling calculations (a problem on</code></div><div class="line number50 index49 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">MacOS X). </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number51 index50 alt2">&nbsp;</div><div class="line number52 index51 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">(!skip_next_label) instrument_next </code><code class="python keyword">=</code> <code class="python value">1</code><code class="python plain">; </code><code class="python keyword">else</code> <code class="python plain">skip_next_label </code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">;</code></div><div class="line number53 index52 alt2">&nbsp;</div><div class="line number54 index53 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code></div><div class="line number55 index54 alt2">&nbsp;</div><div class="line number56 index55 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">} </code><code class="python keyword">else</code> <code class="python plain">{</code></div><div class="line number57 index56 alt2">&nbsp;</div><div class="line number58 index57 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Function label (always instrumented, deferred mode). </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number59 index58 alt2">&nbsp;</div><div class="line number60 index59 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">instrument_next </code><code class="python keyword">=</code> <code class="python value">1</code><code class="python plain">;</code></div><div class="line number61 index60 alt2">&nbsp;</div><div class="line number62 index61 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code></div><div class="line number63 index62 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">}</code></div><div class="line number64 index63 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">}</code></div></div></td></tr></tbody></table>
</li>
<li><p>上述过程完成后，来到 <code>while</code> 循环的下一个循环，在 <code>while</code> 的开头，可以看到对以 defered mode 进行插桩的位置进行了真正的插桩处理：</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">if</code> <code class="python plain">(!pass_thru &amp;&amp; !skip_intel &amp;&amp; !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;</code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">instrument_next &amp;&amp; line[</code><code class="python value">0</code><code class="python plain">] </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python string">'\t'</code> <code class="python plain">&amp;&amp; isalpha(line[</code><code class="python value">1</code><code class="python plain">])) {</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">fprintf(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">R(MAP_SIZE));</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">instrument_next </code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">;</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">ins_lines</code><code class="python keyword">+</code><code class="python keyword">+</code><code class="python plain">;</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="python plain">}</code></div></div></td></tr></tbody></table>
<p>这里对 <code>instr_ok, instrument_next</code> 变量进行了检验是否为1，而且进一步校验是否位于 <code>.text</code> 段中，且设置了 defered mode 进行插桩，则就进行插桩操作，写入 <code>trampoline_fmt_64/32</code> 。</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>至此，插桩函数 <code>add_instrumentation</code> 的主要逻辑已梳理完成。</p>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>4. edit_params函数</h4><p><code>edit_params</code>，该函数主要是设置变量 <code>as_params</code> 的值，以及 <code>use_64bit/modified_file</code> 的值， 其整体控制流程如下：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_T9FVPCSEVNTXUCR.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210826122737400" class="div_message_boxShadow"></p>
<ol>
<li><p>获取环境变量 <code>TMPDIR</code> 和 <code>AFL_AS</code>;</p>
</li>
<li><p>对于 <code>__APPLE_</code> 宏， 如果当前在 <code>clang_mode</code> 且没有设置 <code>AFL_AS</code> 环境变量，会设置 <code>use_clang_mode = 1</code>，并设置 <code>afl-as</code> 为 <code>AFL_CC/AFL_CXX/clang</code>中的一种；</p>
</li>
<li><p>设置 <code>tmp_dir</code> ，尝试获取的环境变量依次为 <code>TEMP, TMP</code>，如果都失败，则直接设置为 <code>/tmp</code>；</p>
</li>
<li><p>调用 <code>ck_alloc()</code> 函数为 <code>as_params</code> 参数数组分配内存，大小为(argc + 32) * 8；</p>
</li>
<li><p>设置 <code>afl-as</code> 路径：<code>as_params[0] = afl_as ? afl_as : (u8*)"as";</code></p>
</li>
<li><p>设置 <code>as_params[argc] = 0;</code> ，as_par_cnt 初始值为1；</p>
</li>
<li><p>遍历从 <code>argv[1]</code> 到 <code>argv[argc-1]</code> 之前的每个 argv：</p>
<ol>
<li>如果存在字符串 <code>--64</code>， 则设置 <code>use_64bit = 1</code> ；如果存在字符串 <code>--32</code> ，则设置 <code>use_64bit = 0</code>。对于<code>__APPLE__</code> ，如果存在<code>-arch x86_64</code>，设置 <code>use_64bit=1</code>，并跳过<code>-q</code>和<code>-Q</code>选项；</li>
<li><code>as_params[as_par_cnt++] = argv[i]</code>，设置as_params的值为argv对应的参数值</li>
</ol>
</li>
<li><p>开始设置其他参数：</p>
<ol>
<li><p>对于 <code>__APPLE__</code>，如果设置了 <code>use_clang_as</code>，则追加 <code>-c -x assembler</code>；</p>
</li>
<li><p>设置 <code>input_file</code> 变量：<code>input_file = argv[argc - 1];</code>，把最后一个参数的值作为 <code>input_file</code>；</p>
<ol>
<li><p>如果 <code>input_file</code> 的首字符为<code>-</code>：</p>
<ol>
<li>如果后续为 <code>-version</code>，则 <code>just_version = 1</code>, <code>modified_file = input_file</code>，然后跳转到<code>wrap_things_up</code>。这里就只是做<code>version</code>的查询；</li>
<li>如果后续不为 <code>-version</code>，抛出异常；</li>
</ol>
</li>
<li><p>如果 <code>input_file</code> 首字符不为<code>-</code>，比较 <code>input_file</code> 和 <code>tmp_dir</code>、<code>/var/tmp</code> 、<code>/tmp/</code>的前 <code>strlen(tmp_dir)/9/5</code>个字节是否相同，如果不相同，就设置 <code>pass_thru</code> 为1；</p>
</li>
</ol>
</li>
<li><p>设置 <code>modified_file</code>：`modified_file = alloc_printf("%s/.afl-%u-%u.s", tmp_dir, getpid(),</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">(u32)time(NULL));`，即为`tmp_dir</code><code class="python keyword">/</code><code class="python plain">afl</code><code class="python keyword">-</code><code class="python plain">pid</code><code class="python keyword">-</code><code class="python plain">tim.s` 格式的字符串</code></div></div></td></tr></tbody></table><ol>
<li>设置<code>as_params[as_par_cnt++] = modified_file</code>，<code>as_params[as_par_cnt] = NULL;</code>。</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="msg_header_h3_4"><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>3. instrumentation trampoline 和 main_payload</h3><p><code>trampoline</code> 的含义是“蹦床”，直译过来就是“插桩蹦床”。个人感觉直接使用英文更能表达出其代表的真实含义和作用，可以简单理解为桩代码。</p>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>1. trampoline_fmt_64/32</h4><p>根据前面内容知道，在64位环境下，AFL会插入 <code>trampoline_fmt_64</code> 到文件中，在32位环境下，AFL会插入<code>trampoline_fmt_32</code> 到文件中。<code>trampoline_fmt_64/32</code>定义在 <code>afl-as.h</code> 头文件中：</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">static const u8</code><code class="python keyword">*</code> <code class="python plain">trampoline_fmt_32 </code><code class="python keyword">=</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"/* --- AFL TRAMPOLINE (32-BIT) --- */\n"</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">".align 4\n"</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"leal -16(%%esp), %%esp\n"</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movl %%edi,&nbsp; 0(%%esp)\n"</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movl %%edx,&nbsp; 4(%%esp)\n"</code></div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movl %%ecx,&nbsp; 8(%%esp)\n"</code></div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movl %%eax, 12(%%esp)\n"</code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movl $0x%08x, %%ecx\n"</code>&nbsp;&nbsp;&nbsp; <code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">向ecx中存入识别代码块的随机桩代码</code><code class="python functions">id</code></div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"call __afl_maybe_log\n"</code>&nbsp;&nbsp; <code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">调用 __afl_maybe_log 函数</code></div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movl 12(%%esp), %%eax\n"</code></div><div class="line number16 index15 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movl&nbsp; 8(%%esp), %%ecx\n"</code></div><div class="line number17 index16 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movl&nbsp; 4(%%esp), %%edx\n"</code></div><div class="line number18 index17 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movl&nbsp; 0(%%esp), %%edi\n"</code></div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"leal 16(%%esp), %%esp\n"</code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code></div><div class="line number21 index20 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"/* --- END --- */\n"</code></div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code><code class="python plain">;</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="python plain">static const u8</code><code class="python keyword">*</code> <code class="python plain">trampoline_fmt_64 </code><code class="python keyword">=</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code></div><div class="line number27 index26 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"/* --- AFL TRAMPOLINE (64-BIT) --- */\n"</code></div><div class="line number28 index27 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code></div><div class="line number29 index28 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">".align 4\n"</code></div><div class="line number30 index29 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code></div><div class="line number31 index30 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"leaq -(128+24)(%%rsp), %%rsp\n"</code></div><div class="line number32 index31 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movq %%rdx,&nbsp; 0(%%rsp)\n"</code></div><div class="line number33 index32 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movq %%rcx,&nbsp; 8(%%rsp)\n"</code></div><div class="line number34 index33 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movq %%rax, 16(%%rsp)\n"</code></div><div class="line number35 index34 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movq $0x%08x, %%rcx\n"</code>&nbsp; <code class="python keyword">/</code><code class="python keyword">/</code> <code class="python value">64</code><code class="python plain">位下使用的寄存器为rcx</code></div><div class="line number36 index35 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"call __afl_maybe_log\n"</code> <code class="python keyword">/</code><code class="python keyword">/</code> <code class="python plain">调用 __afl_maybe_log 函数</code></div><div class="line number37 index36 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movq 16(%%rsp), %%rax\n"</code></div><div class="line number38 index37 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movq&nbsp; 8(%%rsp), %%rcx\n"</code></div><div class="line number39 index38 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"movq&nbsp; 0(%%rsp), %%rdx\n"</code></div><div class="line number40 index39 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"leaq (128+24)(%%rsp), %%rsp\n"</code></div><div class="line number41 index40 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code></div><div class="line number42 index41 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"/* --- END --- */\n"</code></div><div class="line number43 index42 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python string">"\n"</code><code class="python plain">;</code></div></div></td></tr></tbody></table>
<p>上面列出的插桩代码与我们在 <code>.s</code> 文件和IDA逆向中看到的插桩代码是一样的：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><code>.s</code> 文件中的桩代码：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_3RGZYQCMHHE6Z3U.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210902113944635"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>IDA逆向中显示的桩代码：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_9MMMF8SM85QBWWF.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210902114629323" class="div_message_boxShadow"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>上述代码执行的主要功能包括：</p>
<ul>
<li>保存 <code>rdx</code>、 <code>rcx</code> 、<code>rax</code> 寄存器</li>
<li>将 <code>rcx</code> 的值设置为 <code>fprintf()</code> 函数将要打印的变量内容</li>
<li>调用 <code>__afl_maybe_log</code> 函数</li>
<li>恢复寄存器</li>
</ul>
<p>在以上的功能中， <code>__afl_maybe_log</code> 才是核心内容。</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>从 <code>__afl_maybe_log</code> 函数开始，后续的处理流程大致如下(图片来自ScUpax0s师傅)：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_GPYAW7Q2MW85DPG.jpg" style="max-width: 100%; cursor: pointer;" alt="img" class="div_message_boxShadow"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>首先对上面流程中涉及到的几个bss段的变量进行简单说明（以64位为例，从<code>main_payload_64</code>中提取）：</p>
<table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">.AFL_VARS:</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">.comm&nbsp;&nbsp; __afl_area_ptr, </code><code class="python value">8</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">.comm&nbsp;&nbsp; __afl_prev_loc, </code><code class="python value">8</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">.comm&nbsp;&nbsp; __afl_fork_pid, </code><code class="python value">4</code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">.comm&nbsp;&nbsp; __afl_temp, </code><code class="python value">4</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">.comm&nbsp;&nbsp; __afl_setup_failure, </code><code class="python value">1</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">.comm&nbsp;&nbsp;&nbsp; __afl_global_area_ptr, </code><code class="python value">8</code><code class="python plain">, </code><code class="python value">8</code></div></div></td></tr></tbody></table>
<ul>
<li><code>__afl_area_ptr</code>：共享内存地址；</li>
<li><code>__afl_prev_loc</code>：上一个插桩位置（id为R(100)随机数的值）；</li>
<li><code>__afl_fork_pid</code>：由fork产生的子进程的pid；</li>
<li><code>__afl_temp</code>：缓冲区；</li>
<li><code>__afl_setup_failure</code>：标志位，如果置位则直接退出；</li>
<li><code>__afl_global_area_ptr</code>：全局指针。</li>
</ul>
<p><strong>说明</strong></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>以下介绍的指令段均来自于 <code>main_payload_64</code> 。</p>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>2. __afl_maybe_log</h4><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">__afl_maybe_log:&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">源码删除无关内容后 </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">lahf</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">seto&nbsp; </code><code class="python keyword">%</code><code class="python plain">al</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Check </code><code class="python keyword">if</code> <code class="python plain">SHM region </code><code class="python keyword">is</code> <code class="python plain">already mapped. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq&nbsp; __afl_area_ptr(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rdx</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">testq </code><code class="python keyword">%</code><code class="python plain">rdx, </code><code class="python keyword">%</code><code class="python plain">rdx</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">je&nbsp;&nbsp;&nbsp; __afl_setup</code></div></div></td></tr></tbody></table>
<p>首先，使用 <code>lahf</code> 指令（加载状态标志位到<code>AH</code>）将EFLAGS寄存器的低八位复制到 <code>AH</code>，被复制的标志位包括：符号标志位（SF）、零标志位（ZF）、辅助进位标志位（AF）、奇偶标志位（PF）和进位标志位（CF），使用该指令可以方便地将标志位副本保存在变量中；</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>然后，使用 <code>seto</code> 指令溢出置位；</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>接下来检查共享内存是否进行了设置，判断 <code>__afl_area_ptr</code> 是否为NULL：</p>
<ul>
<li>如果为NULL，跳转到 <code>__afl_setup</code> 函数进行设置；</li>
<li>如果不为NULL，继续进行。</li>
</ul>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>3. __afl_setup</h4><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">__afl_setup:</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Do </code><code class="python keyword">not</code> <code class="python plain">retry setup </code><code class="python keyword">is</code> <code class="python plain">we had previous failues. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">cmpb $</code><code class="python value">0</code><code class="python plain">, __afl_setup_failure(</code><code class="python keyword">%</code><code class="python plain">rip)</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">jne __afl_return</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Check out </code><code class="python keyword">if</code> <code class="python plain">we have a </code><code class="python keyword">global</code> <code class="python plain">pointer on </code><code class="python functions">file</code><code class="python plain">. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">movq __afl_global_area_ptr(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rdx</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">testq </code><code class="python keyword">%</code><code class="python plain">rdx, </code><code class="python keyword">%</code><code class="python plain">rdx</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">je __afl_setup_first</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rdx, __afl_area_ptr(</code><code class="python keyword">%</code><code class="python plain">rip)</code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">jmp&nbsp; __afl_store</code></div></div></td></tr></tbody></table>
<p>该部分的主要作用为初始化 <code>__afl_area_ptr</code> ，且只在运行到第一个桩时进行本次初始化。</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>首先，如果 <code>__afl_setup_failure</code> 不为0，直接跳转到 <code>__afl_return</code> 返回；</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>然后，检查 <code>__afl_global_area_ptr</code> 文件指针是否为NULL：</p>
<ul>
<li>如果为NULL，跳转到 <code>__afl_setup_first</code> 进行接下来的工作；</li>
<li>如果不为NULL，将 <code>__afl_global_area_ptr</code> 的值赋给 <code>__afl_area_ptr</code>，然后跳转到 <code>__afl_store</code> 。</li>
</ul>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>4. __afl_setup_first</h4><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">__afl_setup_first:</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Save everything that </code><code class="python keyword">is</code> <code class="python keyword">not</code> <code class="python plain">yet saved </code><code class="python keyword">and</code> <code class="python plain">that may be touched by</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">getenv() </code><code class="python keyword">and</code> <code class="python plain">several other libcalls we'll be relying on. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">leaq </code><code class="python keyword">-</code><code class="python value">352</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">rsp</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rax,&nbsp;&nbsp; </code><code class="python value">0</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rcx,&nbsp;&nbsp; </code><code class="python value">8</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rdi,&nbsp; </code><code class="python value">16</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rsi,&nbsp; </code><code class="python value">32</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">r8,&nbsp;&nbsp; </code><code class="python value">40</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">r9,&nbsp;&nbsp; </code><code class="python value">48</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">r10,&nbsp; </code><code class="python value">56</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">r11,&nbsp; </code><code class="python value">64</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm0,&nbsp; </code><code class="python value">96</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number18 index17 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm1,&nbsp; </code><code class="python value">112</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm2,&nbsp; </code><code class="python value">128</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm3,&nbsp; </code><code class="python value">144</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number21 index20 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm4,&nbsp; </code><code class="python value">160</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm5,&nbsp; </code><code class="python value">176</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm6,&nbsp; </code><code class="python value">192</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number24 index23 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm7,&nbsp; </code><code class="python value">208</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number25 index24 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm8,&nbsp; </code><code class="python value">224</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number26 index25 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm9,&nbsp; </code><code class="python value">240</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number27 index26 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm10, </code><code class="python value">256</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number28 index27 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm11, </code><code class="python value">272</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number29 index28 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm12, </code><code class="python value">288</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number30 index29 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm13, </code><code class="python value">304</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number31 index30 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm14, </code><code class="python value">320</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number32 index31 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">xmm15, </code><code class="python value">336</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp)</code></div><div class="line number33 index32 alt2">&nbsp;</div><div class="line number34 index33 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python functions">Map</code> <code class="python plain">SHM, jumping to __afl_setup_abort </code><code class="python keyword">if</code> <code class="python plain">something goes wrong. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">The </code><code class="python value">64</code><code class="python keyword">-</code><code class="python plain">bit ABI requires </code><code class="python value">16</code><code class="python keyword">-</code><code class="python plain">byte stack alignment. We'll keep the</code></div><div class="line number37 index36 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">original stack ptr </code><code class="python keyword">in</code> <code class="python plain">the callee</code><code class="python keyword">-</code><code class="python plain">saved r12. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number38 index37 alt1">&nbsp;</div><div class="line number39 index38 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">pushq </code><code class="python keyword">%</code><code class="python plain">r12</code></div><div class="line number40 index39 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq&nbsp; </code><code class="python keyword">%</code><code class="python plain">rsp, </code><code class="python keyword">%</code><code class="python plain">r12</code></div><div class="line number41 index40 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">subq&nbsp; $</code><code class="python value">16</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rsp</code></div><div class="line number42 index41 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">andq&nbsp; $</code><code class="python value">0xfffffffffffffff0</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rsp</code></div><div class="line number43 index42 alt2">&nbsp;</div><div class="line number44 index43 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">leaq .AFL_SHM_ENV(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rdi</code></div><div class="line number45 index44 alt2"><code class="python plain">call _getenv</code></div><div class="line number46 index45 alt1">&nbsp;</div><div class="line number47 index46 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">testq </code><code class="python keyword">%</code><code class="python plain">rax, </code><code class="python keyword">%</code><code class="python plain">rax</code></div><div class="line number48 index47 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">je&nbsp;&nbsp;&nbsp; __afl_setup_abort</code></div><div class="line number49 index48 alt2">&nbsp;</div><div class="line number50 index49 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq&nbsp; </code><code class="python keyword">%</code><code class="python plain">rax, </code><code class="python keyword">%</code><code class="python plain">rdi</code></div><div class="line number51 index50 alt2"><code class="python plain">call _atoi</code></div><div class="line number52 index51 alt1">&nbsp;</div><div class="line number53 index52 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">xorq </code><code class="python keyword">%</code><code class="python plain">rdx, </code><code class="python keyword">%</code><code class="python plain">rdx&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">shmat flags&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number54 index53 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">xorq </code><code class="python keyword">%</code><code class="python plain">rsi, </code><code class="python keyword">%</code><code class="python plain">rsi&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">requested addr </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number55 index54 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rax, </code><code class="python keyword">%</code><code class="python plain">rdi&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">SHM </code><code class="python functions">ID</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number56 index55 alt1"><code class="python plain">call _shmat</code></div><div class="line number57 index56 alt2">&nbsp;</div><div class="line number58 index57 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">cmpq $</code><code class="python keyword">-</code><code class="python value">1</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rax</code></div><div class="line number59 index58 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">je&nbsp;&nbsp; __afl_setup_abort</code></div><div class="line number60 index59 alt1">&nbsp;</div><div class="line number61 index60 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Store the address of the SHM region. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number62 index61 alt1">&nbsp;</div><div class="line number63 index62 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rax, </code><code class="python keyword">%</code><code class="python plain">rdx</code></div><div class="line number64 index63 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rax, __afl_area_ptr(</code><code class="python keyword">%</code><code class="python plain">rip)</code></div><div class="line number65 index64 alt2">&nbsp;</div><div class="line number66 index65 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rax, __afl_global_area_ptr(</code><code class="python keyword">%</code><code class="python plain">rip)</code></div><div class="line number67 index66 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">rax, </code><code class="python keyword">%</code><code class="python plain">rdx</code></div></div></td></tr></tbody></table>
<p>首先，保存所有寄存器的值，包括 <code>xmm</code> 寄存器组；</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>然后，进行 <code>rsp</code> 的对齐；</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>然后，获取环境变量 <code>__AFL_SHM_ID</code>，该环境变量保存的是共享内存的ID：</p>
<ul>
<li>如果获取失败，跳转到 <code>__afl_setup_abort</code> ； </li>
<li>如果获取成功，调用 <code>_shmat</code> ，启用对共享内存的访问，启用失败跳转到 <code>__afl_setup_abort</code>。</li>
</ul>
<p>接下来，将 <code>_shmat</code> 返回的共享内存地址存储在 <code>__afl_area_ptr</code> 和 <code>__afl_global_area_ptr</code> 变量中。</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>后面即开始运行 <code>__afl_forkserver</code>。</p>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>5. __afl_forkserver</h4><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">__afl_forkserver:</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Enter the fork server mode to avoid the overhead of execve() calls. We</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">push rdx (area ptr) twice to keep stack alignment neat. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">pushq </code><code class="python keyword">%</code><code class="python plain">rdx</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">pushq </code><code class="python keyword">%</code><code class="python plain">rdx</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Phone home </code><code class="python keyword">and</code> <code class="python plain">tell the parent that we're OK. (Note that signals with</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">no SA_RESTART will mess it up). If this fails, assume that the fd </code><code class="python keyword">is</code></div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">closed because we were execve()d </code><code class="python keyword">from</code> <code class="python plain">an instrumented binary, </code><code class="python keyword">or</code> <code class="python plain">because</code></div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">the parent doesn't want to use the fork server. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python value">4</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">length&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">leaq __afl_temp(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rsi </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">data&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number16 index15 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python string">" STRINGIFY((FORKSRV_FD + 1)) "</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python functions">file</code> <code class="python plain">desc </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number17 index16 alt2"><code class="python plain">CALL_L64(</code><code class="python string">"write"</code><code class="python plain">)</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">cmpq $</code><code class="python value">4</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rax</code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">jne&nbsp; __afl_fork_resume</code></div></div></td></tr></tbody></table>
<p>这一段实现的主要功能是向 <code>FORKSRV_FD+1</code> （也就是198+1）号描述符（即状态管道）中写 <code>__afl_temp</code> 中的4个字节，告诉 fork server （将在后续的文章中进行详细解释）已经成功启动。</p>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>6. __afl_fork_wait_loop</h4><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">__afl_fork_wait_loop:</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Wait </code><code class="python keyword">for</code> <code class="python plain">parent by reading </code><code class="python keyword">from</code> <code class="python plain">the pipe. Abort </code><code class="python keyword">if</code> <code class="python plain">read fails. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python value">4</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">length&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">leaq __afl_temp(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rsi </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">data&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python string">" STRINGIFY(FORKSRV_FD) "</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python functions">file</code> <code class="python plain">desc </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number8 index7 alt1"><code class="python plain">CALL_L64(</code><code class="python string">"read"</code><code class="python plain">)</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">cmpq $</code><code class="python value">4</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rax</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">jne&nbsp; __afl_die</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Once woken up, create a clone of our process. This </code><code class="python keyword">is</code> <code class="python plain">an excellent use</code></div><div class="line number13 index12 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">case </code><code class="python keyword">for</code> <code class="python plain">syscall(__NR_clone, </code><code class="python value">0</code><code class="python plain">, CLONE_PARENT), but glibc boneheadedly</code></div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">caches getpid() results </code><code class="python keyword">and</code> <code class="python plain">offers no way to update the value, breaking</code></div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">abort(), </code><code class="python keyword">raise</code><code class="python plain">(), </code><code class="python keyword">and</code> <code class="python plain">a bunch of other things :</code><code class="python keyword">-</code><code class="python plain">( </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="python plain">CALL_L64(</code><code class="python string">"fork"</code><code class="python plain">)</code></div><div class="line number18 index17 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">cmpq $</code><code class="python value">0</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rax</code></div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">jl&nbsp;&nbsp; __afl_die</code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">je&nbsp;&nbsp; __afl_fork_resume</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">In parent process: write PID to pipe, then wait </code><code class="python keyword">for</code> <code class="python plain">child. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movl </code><code class="python keyword">%</code><code class="python plain">eax, __afl_fork_pid(</code><code class="python keyword">%</code><code class="python plain">rip)</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python value">4</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">length&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number27 index26 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">leaq __afl_fork_pid(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rsi </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">data&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number28 index27 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python string">" STRINGIFY((FORKSRV_FD + 1)) "</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python functions">file</code> <code class="python plain">desc </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number29 index28 alt2"><code class="python plain">CALL_L64(</code><code class="python string">"write"</code><code class="python plain">)</code></div><div class="line number30 index29 alt1">&nbsp;</div><div class="line number31 index30 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python value">0</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">no flags&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number32 index31 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">leaq __afl_temp(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rsi&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">status&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number33 index32 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq __afl_fork_pid(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rdi </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">PID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number34 index33 alt1"><code class="python plain">CALL_L64(</code><code class="python string">"waitpid"</code><code class="python plain">)</code></div><div class="line number35 index34 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">cmpq $</code><code class="python value">0</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rax</code></div><div class="line number36 index35 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">jle&nbsp; __afl_die</code></div><div class="line number37 index36 alt2">&nbsp;</div><div class="line number38 index37 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Relay wait status to pipe, then loop back. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number39 index38 alt2">&nbsp;</div><div class="line number40 index39 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python value">4</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">length&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number41 index40 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">leaq __afl_temp(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rsi </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">data&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number42 index41 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python string">" STRINGIFY((FORKSRV_FD + 1)) "</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python functions">file</code> <code class="python plain">desc </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number43 index42 alt2"><code class="python plain">CALL_L64(</code><code class="python string">"write"</code><code class="python plain">)</code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">jmp&nbsp; __afl_fork_wait_loop</code></div></div></td></tr></tbody></table>
<ol>
<li>等待fuzzer通过控制管道发送过来的命令，读入到 <code>__afl_temp</code> 中：<ul>
<li>读取失败，跳转到 <code>__afl_die</code> ，结束循环；</li>
<li>读取成功，继续；</li>
</ul>
</li>
<li>fork 一个子进程，子进程执行 <code>__afl_fork_resume</code>；</li>
<li>将子进程的pid赋给 <code>__afl_fork_pid</code>，并写到状态管道中通知父进程；</li>
<li>等待子进程执行完成，写入状态管道告知 fuzzer；</li>
<li>重新执行下一轮 <code>__afl_fork_wait_loop</code> 。</li>
</ol>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>7. __afl_fork_resume</h4><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">__afl_fork_resume:</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">In child process: close fds, resume execution. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $</code><code class="python string">" STRINGIFY(FORKSRV_FD) "</code><code class="python plain">, </code><code class="python keyword">%</code><code class="python plain">rdi</code></div><div class="line number6 index5 alt1"><code class="python plain">CALL_L64(</code><code class="python string">"close"</code><code class="python plain">)</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq $(</code><code class="python string">" STRINGIFY(FORKSRV_FD) "</code> <code class="python keyword">+</code> <code class="python value">1</code><code class="python plain">), </code><code class="python keyword">%</code><code class="python plain">rdi</code></div><div class="line number9 index8 alt2"><code class="python plain">CALL_L64(</code><code class="python string">"close"</code><code class="python plain">)</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">popq </code><code class="python keyword">%</code><code class="python plain">rdx</code></div><div class="line number12 index11 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">popq </code><code class="python keyword">%</code><code class="python plain">rdx</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python keyword">%</code><code class="python plain">r12, </code><code class="python keyword">%</code><code class="python plain">rsp</code></div><div class="line number15 index14 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">popq </code><code class="python keyword">%</code><code class="python plain">r12</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq&nbsp; </code><code class="python value">0</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">rax</code></div><div class="line number18 index17 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq&nbsp; </code><code class="python value">8</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">rcx</code></div><div class="line number19 index18 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">16</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">rdi</code></div><div class="line number20 index19 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">32</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">rsi</code></div><div class="line number21 index20 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">40</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">r8</code></div><div class="line number22 index21 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">48</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">r9</code></div><div class="line number23 index22 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">56</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">r10</code></div><div class="line number24 index23 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">64</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">r11</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq&nbsp; </code><code class="python value">96</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm0</code></div><div class="line number27 index26 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">112</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm1</code></div><div class="line number28 index27 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">128</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm2</code></div><div class="line number29 index28 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">144</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm3</code></div><div class="line number30 index29 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">160</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm4</code></div><div class="line number31 index30 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">176</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm5</code></div><div class="line number32 index31 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">192</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm6</code></div><div class="line number33 index32 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">208</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm7</code></div><div class="line number34 index33 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">224</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm8</code></div><div class="line number35 index34 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">240</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm9</code></div><div class="line number36 index35 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">256</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm10</code></div><div class="line number37 index36 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">272</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm11</code></div><div class="line number38 index37 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">288</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm12</code></div><div class="line number39 index38 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">304</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm13</code></div><div class="line number40 index39 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">320</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm14</code></div><div class="line number41 index40 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">movq </code><code class="python value">336</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">xmm15</code></div><div class="line number42 index41 alt1">&nbsp;</div><div class="line number43 index42 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">leaq </code><code class="python value">352</code><code class="python plain">(</code><code class="python keyword">%</code><code class="python plain">rsp), </code><code class="python keyword">%</code><code class="python plain">rsp</code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">jmp&nbsp; __afl_store</code></div></div></td></tr></tbody></table>
<ol>
<li>关闭子进程中的fd；</li>
<li>恢复子进程的寄存器状态；</li>
<li>跳转到 <code>__afl_store</code> 执行。</li>
</ol>
<h4><a name="" class="anchor" href="https://bbs.pediy.com/thread-269534.htm"><span class="header-link"></span></a>8. __afl_store</h4><table border="0" cellpadding="0" cellspacing="0" class="syntaxhighlighter  python"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">__afl_store:</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python keyword">/</code><code class="python keyword">*</code> <code class="python plain">Calculate </code><code class="python keyword">and</code> <code class="python plain">store hit </code><code class="python keyword">for</code> <code class="python plain">the code location specified </code><code class="python keyword">in</code> <code class="python plain">rcx. </code><code class="python keyword">*</code><code class="python keyword">/</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">xorq __afl_prev_loc(</code><code class="python keyword">%</code><code class="python plain">rip), </code><code class="python keyword">%</code><code class="python plain">rcx</code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">xorq </code><code class="python keyword">%</code><code class="python plain">rcx, __afl_prev_loc(</code><code class="python keyword">%</code><code class="python plain">rip)</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">shrq $</code><code class="python value">1</code><code class="python plain">, __afl_prev_loc(</code><code class="python keyword">%</code><code class="python plain">rip)</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;</code><code class="python plain">incb (</code><code class="python keyword">%</code><code class="python plain">rdx, </code><code class="python keyword">%</code><code class="python plain">rcx, </code><code class="python value">1</code><code class="python plain">)</code></div></div></td></tr></tbody></table>
<p>我们直接看反编译的代码：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_B56D3HHPNVNTGP4.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210902160522077" class="div_message_boxShadow"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>这里第一步的异或中的 <code>a4</code> ，其实是调用 <code>__afl_maybe_log</code> 时传入 的参数：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_URYVNBM7APY98YD.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210902160752809"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>再往上追溯到插桩代码：</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p><img src="./AFL二三事 -- 源码分析 1/779730_Z6UNUUGWU6PG3PR.jpg" style="max-width: 100%; cursor: pointer;" alt="image-20210902160854687"></p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>可以看到传入 <code>rcx</code> 的，实际上就是用于标记当前桩的随机id， 而 <code>_afl_prev_loc</code> 其实是上一个桩的随机id。</p>
<div class="kx_md_br_div" style="margin:0; line-height:1;">&nbsp;</div><p>经过两次异或之后，再将 <code>_afl_prev_loc</code> 右移一位作为新的 <code>_afl_prev_loc</code>，最后再共享内存中存储当前插桩位置的地方计数加一。</p>
<h2 id="msg_header_h2_4"><a name="三、总结" class="anchor" href="https://bbs.pediy.com/thread-269534.htm#%E4%B8%89%E3%80%81%E6%80%BB%E7%BB%93"><span class="header-link"></span></a>三、总结</h2><p>本文综合分析了AFL中的gcc部分和插桩部分的源代码，由衷佩服AFL设计开发者的巧妙思路和高超的开发技巧，不愧是开启了fuzzing新时代的、影响力巨大的fuzz工具。</p>
<h2 id="msg_header_h2_5"><a name="参考文献：" class="anchor" href="https://bbs.pediy.com/thread-269534.htm#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%EF%BC%9A"><span class="header-link"></span></a>参考文献：</h2><p>衷心感谢乐于分享的师傅们，能让我站在巨人的肩膀上。</p>
<ol>
<li>https://eternalsakura13.com/2020/08/23/afl/</li>
<li>https://bbs.pediy.com/thread-265936.htm</li>
</ol>
						
<br>
<p><a target="_blank" href="https://www.kanxue.com/book-section_list-84.htm">[2022夏季班]《安卓高级研修班(网课)》月薪三万班招生中～</a></p>

		<div class="text-right text-muted my-3 small font-italic">
		最后于 <span class="icon-clock-o ml-2"> </span>2021-9-27 17:00		
				被有毒编辑
				
		，原因： 		
	</div>
<div class="my-3">
		<a href="https://bbs.pediy.com/forum-150-1-155.htm" class="hidden-sm hidden-md small px-2 py-1 mr-2 " style="border-radius: 3px; background-color: #daf2ff; color: #0099ee;">#自动化挖掘</a>
		<a href="https://bbs.pediy.com/forum-150-1-157.htm" class="hidden-sm hidden-md small px-2 py-1 mr-2 " style="border-radius: 3px; background-color: #daf2ff; color: #0099ee;">#Fuzz</a>
		<a href="https://bbs.pediy.com/forum-150-1-161.htm" class="hidden-sm hidden-md small px-2 py-1 mr-2 " style="border-radius: 3px; background-color: #daf2ff; color: #0099ee;">#Linux</a>
	</div>					




						
						

						
						

						

					
					</div>

					

					<div>

					
					</div>

					

					<div style="height: 33px; line-height: 33px; border-top: 1px solid #ddd;">

						
						
					</div>

				</div>

			</div>

			

			<div id="collection_thumb" style="text-align:center;padding:5px 0px 30px; margin-bottom: 1rem;">

				<div style="width:auto;display:inline-block;">

					

					<div class="card_collection" style=" height: 65px;line-height:30px">

						<div>

							
							<a href="javascript:void(0);" class="d-inline-block favorite" style="border: 1px solid #DDDDDD; border-radius: 100%; width: 40px; height: 40px;line-height: 40px;">

								<i class="icon-star-o color4A4A4A"></i>

							</a>

							
						</div>

						<div>

							收藏

							<span class="likes_box likes_box_show" style="font-size: 13px;color: #0099ee;">・<span class="likes">25</span></span>

						</div>

					</div>

					<div class="card_collection" style=" height: 65px;line-height:30px">

						<div>

							
							<a href="javascript:void(0);" class="d-inline-block thumb" style="border: 1px solid #DDDDDD; border-radius: 100%; width: 40px; height: 40px;line-height: 40px;">

								<i class="icon-thumbs-o-up color4A4A4A"></i>

							</a>

							
							

						</div>

						<div>

							点赞<span class="thumbs_num_box" style="font-size: 13px;color: #0099ee;">・<span class="thumbs_num">7</span></span>

						</div>

						

					</div>

					<div class="card_collection" style=" height: 65px;line-height:30px">

							<div>

								<a href="javascript:void(0);" class="modal-title d-inline-block" id="exampleModalLabel" style="border: 1px solid #DDDDDD; border-radius: 100%; width: 40px; height: 40px;line-height: 40px;" data-toggle="modal" data-target=".reward">

									<i class="icon-rmb color4A4A4A"></i>

								</a>

							</div>

							<div>

								打赏

							</div>

					</div>

					<div class="card_collection position-relative" style=" height: 65px;line-height:30px">

						<div class="bbsshare_btn" style="cursor: pointer;">

							<div>

								<a href="javascript:void(0);" class="modal-title d-inline-block" style="border: 1px solid #DDDDDD; border-radius: 100%; width: 40px; height: 40px; line-height: 40px;">

									<i class="icon-share color4A4A4A"></i>

								</a>

							</div>

							<div>

								分享

							</div>

						</div>

						<div class="bd-bbsshare-modal-sm bbsshare_modal bg-white" style="display: none; width: 146px; box-shadow: 0 0 3px 0.5px #eee;">

							<div class="px-2 py-4">

								<div class="text-center" style="color: #5C5C5C;"><i class="icon icon-wechat "></i> 分享到微信</div>

								<div class="wechat_img py-2">

									<img src="./AFL二三事 -- 源码分析 1/bbs_qrcode-http_3A_2F_2Fbbs_2epediy_2ecom_2Fthread_2d269534_2ehtm.htm" style="width: 100%;">

								</div>

								<div onclick="shareTo(&#39;qq&#39;)" class="text-center" style="color: #5C5C5C; cursor: pointer;"><i class="icon icon-qq"></i> 分享到QQ</div>

								<!-- <div class="text-center" style="color: #5C5C5C; cursor: pointer;"><i class="icon icon-wechat"></i> 分享到空间</div> -->

								<div onclick="shareTo(&#39;sina&#39;)" class="text-center" style="color: #5C5C5C; cursor: pointer;"><i class="icon icon-weibo"></i> 分享到微博</div>

								

							</div>

						</div>

					</div>



				</div>

			</div>

		</div>

		                
                
                <!--赞赏支持-->
                <div class="modal fade reward" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                        <div class="modal-header">
                                            <h4 class="modal-title" id="exampleModalLabel">赞赏</h4>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">×</span>
                                            </button>
                                        </div>
                                        <form action="https://bbs.pediy.com/thread-269534.htm" method="post" id="pay_kx" onsubmit="return topay()">
                                                <div class="modal-body ">
                                                        <div class="form-group mb-0">
                                                                <input name="ureward" type="hidden" value="779730">
                                                                <input type="hidden" name="reward_articleid" value="269534">
                                                                <div class="mb-3 text-center">
                                                                    <img src="./AFL二三事 -- 源码分析 1/dashang.png" class="avatar-3" alt="100">
                                                                </div>
                                                                
                                                                <div class="text-center mb-3">
                                                                    <div data-toggle="buttons">
                                                                        <label class="btn btn-outline-danger active" style="width:120px">
                                                                            <input type="radio" class="d-none" value="1" name="reward_rmbs" id="option1" autocomplete="off" checked="">1 雪花
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" class="d-none" value="5" name="reward_rmbs" id="option3" autocomplete="off">5 雪花
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" class="d-none" value="10" name="reward_rmbs" id="option4" autocomplete="off">10 雪花
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" class="d-none" value="20" name="reward_rmbs" id="option5" autocomplete="off">20 雪花
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" class="d-none" value="50" name="reward_rmbs" id="option6" autocomplete="off">50 雪花
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" class="d-none" value="80" name="reward_rmbs" id="option6" autocomplete="off">80 雪花
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" class="d-none" value="100" name="reward_rmbs" id="option7" autocomplete="off">100 雪花
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" class="d-none" value="150" name="reward_rmbs" id="option7" autocomplete="off">150 雪花
                                                                        </label>
                                                                        <label class="btn btn-outline-danger" style="width:120px">
                                                                            <input type="radio" class="d-none" value="200" name="reward_rmbs" id="option8" autocomplete="off">200 雪花
                                                                        </label>
                                                                    </div>
                                                                </div>

                                                                <div>
                                                                    <label id="alipay_lab">
                                                                        <span>支付方式：</span>
                                                                        <input type="radio" value="1" checked="checked" name="reward_type" style="display:inline">
                                                                        <span class="alipay-bg"></span>
                                                                    </label>
                                                                    <label class="ml-3">
                                                                        <input type="radio" value="3" name="reward_type">
                                                                        <i class="icon icon-weixin" style="font-size:17px;color:#49BE38"></i> 微信支付
                                                                    </label>
                                                                                                                                    </div>
                                                        </div>
                                                </div>
                                                <div class="px-3 mb-3">
                                                    <div class="mb-2">赞赏留言：
                                                        <select class="form-control form-control-sm reward_reason d-inline-block" style="max-width: 90px;">
                                                            <option value="0">快捷留言</option>
                                                            <option value="感谢分享～">感谢分享～</option>
                                                            <option value="精品文章～">精品文章～</option>
                                                            <option value="原创内容～">原创内容～</option>
                                                            <option value="精彩转帖～">精彩转帖～</option>
                                                            <option value="助人为乐～">助人为乐～</option>
                                                            
                                                        </select>
                                                    </div>
                                                    <textarea class="form-control reward_reason_textarea" name="brief" rows="1"></textarea>
                                                    
                                                </div>
                                                <div class="modal-footer">
                                                        <button id="pay_submit" type="submit" class="btn btn-primary btn-pay kx-pay" data-loading-text="正在提交...">立即支付</button>
                                                </div>
                                        </form>
                                </div>
                        </div>
                </div>
		<div class="card p-1">

			<div class="card-body">

				<table class="table postlist mb-0">

					<thead>

						<tr>

							<th colspan="2" class="pa-0  pb-1">

								<dl class="row">

									<dt>

										<b>最新回复</b> (<span class="posts">3</span>)

									</dt>

									<dd style="text-align: right;">

										

										

										
										

									</dd>

								</dl>

							</th>

						</tr>

					</thead>

					<tbody>

					

														
				
																			
										
					

																													
										<tr class="post" data-pid="1700895">
						<td class="vtop td-avatar text-center" style="width: 46px;">
							<div class="position-relative avatar_hover">
								<a class="d-inline-block position-relative photo_frame photo_frame_image3" href="https://bbs.pediy.com/user-home-777502.htm" tabindex="-1">
									<img class="avatar-3" src="./AFL二三事 -- 源码分析 1/777502.png">
								</a>
								<div class="position-absolute thread-poptip-box bg-white text-left p-4">
									<div class="row mx-0">
										<a href="https://bbs.pediy.com/user-home-777502.htm">
										<img class="avatar-3" src="./AFL二三事 -- 源码分析 1/777502.png">
										</a>
										<div class="col">
											<div class="pb-2">
												<a href="https://bbs.pediy.com/user-home-777502.htm">
												<span style="font-size: 16px; font-weight: bolder;">pureGavin</span>
												</a>
											</div>
											<div class="pb-2 position-relative">
												<span class="small text-muted">雪&nbsp;&nbsp;&nbsp;&nbsp;币：</span>
												<span class="small text-muted">
													<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">
													9776													</a>
												</span>
											</div>
																																	<div class="pb-2 position-relative">
												<span class="small text-muted">活跃值：</span>
												<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">
												<img class="position-absolute huoyue_num" src="./AFL二三事 -- 源码分析 1/11.png" width="22" alt="活跃值">
												</a>
												<span class="small text-muted" style="margin-left: 25px;">(9831)</span>
											</div>
																						<div class="pb-2 small">
												<span class="small text-muted">能力值：</span>
												<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">
												<svg class="icon" aria-hidden="true">
													<use xlink:href="#icon-group_112"></use>
												</svg>
												</a>
												<img src="./AFL二三事 -- 源码分析 1/stars03.gif" alt="">
												<span class="small text-muted">( LV12，RANK：240 )</span>
												
											</div>
											<div class="pb-2" style="font-size: 0;">
												<span class="small text-muted" style="vertical-align: middle;">在线值：</span>
												<a href="https://bbs.pediy.com/thread-249442.htm">
													<span class="post_online_time" style="vertical-align: middle;" data-online_time="7713096" data-desc="2142 小时，  30 级"><img src="./AFL二三事 -- 源码分析 1/sun.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/moon.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/moon.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/moon.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/star.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/star.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"></span>
												</a>
												<span class="post_online_time1 text-muted small" style="vertical-align: middle;"></span>
											</div>
										</div>
										
									</div>
									
									<div class="pb-3 pt-2 row mx-0 text-muted small text-center">
										<div class="col">
											<div>发帖</div>
											<div>
												<a href="https://bbs.pediy.com/user-777502.htm" style="color: #0099ee;">
												58												</a>
											</div>
										</div>
										<div class="col">
											<div>回帖</div>
											<div>
												<a href="https://bbs.pediy.com/user-post-777502.htm" style="color: #0099ee;">
												1154</a></div><a href="https://bbs.pediy.com/user-post-777502.htm" style="color: #0099ee;">
												</a>
										</div>
										<div class="col">
											<div>粉丝</div>
											<div>
												<a href="https://bbs.pediy.com/user-fans-777502.htm" style="color: #0099ee;">
												135</a></div><a href="https://bbs.pediy.com/user-fans-777502.htm" style="color: #0099ee;">
												</a>
										</div>
										
										
									</div>
									<div class="row mx-0">
										<!--当前用户是否关注了$_post['user']['uid'] -->
																														<div class="col-6">
																							<a class="btn btn-0099ee w-100 follow_btn" data-cuid="777502">
													<i class="icon icon-plus"></i> 关注
												</a>
																						
										</div>
										<div class="col-6">
											<a href="https://www.kanxue.com/pm-send.htm?name=pureGavin" class="btn bg-white w-100" style="border: 1px solid #0099ee; color:#0099ee;">
												<i class="icon-envelope"></i>
												私信
											</a>
										</div>

									</div>
								</div>
							</div>
							<div class="mt-2">
								
								<svg class="icon" aria-hidden="true">
									<use xlink:href="#icon-group_112"></use>
								</svg>
							</div>
							<!-- <div class="text-grey text-tiny" style="height: 20px; text-align: center; margin-top: -9px; ">
								<div class="mb-3" style="position: relative;"><img style="position:absolute;left: -3px;" src="//bbs.pediy.com/view/img/stars03.gif" alt=""> </div>
							</div> -->
							
							
						</td>
						<td class="px-0">
							<dl class="row small">
								<dt>
									
									
									<div>
									<span class="username font-weight-bold">
										<a href="https://bbs.pediy.com/user-home-777502.htm">pureGavin</a>
										<img class="huoyue_num" src="./AFL二三事 -- 源码分析 1/11.png" width="22" alt="活跃值">
									</span>
																			<a href="https://bbs.pediy.com/user-777502-1-1.htm" class="d-inline-block" style="text-decoration: none; transform:scale(.8); -ms-transform:scale(.8); -webkit-transform:scale(.8);">
											<span class="icon-diamond text-danger" title="精华数"></span>
											<span class="font-weight-bold text-danger"> 2</span>
										</a>
																		<span class="date text-grey small ml-1">2021-9-27 22:33</span>
									</div>
									
								</dt>
								<dd class="text-right text-grey py-1">
									<div class="check_input_box d-inline-block"></div>
									<div class=" d-none d-lg-inline-block">
																													
																				
										
										
																			
										

	

										
																			</div>
																		<a href="https://bbs.pediy.com/thread-269534-1.htm#1700895" id="1700895" class="text-grey mr-3"><span class="floor">2</span> 楼</a>
																			<div class="reply_thumb" style="display: inline-block;">
		<input type="hidden" value="269534" name="threadid">
		<input type="hidden" value="777502" name="praised_uid">
		<input type="hidden" value="1700895" name="pid">
		<a href="javascript:void(0)" class="text-grey">
						<i class="icon-thumbs-o-up"></i>
					</a>
		<span class="thumb_num" style="margin-left:5px">0</span>
	</div>
									<style>
										.mobile_more_operate_btn {
											padding: 0px 4px; 
											background: #dee5ea; 
											border-radius: 0.2rem; 
											cursor: pointer;
										}
										.mobile_more_operate {
											display: none; 
											left: -195px; 
											top: -13px; 
											width: 185px; 
											background: #222222; 
											border-radius: 0.3rem;
										}
										.mobile_more_operate_box .post_report {
											color: #fff!important;
										}
									</style>
										
								</dd>
							</dl>
							<!-- <div></div> -->
							<div class="message mt-1 break-all">
																								老毒一出手，就知有没有								
																																
								
							</div>
						</td>
					</tr>
																			
										
					

																													
										<tr class="post" data-pid="1700896">
						<td class="vtop td-avatar text-center" style="width: 46px;">
							<div class="position-relative avatar_hover">
								<a class="d-inline-block position-relative photo_frame photo_frame_image3" href="https://bbs.pediy.com/user-home-93.htm" tabindex="-1">
									<img class="avatar-3" src="./AFL二三事 -- 源码分析 1/93.png">
								</a>
								<div class="position-absolute thread-poptip-box bg-white text-left p-4">
									<div class="row mx-0">
										<a href="https://bbs.pediy.com/user-home-93.htm">
										<img class="avatar-3" src="./AFL二三事 -- 源码分析 1/93.png">
										</a>
										<div class="col">
											<div class="pb-2">
												<a href="https://bbs.pediy.com/user-home-93.htm">
												<span style="font-size: 16px; font-weight: bolder;">kanxue</span>
												</a>
											</div>
											<div class="pb-2 position-relative">
												<span class="small text-muted">雪&nbsp;&nbsp;&nbsp;&nbsp;币：</span>
												<span class="small text-muted">
													<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">
													651													</a>
												</span>
											</div>
																																	<div class="pb-2 position-relative">
												<span class="small text-muted">活跃值：</span>
												<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">
												<img class="position-absolute huoyue_num" src="./AFL二三事 -- 源码分析 1/11.png" width="22" alt="活跃值">
												</a>
												<span class="small text-muted" style="margin-left: 25px;">(10718)</span>
											</div>
																						<div class="pb-2 small">
												<span class="small text-muted">能力值：</span>
												<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">
												<svg class="icon" aria-hidden="true">
													<use xlink:href="#icon-group_1"></use>
												</svg>
												</a>
												<img src="./AFL二三事 -- 源码分析 1/stars05.gif" alt="">
												<span class="small text-muted">(RANK：350 )</span>
												
											</div>
											<div class="pb-2" style="font-size: 0;">
												<span class="small text-muted" style="vertical-align: middle;">在线值：</span>
												<a href="https://bbs.pediy.com/thread-249442.htm">
													<span class="post_online_time" style="vertical-align: middle;" data-online_time="102005087" data-desc="28334 小时，  117 级"><img src="./AFL二三事 -- 源码分析 1/king.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/sun.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/sun.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/sun.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/moon.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/star.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"></span>
												</a>
												<span class="post_online_time1 text-muted small" style="vertical-align: middle;"></span>
											</div>
										</div>
										
									</div>
									
									<div class="pb-3 pt-2 row mx-0 text-muted small text-center">
										<div class="col">
											<div>发帖</div>
											<div>
												<a href="https://bbs.pediy.com/user-93.htm" style="color: #0099ee;">
												2333												</a>
											</div>
										</div>
										<div class="col">
											<div>回帖</div>
											<div>
												<a href="https://bbs.pediy.com/user-post-93.htm" style="color: #0099ee;">
												16723</a></div><a href="https://bbs.pediy.com/user-post-93.htm" style="color: #0099ee;">
												</a>
										</div>
										<div class="col">
											<div>粉丝</div>
											<div>
												<a href="https://bbs.pediy.com/user-fans-93.htm" style="color: #0099ee;">
												328</a></div><a href="https://bbs.pediy.com/user-fans-93.htm" style="color: #0099ee;">
												</a>
										</div>
										
										
									</div>
									<div class="row mx-0">
										<!--当前用户是否关注了$_post['user']['uid'] -->
																														<div class="col-6">
																							<a class="btn btn-0099ee w-100 follow_btn" data-cuid="93">
													<i class="icon icon-plus"></i> 关注
												</a>
																						
										</div>
										<div class="col-6">
											<a href="https://www.kanxue.com/pm-send.htm?name=kanxue" class="btn bg-white w-100" style="border: 1px solid #0099ee; color:#0099ee;">
												<i class="icon-envelope"></i>
												私信
											</a>
										</div>

									</div>
								</div>
							</div>
							<div class="mt-2">
								
								<svg class="icon" aria-hidden="true">
									<use xlink:href="#icon-group_1"></use>
								</svg>
							</div>
							<!-- <div class="text-grey text-tiny" style="height: 20px; text-align: center; margin-top: -9px; ">
								<div class="mb-3" style="position: relative;"><img style="position:absolute;left: -3px;" src="//bbs.pediy.com/view/img/stars05.gif" alt=""> </div>
							</div> -->
							
							
						</td>
						<td class="px-0">
							<dl class="row small">
								<dt>
									
									
									<div>
									<span class="username font-weight-bold">
										<a href="https://bbs.pediy.com/user-home-93.htm">kanxue</a>
										<img class="huoyue_num" src="./AFL二三事 -- 源码分析 1/11.png" width="22" alt="活跃值">
									</span>
																			<a href="https://bbs.pediy.com/user-93-1-1.htm" class="d-inline-block" style="text-decoration: none; transform:scale(.8); -ms-transform:scale(.8); -webkit-transform:scale(.8);">
											<span class="icon-diamond text-danger" title="精华数"></span>
											<span class="font-weight-bold text-danger"> 8</span>
										</a>
																		<span class="date text-grey small ml-1">2021-9-27 22:40</span>
									</div>
									
								</dt>
								<dd class="text-right text-grey py-1">
									<div class="check_input_box d-inline-block"></div>
									<div class=" d-none d-lg-inline-block">
																													
																				
										
										
																			
										

	

										
																			</div>
																		<a href="https://bbs.pediy.com/thread-269534-1.htm#1700896" id="1700896" class="text-grey mr-3"><span class="floor">3</span> 楼</a>
																			<div class="reply_thumb" style="display: inline-block;">
		<input type="hidden" value="269534" name="threadid">
		<input type="hidden" value="93" name="praised_uid">
		<input type="hidden" value="1700896" name="pid">
		<a href="javascript:void(0)" class="text-grey">
						<i class="icon-thumbs-o-up"></i>
					</a>
		<span class="thumb_num" style="margin-left:5px">0</span>
	</div>
									<style>
										.mobile_more_operate_btn {
											padding: 0px 4px; 
											background: #dee5ea; 
											border-radius: 0.2rem; 
											cursor: pointer;
										}
										.mobile_more_operate {
											display: none; 
											left: -195px; 
											top: -13px; 
											width: 185px; 
											background: #222222; 
											border-radius: 0.3rem;
										}
										.mobile_more_operate_box .post_report {
											color: #fff!important;
										}
									</style>
										
								</dd>
							</dl>
							<!-- <div></div> -->
							<div class="message mt-1 break-all">
																								厉害！感谢分享！								
																																
								
							</div>
						</td>
					</tr>
																			
										
					

																													
										<tr class="post" data-pid="1700919">
						<td class="vtop td-avatar text-center" style="width: 46px;">
							<div class="position-relative avatar_hover">
								<a class="d-inline-block position-relative photo_frame photo_frame_image3" href="https://bbs.pediy.com/user-home-779730.htm" tabindex="-1">
									<img class="avatar-3" src="./AFL二三事 -- 源码分析 1/779730.png">
								</a>
								<div class="position-absolute thread-poptip-box bg-white text-left p-4">
									<div class="row mx-0">
										<a href="https://bbs.pediy.com/user-home-779730.htm">
										<img class="avatar-3" src="./AFL二三事 -- 源码分析 1/779730.png">
										</a>
										<div class="col">
											<div class="pb-2">
												<a href="https://bbs.pediy.com/user-home-779730.htm">
												<span style="font-size: 16px; font-weight: bolder;">有毒</span>
												</a>
											</div>
											<div class="pb-2 position-relative">
												<span class="small text-muted">雪&nbsp;&nbsp;&nbsp;&nbsp;币：</span>
												<span class="small text-muted">
													<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">
													15172													</a>
												</span>
											</div>
																																	<div class="pb-2 position-relative">
												<span class="small text-muted">活跃值：</span>
												<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">
												<img class="position-absolute huoyue_num" src="./AFL二三事 -- 源码分析 1/12.png" width="22" alt="活跃值">
												</a>
												<span class="small text-muted" style="margin-left: 25px;">(13838)</span>
											</div>
																						<div class="pb-2 small">
												<span class="small text-muted">能力值：</span>
												<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">
												<svg class="icon" aria-hidden="true">
													<use xlink:href="#icon-group_4"></use>
												</svg>
												</a>
												<img src="./AFL二三事 -- 源码分析 1/stars04.gif" alt="">
												<span class="small text-muted">(RANK：730 )</span>
												
											</div>
											<div class="pb-2" style="font-size: 0;">
												<span class="small text-muted" style="vertical-align: middle;">在线值：</span>
												<a href="https://bbs.pediy.com/thread-249442.htm">
													<span class="post_online_time" style="vertical-align: middle;" data-online_time="2942945" data-desc="817 小时，  18 级"><img src="./AFL二三事 -- 源码分析 1/sun.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/star.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/star.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"></span>
												</a>
												<span class="post_online_time1 text-muted small" style="vertical-align: middle;"></span>
											</div>
										</div>
										
									</div>
									
									<div class="pb-3 pt-2 row mx-0 text-muted small text-center">
										<div class="col">
											<div>发帖</div>
											<div>
												<a href="https://bbs.pediy.com/user-779730.htm" style="color: #0099ee;">
												54												</a>
											</div>
										</div>
										<div class="col">
											<div>回帖</div>
											<div>
												<a href="https://bbs.pediy.com/user-post-779730.htm" style="color: #0099ee;">
												437</a></div><a href="https://bbs.pediy.com/user-post-779730.htm" style="color: #0099ee;">
												</a>
										</div>
										<div class="col">
											<div>粉丝</div>
											<div>
												<a href="https://bbs.pediy.com/user-fans-779730.htm" style="color: #0099ee;">
												250</a></div><a href="https://bbs.pediy.com/user-fans-779730.htm" style="color: #0099ee;">
												</a>
										</div>
										
										
									</div>
									<div class="row mx-0">
										<!--当前用户是否关注了$_post['user']['uid'] -->
																														<div class="col-6">
																							<a class="btn btn-0099ee w-100 follow_btn" data-cuid="779730">
													<i class="icon icon-plus"></i> 关注
												</a>
																						
										</div>
										<div class="col-6">
											<a href="https://www.kanxue.com/pm-send.htm?name=%E6%9C%89%E6%AF%92" class="btn bg-white w-100" style="border: 1px solid #0099ee; color:#0099ee;">
												<i class="icon-envelope"></i>
												私信
											</a>
										</div>

									</div>
								</div>
							</div>
							<div class="mt-2">
								
								<svg class="icon" aria-hidden="true">
									<use xlink:href="#icon-group_4"></use>
								</svg>
							</div>
							<!-- <div class="text-grey text-tiny" style="height: 20px; text-align: center; margin-top: -9px; ">
								<div class="mb-3" style="position: relative;"><img style="position:absolute;left: -3px;" src="//bbs.pediy.com/view/img/stars04.gif" alt=""> </div>
							</div> -->
							
							
						</td>
						<td class="px-0">
							<dl class="row small">
								<dt>
									
									
									<div>
									<span class="username font-weight-bold">
										<a href="https://bbs.pediy.com/user-home-779730.htm">有毒</a>
										<img class="huoyue_num" src="./AFL二三事 -- 源码分析 1/12.png" width="22" alt="活跃值">
									</span>
																			<a href="https://bbs.pediy.com/user-779730-1-1.htm" class="d-inline-block" style="text-decoration: none; transform:scale(.8); -ms-transform:scale(.8); -webkit-transform:scale(.8);">
											<span class="icon-diamond text-danger" title="精华数"></span>
											<span class="font-weight-bold text-danger"> 10</span>
										</a>
																		<span class="date text-grey small ml-1">2021-9-28 10:02</span>
									</div>
									
								</dt>
								<dd class="text-right text-grey py-1">
									<div class="check_input_box d-inline-block"></div>
									<div class=" d-none d-lg-inline-block">
																													
																				
										
										
																			
										

	

										
																			</div>
																		<a href="https://bbs.pediy.com/thread-269534-1.htm#1700919" id="1700919" class="text-grey mr-3"><span class="floor">4</span> 楼</a>
																			<div class="reply_thumb" style="display: inline-block;">
		<input type="hidden" value="269534" name="threadid">
		<input type="hidden" value="779730" name="praised_uid">
		<input type="hidden" value="1700919" name="pid">
		<a href="javascript:void(0)" class="text-grey">
						<i class="icon-thumbs-o-up"></i>
					</a>
		<span class="thumb_num" style="margin-left:5px">0</span>
	</div>
									<style>
										.mobile_more_operate_btn {
											padding: 0px 4px; 
											background: #dee5ea; 
											border-radius: 0.2rem; 
											cursor: pointer;
										}
										.mobile_more_operate {
											display: none; 
											left: -195px; 
											top: -13px; 
											width: 185px; 
											background: #222222; 
											border-radius: 0.3rem;
										}
										.mobile_more_operate_box .post_report {
											color: #fff!important;
										}
									</style>
										
								</dd>
							</dl>
							<!-- <div></div> -->
							<div class="message mt-1 break-all">
																								<blockquote class="blockquote">

		<a href="https://bbs.pediy.com/user-777502.htm" class="text-small text-muted user">

			<img class="avatar-1" src="./AFL二三事 -- 源码分析 1/777502.png" style="cursor: pointer;">

			pureGavin

		</a>

		老毒一出手，就知有没有

		</blockquote>你这个可太秀了<img src="./AFL二三事 -- 源码分析 1/78.gif" class="face" style="cursor: pointer;">								
																																
								
							</div>
						</td>
					</tr>
								
				
						

						
							<tr class="post">

								<td class="td-avatar" aria-hidden="true">

									<a href="https://bbs.pediy.com/user-705338.htm" aria-hidden="true" tabindex="-1">

										<img class="avatar-3" src="./AFL二三事 -- 源码分析 1/avatar.png">

									</a>

								</td>

								<td class="p-l-0">

									<form action="https://bbs.pediy.com/thread-269534.htm" method="post" id="quick_reply_form">	

										

										<dl class="row small text-muted">

											<dt class="username">游客</dt>

											<dd class="text-right text-grey"></dd>

										</dl>

										<div class="message mt-1">

											<div style=" border-radius: 0.25rem; border: 1px solid #ced4da;">

												<div class="text-center small py-3">

													<a href="https://passport.kanxue.com/user-login.htm" class="small">登录</a>&nbsp;|&nbsp;<a href="https://passport.kanxue.com/user-mobile.htm" class="small">注册</a>&nbsp;方可回帖

												</div>

											</div>

										</div>

										<div class="text-muted mt-3 small face_open">

											<dl class="row">

												<dt>

													<a class="btn btn-primary btn-sm" href="https://passport.kanxue.com/user-login.htm" role="button">　回帖　</a>

													

													<span class="emotion ml-3">表情</span>

													<span class="ml-3 d-none d-lg-inline-block"><a href="https://bbs.pediy.com/thread-247709.htm" target="_bank" style="color: #0099ee;">雪币赚取及消费</a></span>

												</dt>

												<dd class="text-right vtop">

													

													<a class="icon-mail-reply text-muted" href="https://passport.kanxue.com/user-login.htm" id="advanced_reply"> 高级回复</a>

													

												</dd>

											</dl>

										</div>

									</form>

								</td>

							</tr>

						
					</tbody>

				</table>

			</div>

		</div>

		

		

		
		

		

		

		
		

		
		

		<a role="button" class="btn btn-secondary btn-block xn-back my-3 mx-auto" style="max-width: 50%;" href="javascript:history.back();">返回</a>

	</div>

	<div class="col-3 pr-0 hidden-sm hidden-md" style="padding-left: 15px;min-height: 850px;">

		<div class="positionSticky position-sticky" style="top:0;">

			<div class="rightbox_card_hidden">

				<div class="card mb-3 position-relative ">

					<div class="py-4 px-4">

						<div class="row mx-0">

							<a class="d-inline-block position-relative photo_frame photo_frame_image3" href="https://bbs.pediy.com/user-home-779730.htm" aria-hidden="true" tabindex="-1">

								<img src="./AFL二三事 -- 源码分析 1/779730.png" style="width: 5rem; height:  5rem; border-radius: 5rem;">

							</a>

							<div class="col pr-0">

								<div>

									<span style="font-size: 16px;" class="font-weight-bold">

										<a href="https://bbs.pediy.com/user-home-779730.htm">有毒</a>

									</span>

									
										<div class="d-inline-block" style="font-size: 1rem; transform:scale(.8); -ms-transform:scale(.8); -webkit-transform:scale(.8);">

											<a href="https://bbs.pediy.com/user-779730-1-1.htm">

												<span class="icon-diamond text-danger" title="精华数"></span>

												<span class="font-weight-bold text-danger"> 10</span>

											</a>

										</div>

									
								</div>

								<div class="mt-1">

									<img class="huoyue_num" src="./AFL二三事 -- 源码分析 1/12.png" width="22" alt="活跃值">

									<a href="https://bbs.pediy.com/thread-260144.htm" class="text-muted">

										<svg class="icon" aria-hidden="true">

											<use xlink:href="#icon-group_4"></use>

										</svg>

									</a>

									<img src="./AFL二三事 -- 源码分析 1/stars04.gif" alt="">

								</div>

								<div class="mt-1">

									<span class="post_online_time" style="vertical-align: middle;" data-online_time="2942945" data-desc="817 小时，  18 级" onmouseenter="show_online_level(event)"><img src="./AFL二三事 -- 源码分析 1/sun.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/star.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"><img src="./AFL二三事 -- 源码分析 1/star.gif" width="13" height="13" style="opacity: 0.65; margin-right: 2px;"></span>



								</div>

							</div>

						</div>

						<div class="row mx-0 my-4 text-center">

							<div class="col px-0">

								<div style="color: #0099ee; font-size: 16px;">

									<a href="https://bbs.pediy.com/user-779730.htm" style="color: #0099ee;" target="_blank">

										54
									</a>

								</div>

								<div class="small" style="color: #888888;">发帖</div>

							</div>

							<div class="col px-0">

								<div style="color: #0099ee; font-size: 16px;">

									<a href="https://bbs.pediy.com/user-post-779730.htm" style="color: #0099ee;" target="_blank">

									437
									</a>

								</div>

								<div class="small" style="color: #888888;">回帖</div>

							</div>

							<div class="col px-0">

								<div style="color: #0099ee; font-size: 16px;">

									<a href="https://bbs.pediy.com/thread-260144.htm" style="color: #0099ee;" target="_blank">

										730
									</a>

								</div>

								<div class="small" style="color: #888888;">RANK</div>

							</div>

						</div>

						<div class="px-1 row mx-0">

							<div class="col-6">

								
								<a class="btn btn-0099ee w-100 follow_btn py-1" data-cuid="779730">

									<i class="icon icon-plus"></i> 关注

								</a>

								
							</div>

							<div class="col-6">

								<a href="https://www.kanxue.com/pm-send.htm?name=%E6%9C%89%E6%AF%92" class="btn bg-white w-100 py-1" style="border: 1px solid #0099ee; color:#0099ee;">

									<i class="icon-envelope"></i>

									私信

								</a>

							</div>



						</div>				

					</div>

				</div>

				

				<div class="card mb-3 py-2 show_tocbot " style="display: block;">

					<div id="js-toc" class="js-toc"><ol class="toc-list "><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h1_0" class="toc-link node-name--H1 ">AFL二三事 —— 源码分析 1</a><ol class="toc-list  is-collapsible"><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h2_0" class="toc-link node-name--H2 ">前言</a></li><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h2_1" class="toc-link node-name--H2 ">宏观</a></li><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h2_2" class="toc-link node-name--H2 ">一、AFL 的 gcc —— afl-gcc.c</a><ol class="toc-list  is-collapsible is-collapsed"><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h3_0" class="toc-link node-name--H3 ">1. 概述</a></li><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h3_1" class="toc-link node-name--H3 ">2. 源码</a></li></ol></li><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h2_3" class="toc-link node-name--H2 ">二、AFL 的源码插桩 —— afl-as.c</a><ol class="toc-list  is-collapsible"><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h3_2" class="toc-link node-name--H3 ">1. 概述</a></li><li class="toc-list-item is-active-li"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h3_3" class="toc-link node-name--H3  is-active-link">2. 源码</a></li><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h3_4" class="toc-link node-name--H3 ">3. instrumentation trampoline 和 main_payload</a></li></ol></li><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h2_4" class="toc-link node-name--H2 ">三、总结</a></li><li class="toc-list-item"><a href="https://bbs.pediy.com/thread-269534.htm#msg_header_h2_5" class="toc-link node-name--H2 ">参考文献：</a></li></ol></li></ol></div>

				</div>

			</div>

			<div class="card mb-3 pb-3" style="color: #bbbbbb;">

				<div class="py-2 px-3 mb-2" style="color: #333333;border-bottom: 1px solid #eeeeee;">

					他的文章

				</div>

				<div class="px-3">

					
					<div class="mb-2">

						<a href="https://bbs.pediy.com/thread-271654.htm" style="color: #7d7d7d; font-size: 13px;">[注意] 2022看雪二进制漏洞小组成立通告</a>

						<i class="icon icon-eye small"> 13172</i>

					</div>

					
					<div class="mb-2">

						<a href="https://bbs.pediy.com/thread-270995.htm" style="color: #7d7d7d; font-size: 13px;">[分享]我和看雪的故事 -- by 有毒</a>

						<i class="icon icon-eye small"> 24296</i>

					</div>

					
					<div class="mb-2">

						<a href="https://bbs.pediy.com/thread-270457.htm" style="color: #7d7d7d; font-size: 13px;">[原创]多版本gcc/g++共存方案</a>

						<i class="icon icon-eye small"> 18372</i>

					</div>

					
					<div class="mb-2">

						<a href="https://bbs.pediy.com/thread-270106.htm" style="color: #7d7d7d; font-size: 13px;">[原创]协议Fuzz工具整合</a>

						<i class="icon icon-eye small"> 30493</i>

					</div>

					
					<div class="mb-2">

						<a href="https://bbs.pediy.com/thread-269885.htm" style="color: #7d7d7d; font-size: 13px;">[原创]利用Lighthouse进行覆盖率统计及其优化</a>

						<i class="icon icon-eye small"> 18817</i>

					</div>

					
					

				</div>

			</div>

			
		    <div class="bg-white mb-3 position-relative">

				<a id="thread_ad" data-thread_postdata="2_19_15" data-href="https://bbs.pediy.com/thread-265424.htm" href="javascript:void(0);">

					<img src="./AFL二三事 -- 源码分析 1/202102021340_DX5RA3QXUFDGEAM.jpg" class="w-100" alt="">

					<span id="diff_day" class="position-absolute" style="bottom: 1.6rem; left: 5rem; font-size: 40px; color: #00dfff;"></span>

				</a>

			</div>

			
			<div class="card mb-3 px-2 py-3">

				<div class="row mx-0 text-center small pb-3" style="border-bottom: 1px solid #ececec;">

					<div class="col-4 px-0" style="border-right: 1px solid #ececec;"><a class="text-muted" href="https://zhuanlan.kanxue.com/article-56.htm">关于我们</a></div>

					<div class="col-4 px-0" style="border-right: 1px solid #ececec;"><a class="text-muted" href="https://www.kanxue.com/user-online_sendmsg.htm">联系我们</a></div>

					<div class="col-4 px-0"><a class="text-muted" href="https://qifu.kanxue.com/">企业服务</a></div>

				</div>

				<div class="pt-3 small">

					<img src="./AFL二三事 -- 源码分析 1/gongzhonghao.png" style="max-width: 80px; float: left;" alt="">

					<div class="px-2 py-2 text-muted" style="overflow: hidden;">

						<div>看雪公众号</div>

						<div>专注于PC、移动、智能设备安全研究及逆向工程的开发者社区</div>

					</div>

				</div>

			</div>

		</div>

	</div>

</div>

<!--谁下载-->

<div class="container px-0 pb-3">
<div class="row mx-0 bbs_footer_at_column hidden-sm hidden-md" style="text-align: center; height: 76px;">
    <div class="col-md-6 px-0" style="height: 100%;">
    <a href="https://bbs.pediy.com/thread-271749.htm" style="height: 100%;" target="_blank">
    <!-- <p></p > -->
    <img src="./AFL二三事 -- 源码分析 1/202201271505_56HN98ZCWRUNJFU.jpg" width="100%" height="100%">

    </a>
    </div>
    <div class="col-md-6 px-0" style="height: 100%;">
    <a href="https://meet.kanxue.com/kxmeet-6.htm" style="height: 100%;" target="_blank">
    <!-- <p></p > -->
    <img src="./AFL二三事 -- 源码分析 1/202201171026_KMWU55A9MMYFBMT.jpg" width="100%" height="100%">
    </a>
    </div>
</div>
</div>

</div>

</main>


<footer id="footer" style="background: #3b4348; color: #9ba4aa; height: auto;">
	<div class="container">
		<div class="row text-muted small my-3 mx-0" id="web_base_company_information">
			<div class="col-12 col-md-6">
				©2000-2022 看雪 | Based on <a href="http://bbs.xiuno.com/" target="_blank" class="text-muted">Xiuno BBS</a><br>
				域名：<a href="https://www.yunaq.com/" target="_blank" class="text-muted">加速乐</a> |
				SSL证书：<a href="https://www.trustasia.com/trustasia" target="_blank" class="text-muted">亚洲诚信</a> |
				<a href="http://dun.163.com/?from=kanxue_DDoS_2018&amp;hmsr=kanxue%C2%A0" target="_blank" class="text-muted">安全网易易盾</a>|
				<a href="https://x.tongdun.cn/" target="_blank" class="text-muted">同盾反欺诈</a>

			</div>
			<div class="col-12 col-md-6 pt-2 pt-md-0 text-md-right">
				
				<span><a class="text-muted" href="https://ce.kanxue.com/project-test_read-538.htm">看雪SRC</a></span> |
				<span><a class="text-muted" href="https://bbs.pediy.com/thread-260116.htm">看雪APP</a></span> |
				<span>公众号：ikanxue</span> |
				<a class="text-muted" href="https://zhuanlan.kanxue.com/article-56.htm">关于我们</a> |
				<a class="text-muted" href="https://www.kanxue.com/user-online_sendmsg.htm">联系我们</a> |
				<a href="https://zhuanlan.kanxue.com/article-1.htm" class="text-muted">企业服务</a> <br>
				Processed: <b>0.017</b>s, SQL:
				<b>30</b> / <a class="text-muted" href="http://beian.miit.gov.cn/" target="_blank">沪ICP备2022023406号-3</a> / <a class="text-muted" href="http://www.beian.gov.cn/portal/registerSystemInfo?domainname=%27pediy.com%27&amp;recordcode=31011502006611" target="_blank">沪公网安备31011502006611号</a>

			</div>
		</div>
		<div style="max-height: 100px; overflow-y:auto;">
					</div>
	</div>
</footer>



<!--[if lt IE 9]>
	<script>window.location = 'browser.htm';</script>
	<![endif]-->




<div class="act_go_top" style="position: fixed; bottom: 80px; right: 10px; z-index: 99; width: 70px; height: 70px;">
	<a href="javascript:;" style="width: 70px; height: 70px; display: inline-block;background: url(/view/img/scroll_top.png) no-repeat; _background: url(/view/img/scroll_top.png) no-repeat; outline: none;" title="返回顶部"></a>
</div>




<script src="./AFL二三事 -- 源码分析 1/bbs.js"></script>
<script src="./AFL二三事 -- 源码分析 1/jquery-3.1.0.js"></script>
<script src="./AFL二三事 -- 源码分析 1/popper.js"></script>
<script src="./AFL二三事 -- 源码分析 1/bootstrap.js"></script>
<script src="./AFL二三事 -- 源码分析 1/xiuno.js"></script>
<script src="./AFL二三事 -- 源码分析 1/storagePlus.js"></script>
<script src="./AFL二三事 -- 源码分析 1/bootstrap-plugin.js"></script><script language="javascript" src="./AFL二三事 -- 源码分析 1/layer.js"></script>
<script src="./AFL二三事 -- 源码分析 1/async.js"></script>
<script src="./AFL二三事 -- 源码分析 1/form.js"></script>

<script>
	// 用于个人中心 判断路由 center ，还是 pm
	var debug = DEBUG = 0;
	var url_rewrite_on = 1;
	var forumarr = {
    "177": "x64dbg插件区",
    "52": "OllyDbg插件区",
    "53": "IDA Pro插件区",
    "4": "软件逆向",
    "69": "经典问答",
    "102": "科锐培训",
    "141": "CrackMe存档区",
    "152": "学习园地",
    "2": "论坛版务",
    "76": "1)珠海金山2007逆向分析挑战赛",
    "99": "《加密与解密(第4版)》",
    "169": "15PB培训",
    "125": "奇虎360软件安全大赛答案提交区",
    "21": "《软件加密技术内幕》",
    "68": "2)PEDIY Crackme竞赛2007",
    "41": "编程技术",
    "95": "《0day:软件漏洞分析技术》",
    "88": "加壳脱壳",
    "91": "3)2008 Exploit Me挑战赛",
    "158": "前沿科技",
    "3": "桌面平台",
    "120": "4)腾讯公司2008软件安全竞赛",
    "132": "密码应用",
    "123": "《微软.NET程序的加密与解密》",
    "127": "5)奇虎360软件安全比赛",
    "37": "CTF对抗",
    "140": "6)PEDIY Crackme竞赛2009",
    "116": "CTF",
    "150": "二进制漏洞",
    "163": "《C++反汇编与逆向分析技术》",
    "108": "企业建设",
    "155": "7)腾讯公司2010软件安全竞赛",
    "168": "《Android安全与逆向分析》",
    "157": "8)2011 Exploit Me赛",
    "121": "9）移动安全挑战赛（MSC）",
    "129": "10）第2届移动安全挑战（MSC）",
    "136": "职场生活",
    "45": "茶余饭后",
    "97": "问答版块",
    "161": "Android安全",
    "1": "站务管理/产品",
    "10": "资源下载",
    "128": "智能设备",
    "137": "职业生涯",
    "151": "WEB安全",
    "171": "Pwn",
    "20": "¥付费问答",
    "32": "外文翻译",
    "47": "招聘专区",
    "162": "企业安全",
    "166": "iOS安全",
    "65": "图书项目",
    "174": "International  vision",
    "172": "区块链安全",
    "173": "KSA软件",
    "178": "HarmonyOS"
};
	var fid = 150;
	var uid = 0;
	var gid = 0;
	$('[data-toggle="tooltip"]').tooltip();
	$('#search_form > input').on('click', function () {
		return false;
	});
</script>

<script src="./AFL二三事 -- 源码分析 1/bbs(1).js"></script>

<script>
// 版主管理：精华
$('.mod-button button.digest').on('click', function() {
	var modtid = $('input[name="modtid"]').checked();
	if(modtid.length == 0) return $.alert(lang.please_choose_thread);
	var radios = xn.form_radio('digest', {"0": "取消精华", "1": "关注","2": "优秀", "3": "精华"});
	var radios2 = xn.form_radio('skill_type', {"0":"无", "7": "Reverse", "1": "PWN","2": "App", "3": "Web", "4": "IoT", "5":"Develop", "6":"MISC"});
	$.confirm("设置主题为精华", function() {
		var tids = xn.implode('_', modtid);
		var digest = $('input[name="digest"]').checked();
		var skill_type = $('input[name="skill_type"]').checked();
		var postdata = {digest: digest, skill_type:skill_type};
		
		$.xpost(xn.url('mod-digest-'+tids), postdata, function(code, message) {

			if(code != 0) return $.alert(message);
			// $.alert(message).delay(1000).location('');

			if(digest != 0){
				if(window.confirm('设置成功，是否入库?')){
					$.alert('请稍等文库打开中...');
					$('.chm_in').trigger('click');
				}else{
					location.reload();
				}
				// $.confirm("设置成功，是否入库", function() {
					
				// 	$.alert('设置成功，请稍等文库打开中...');

				// });
				// $.alert('设置成功，请稍等文库打开中...');
				// $('.chm_in').trigger('click');
			}else{
				$.alert(message).delay(1000).location('');
			}


		});
	}, {'body': '<p>'+"精华等级"+'：'+radios+'<br>技能方向：'+radios2+'</p>'});
})
</script><script>
function xn_read_unread(tids, tid) {
	
	// 当前时间
	var time = xn.time();
	
	// 多长时间内的主题为最新主题
	var time_range = 86400 * 3;
	
	// 三天内的 tids
	var recent_tids = $.pdata('recent_tids') || {};
	
	// 已读的 tids
	var view_tids = $.pdata('view_tids') || {};
	// 提取列表页的 tid
	function fetch_recent_tids(tids) {
		var changed = false;
		$.each(tids, function(tid, last_date) {
			if(time - last_date < time_range) {
				recent_tids[tid] = last_date;
				changed = true;
			}
		});
		if(changed) $.pdata('recent_tids', recent_tids);
	}
	
	// 清理最近的 tid
	function gc_recent_tids() {
		var changed = false;
		$.each(recent_tids, function(tid, last_date) {
			if(time - last_date > time_range) {
				delete recent_tids[tid];
				changed = true;
			}
		});
		if(changed) $.pdata('recent_tids', recent_tids);
	}
	
	function gc_view_tids() {
		var changed = false;
		$.each(view_tids, function(tid, last_date) {
			if(!recent_tids[tid]) {
				delete view_tids[tid];
				changed = true;
			}
		});
		if(changed) $.pdata('view_tids', view_tids);
	}
	
	function save_view_tid(tid) {
		if(!recent_tids[tid]) return;
		view_tids[tid] = time;
		$.pdata('view_tids', view_tids);
	}
	
	if(tids) {
		fetch_recent_tids(tids);
		gc_recent_tids();
		//gc_view_tids();
	}
	if(tid) save_view_tid(tid);
	
	// 三天内的主题标记为已读
	
	// 遍历主题列表，标记最近的，并且未读的为加粗

	$('.thread').each(function() {
		var jthis = $(this);
		var tid = jthis.attr('tid') || jthis.data('tid');
		if(recent_tids[tid] && recent_tids[tid] > xn.intval(view_tids[tid])) {
			//jthis.find('div.subject').addClass('font-weight-bold');
			jthis.find('div.subject').append('<span class="icon-new"></span>');
			jthis.find('span.icon-post-grey').removeClass('icon-post-grey').addClass('icon-post-blue');
		}
	});

	// 首页未读
	$('.bbs_home_page_row_div').each(function() {
		var jthis = $(this);
		var tid = jthis.attr('tid') || jthis.data('tid');
		if(recent_tids[tid] && recent_tids[tid] > xn.intval(view_tids[tid])) {
			jthis.find('span.icon-post-grey').removeClass('icon-post-grey').addClass('icon-post-blue');
		}
	});
	// 列表页未读
	// ···
	// ···
	// ···
}

</script>

<script type="text/javascript">
	$(function () {
		setTimeout(function () {
			$.require('https://www.google-analytics.com/ga.js', function () {
				try {
					var pageTracker = _gat._getTracker("UA-9784446-1");
					pageTracker._trackPageview();
				} catch (err) {}
			});
		}, 1000);

		setTimeout(function () {
			$(".bbs_home_page_three_col .small_logo").each(function (index, element) {

				if ($(element).children("a").length == 0) {
					$(".bbs_home_page_three_col .bbs_home_page_row_div").eq(index).children(
						'div:first-child').removeClass("col-lg-8").addClass("col-lg-9");
					$(".bbs_home_page_three_col .bbs_home_page_row_div").eq(index).children(
						'div:last-child').removeClass("col-lg-4").addClass("col-lg-3");
					$(".bbs_home_page_three_col .bbs_home_page_row_div").eq(index).children(
						'div:first-child').children("span").css("width", "19rem");
				}
			})
		}, 2000);


		if (self != top) {
			$('#header').hide();
			$('#nav2').hide();
			$('#footer').hide();
		}


		// 导航
		var browser_width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
		if (browser_width <= 992) {
			var new_p = 0,
				start_scrollTop = 0;
			$(window).scroll(function (e) {
				new_p = $(this).scrollTop();

				if (start_scrollTop < new_p) { //下滚  
					$('.header_fiexd').css("display", "none");
				} else { //上滚  
					$('.header_fiexd').css("display", "block");
				}
				setTimeout(function () {
					start_scrollTop = new_p;
				}, 0);
			});
		}


		// 返回顶部
		$(window).scroll(function () {
			if ($(window).scrollTop() >= 500) {
				$('.act_go_top').fadeIn(300);
			} else {
				$('.act_go_top').fadeOut(300);
			}
		});

		$('.act_go_top').click(function () {
			$('html,body').animate({
				scrollTop: '0px'
			}, 100);
		});
		// var m1 = 0;     // 滚动的值
		// var m2 = 0;     // 对比时间的值
		// var timer = null;
		// document.onscroll = function() {
		// 	clearTimeout(timer) // 每次滚动前 清除一次
		// 	timer = setTimeout(Data, 2000);
		// 	m1 = document.documentElement.scrollTop || document.body.scrollTop;

		// }
		// function Data() {
		// 	m2 = document.documentElement.scrollTop || document.body.scrollTop;
		// 	if(m2 == m1){
		// 	    $('.act_go_top').fadeOut(300);
		// 	}
		// }

		// 3600000
		var d = new Date();
		var session_interval = d.getTime() - $.pdata('top-banner-session');

		if (session_interval > 3600000) {
			$.pdata('top-banner', 0);
		}
		if ($.pdata('top-banner') == 1) {
			$(".top-banner").hide();
		} else {
			$(".top-banner").slideDown();
		}
		$(".top-banner-section .closeBanner").on("click", function () {

			$.pdata('top-banner', 1);
			$.pdata('top-banner-session', d.getTime());
			$(".top-banner").animate({
				height: '0'
			})
		})


		// 退出登录
		$.xgpost = function (url, postdata, callback, progress_callback) {
			if ($.isFunction(postdata)) {
				callback = postdata;
				postdata = null;
			}
			$.ajax({
				type: 'POST',
				url: url,
				data: postdata,
				dataType: 'text',
				timeout: 6000000,
				xhrFields: {
					withCredentials: true
				},
				progress: function (e) {
					if (e.lengthComputable) {
						if (progress_callback) progress_callback(e.loaded / e.total * 100);
						//console.log('progress1:'+e.loaded / e.total * 100 + '%');
					}
				},
				success: function (r) {
					if (!r) return callback(-1, 'Server Response Empty!');
					var s = xn.json_decode(r);
					if (!s || s.code === undefined) return callback(-1,
						'Server Response Not JSON：' + r);
					if (s.code == 0) {
						return callback(0, s.message);
						//系统错误
					} else if (s.code < 0) {
						return callback(s.code, s.message);
					} else {
						return callback(s.code, s.message);
					}
				},
				error: function (xhr, type) {
					if (type != 'abort' && type != 'error' || xhr.status == 403) {
						return callback(-1000, "xhr.responseText:" + xhr.responseText + ', type:' +
							type);
					} else {
						return callback(-1001, "xhr.responseText:" + xhr.responseText + ', type:' +
							type);
						console.log("xhr.responseText:" + xhr.responseText + ', type:' + type);
					}
				}
			});
		};
		$('.nav_user_item .logout').click(function () {
			$.xpost('/user-logout.htm', {}, function (code, message) {
				if (code == 0) {
					$.msg(message);
					$.xgpost('//passport.kanxue.com/user-logout.htm', "", function (code,
						message) {

						setTimeout(function () {
							window.location =
								"//passport.kanxue.com/my-logout.htm";

						}, 800)

					})
				}
			})
		});
	});
</script>

<script>
	(function () {
		var islogin = '0';
		if (islogin == 0) return;
		var pm_number = "/user-newpm.htm";
		$.xget(pm_number, function (code, message) {
			var pm_number = $(".pm_number");
			var sysm_number = $(".system_message_number");
			if (code == 0) {
				var newpms = parseInt(message.newpms);
				var system_pms = parseInt(message.system_pms);
				var pm_total = newpms + system_pms;
				if (pm_total != 0) {
					pm_total = pm_total > 99 ? "99+" : pm_total;
					if (newpms != 0) {
						$(".pm_message_btn").css("color", "#f44336");
					} else if (newpms == 0 && system_pms > 0) {
						$(".pm_message_btn").css("color", "#0099ee");

					}
					$(".newpms").html(newpms);
					$(".system_pms").html(system_pms);

					$(".pm_totals").html(pm_total);
				} else {
					// $(".pm_total_a").css("display","none");
				};
				if (message.newpms != 0) {
					pm_number.html(message.newpms);
					pm_number.addClass("pmmessage_number");
				} else {
					pm_number.css("display", "none");
				};
				if (message.system_pms != 0) {
					sysm_number.html(message.system_pms);
					sysm_number.addClass("pmmessage_number");
				} else {
					sysm_number.css("display", "none");
				};
				if (message.newpms != 0) {
					pm_number.html(message.newpms);
					pm_number.addClass("pm_numbers_");
				} else {
					pm_number.css("display", "none");
				};
				if (message.system_pms != 0) {
					sysm_number.html(message.system_pms);
					sysm_number.addClass("pm_numbers_");
				} else {
					sysm_number.css("display", "none");
				};


			} else {

				pm_number.css("display", "none");
				sysm_number.css("display", "none");

			}
		})

		$(".pm_message_box").on("mouseenter", function () {
			$(this).find(".dropdown-menu").addClass("show");
			$(this).addClass("active");
		})
		$(".pm_message_box").on("mouseleave", function () {
			$(this).find(".dropdown-menu").removeClass("show");
			$(this).removeClass("active");
		})

	})(jQuery);
</script>
<script>
	//统计在线
	(function () {
		var uid = '0';
		var current_time = '1662278132';
		var last_time;
		if (uid > 0) {
			//10分钟以内不请求。
			last_time = storagePlus.get('last_active_time_' + uid) || 0;
			//大于5分钟请求接口。
			if ((current_time - last_time) / 60 > 5) {
				$.xpost('user-online_sumtime.htm', {}, function (code, msg) {
					if (code == 0) {
						storagePlus.set('last_active_time_' + uid, msg);
					} else {
						console.info('msg');
					}
				});
			}
		}



	})();
</script>

<script>

var forumlist = [
    {
        "fid": "177",
        "fup": "10",
        "name": "x64dbg插件区",
        "rank": "40"
    },
    {
        "fid": "52",
        "fup": "10",
        "name": "OllyDbg插件区",
        "rank": "39"
    },
    {
        "fid": "53",
        "fup": "10",
        "name": "IDA Pro插件区",
        "rank": "38"
    },
    {
        "fid": "4",
        "fup": "3",
        "name": "软件逆向",
        "rank": "29"
    },
    {
        "fid": "29",
        "fup": "2",
        "name": "论坛管理团队",
        "rank": "29"
    },
    {
        "fid": "69",
        "fup": "20",
        "name": "经典问答",
        "rank": "29"
    },
    {
        "fid": "122",
        "fup": "37",
        "name": "KCTF2022提交区(隐藏版块)",
        "rank": "29"
    },
    {
        "fid": "102",
        "fup": "137",
        "name": "科锐培训",
        "rank": "29"
    },
    {
        "fid": "141",
        "fup": "140",
        "name": "CrackMe存档区",
        "rank": "29"
    },
    {
        "fid": "152",
        "fup": "0",
        "name": "学习园地",
        "rank": "29"
    },
    {
        "fid": "2",
        "fup": "1",
        "name": "论坛版务",
        "rank": "28"
    },
    {
        "fid": "76",
        "fup": "37",
        "name": "1)珠海金山2007逆向分析挑战赛",
        "rank": "28"
    },
    {
        "fid": "99",
        "fup": "65",
        "name": "《加密与解密(第4版)》",
        "rank": "28"
    },
    {
        "fid": "169",
        "fup": "137",
        "name": "15PB培训",
        "rank": "28"
    },
    {
        "fid": "125",
        "fup": "127",
        "name": "奇虎360软件安全大赛答案提交区",
        "rank": "28"
    },
    {
        "fid": "21",
        "fup": "57",
        "name": "《软件加密技术内幕》",
        "rank": "27"
    },
    {
        "fid": "68",
        "fup": "37",
        "name": "2)PEDIY Crackme竞赛2007",
        "rank": "27"
    },
    {
        "fid": "41",
        "fup": "3",
        "name": "编程技术",
        "rank": "27"
    },
    {
        "fid": "79",
        "fup": "57",
        "name": "前沿科技2",
        "rank": "27"
    },
    {
        "fid": "78",
        "fup": "2",
        "name": "申请提交区(隐藏版块)",
        "rank": "27"
    },
    {
        "fid": "95",
        "fup": "65",
        "name": "《0day:软件漏洞分析技术》",
        "rank": "27"
    },
    {
        "fid": "88",
        "fup": "3",
        "name": "加壳脱壳",
        "rank": "26"
    },
    {
        "fid": "91",
        "fup": "37",
        "name": "3)2008 Exploit Me挑战赛",
        "rank": "26"
    },
    {
        "fid": "158",
        "fup": "0",
        "name": "前沿科技",
        "rank": "26"
    },
    {
        "fid": "3",
        "fup": "0",
        "name": "桌面平台",
        "rank": "25"
    },
    {
        "fid": "64",
        "fup": "1",
        "name": "会员专区",
        "rank": "25"
    },
    {
        "fid": "120",
        "fup": "37",
        "name": "4)腾讯公司2008软件安全竞赛",
        "rank": "25"
    },
    {
        "fid": "57",
        "fup": "2",
        "name": "回收站",
        "rank": "25"
    },
    {
        "fid": "132",
        "fup": "3",
        "name": "密码应用",
        "rank": "24"
    },
    {
        "fid": "123",
        "fup": "57",
        "name": "《微软.NET程序的加密与解密》",
        "rank": "24"
    },
    {
        "fid": "127",
        "fup": "37",
        "name": "5)奇虎360软件安全比赛",
        "rank": "24"
    },
    {
        "fid": "37",
        "fup": "116",
        "name": "CTF对抗",
        "rank": "23"
    },
    {
        "fid": "140",
        "fup": "37",
        "name": "6)PEDIY Crackme竞赛2009",
        "rank": "23"
    },
    {
        "fid": "116",
        "fup": "0",
        "name": "CTF",
        "rank": "22"
    },
    {
        "fid": "150",
        "fup": "3",
        "name": "二进制漏洞",
        "rank": "22"
    },
    {
        "fid": "163",
        "fup": "65",
        "name": "《C++反汇编与逆向分析技术》",
        "rank": "22"
    },
    {
        "fid": "108",
        "fup": "0",
        "name": "企业建设",
        "rank": "21"
    },
    {
        "fid": "155",
        "fup": "37",
        "name": "7)腾讯公司2010软件安全竞赛",
        "rank": "21"
    },
    {
        "fid": "168",
        "fup": "65",
        "name": "《Android安全与逆向分析》",
        "rank": "21"
    },
    {
        "fid": "157",
        "fup": "37",
        "name": "8)2011 Exploit Me赛",
        "rank": "20"
    },
    {
        "fid": "121",
        "fup": "37",
        "name": "9）移动安全挑战赛（MSC）",
        "rank": "18"
    },
    {
        "fid": "129",
        "fup": "37",
        "name": "10）第2届移动安全挑战（MSC）",
        "rank": "17"
    },
    {
        "fid": "136",
        "fup": "0",
        "name": "职场生活",
        "rank": "12"
    },
    {
        "fid": "45",
        "fup": "136",
        "name": "茶余饭后",
        "rank": "6"
    },
    {
        "fid": "175",
        "fup": "137",
        "name": "《二万班安卓高级研修》",
        "rank": "5"
    },
    {
        "fid": "97",
        "fup": "152",
        "name": "问答版块",
        "rank": "4"
    },
    {
        "fid": "161",
        "fup": "158",
        "name": "Android安全",
        "rank": "4"
    },
    {
        "fid": "1",
        "fup": "0",
        "name": "站务管理/产品",
        "rank": "3"
    },
    {
        "fid": "10",
        "fup": "152",
        "name": "资源下载",
        "rank": "3"
    },
    {
        "fid": "128",
        "fup": "158",
        "name": "智能设备",
        "rank": "3"
    },
    {
        "fid": "137",
        "fup": "136",
        "name": "职业生涯",
        "rank": "3"
    },
    {
        "fid": "151",
        "fup": "108",
        "name": "WEB安全",
        "rank": "3"
    },
    {
        "fid": "160",
        "fup": "2",
        "name": "麦洛科菲培训",
        "rank": "3"
    },
    {
        "fid": "176",
        "fup": "137",
        "name": "《三万班安卓高级研修》",
        "rank": "3"
    },
    {
        "fid": "171",
        "fup": "116",
        "name": "Pwn",
        "rank": "2"
    },
    {
        "fid": "20",
        "fup": "152",
        "name": "¥付费问答",
        "rank": "2"
    },
    {
        "fid": "32",
        "fup": "152",
        "name": "外文翻译",
        "rank": "2"
    },
    {
        "fid": "47",
        "fup": "136",
        "name": "招聘专区",
        "rank": "2"
    },
    {
        "fid": "162",
        "fup": "108",
        "name": "企业安全",
        "rank": "2"
    },
    {
        "fid": "166",
        "fup": "158",
        "name": "iOS安全",
        "rank": "2"
    },
    {
        "fid": "170",
        "fup": "57",
        "name": "看雪产品",
        "rank": "2"
    },
    {
        "fid": "65",
        "fup": "136",
        "name": "图书项目",
        "rank": "1"
    },
    {
        "fid": "174",
        "fup": "32",
        "name": "International  vision",
        "rank": "1"
    },
    {
        "fid": "172",
        "fup": "2",
        "name": "区块链安全",
        "rank": "0"
    },
    {
        "fid": "173",
        "fup": "3",
        "name": "KSA软件",
        "rank": "0"
    },
    {
        "fid": "178",
        "fup": "158",
        "name": "HarmonyOS",
        "rank": "0"
    }
];

// 三级版块
function forum_tree(forumlist, template) {
	var template = template || '<option value="{fid}">{tab}{name}</option>'+"\r\n";
	var s = '';
	var forumlist1 = forumlist.filter(function(v) {return v.fup == 0});
	for(var i1=0; i1<forumlist1.length; i1++) {
		var v1 = forumlist1[i1];
		s += '►'+xn.template(template, {fid: v1.fid, name: v1.name, tab: "　"});
		var forumlist2 = forumlist.filter(function(v2) {return v2.fup == v1.fid});
		for(var i2=0; i2<forumlist2.length; i2++) {
			var v2 = forumlist2[i2];
			s += xn.template(template, {fid: v2.fid, name: v2.name, tab: "　　"});
			var forumlist3 = forumlist.filter(function(v3) {return v3.fup == v2.fid});
			for(var i3=0; i3<forumlist3.length; i3++) {
				var v3 = forumlist3[i3];
				s += xn.template(template, {fid: v3.fid, name: v3.name, tab: "　　　　"});
			}

		}
	}
	return s;
}


// 版主管理：移动 / moderator : move
$('.mod-button button.move').off('click').on('click', function() {
	var modtid = $('input[name="modtid"]').checked();
	if(modtid.length == 0) return $.alert(lang.please_choose_thread);
	var select = '<select name="fid">'+forum_tree(forumlist)+'</select>';
	$.confirm(lang.move_forum, function() {
		var tids = xn.implode('_', modtid);
		var newfid = $('select[name="fid"]').val();
		$.xpost(xn.url('mod-move-'+tids+'-'+newfid), function(code, message) {
			if(code != 0) return $.alert(message);
			$.alert(message).delay(1000).location('');
		});
	}, {'body': '<p>'+lang.choose_move_forum+'：'+select+'</p>'});
})

</script><script>

// 版主管理：审核
$('.mod-button button.audit').on('click', function() {
	var modtid = $('input[name="modtid"]').checked();
	if(modtid.length == 0) return $.alert(lang.please_choose_thread);
	var radios = xn.form_radio('audit', {"1": "审核通过", "2": "审核不通过"});
	$.confirm('审核主题', function() {
		var tids = xn.implode('_', modtid);
		var audit = $('input[name="audit"]').checked();
		var postdata = {audit: audit};
		$.xpost(xn.url('mod-audit-'+tids), postdata, function(code, message) {
			if(code != 0) return $.alert(message);
			$.alert(message).delay(1000).location('');
		});
	}, {'body': '<p>'+'审核选项'+'：'+radios+'</p>'});
})

</script><script>

    // 版主管理：审核
    $('.mod-button button.limit').on('click', function() {
        var modtid = $('input[name="modtid"]').checked();
        if(modtid.length == 0) return $.alert(lang.please_choose_thread);
        var radios = xn.form_radio('limit', {"0": "验证通过", "1": "待验证"});
        $.confirm('验证主题', function() {
            var tids = xn.implode('_', modtid);
            var limit = $('input[name="limit"]').checked();
            var postdata = {audit: limit};
            $.xpost(xn.url('mod-newuser_audit-'+tids), postdata, function(code, message) {
                if(code != 0) return $.alert(message);
                $.alert(message).delay(1000).location('');
            });
        }, {'body': '<p>'+'验证选项'+'：'+radios+'</p>'});
    })
    
    </script>



<script>

$(function() {
	// 版主管理：删除 / moderator : delete
	$('.mod-button button.delete').off('click').on('click', function() {
		var modtid = $('input[name="modtid"]').checked();
		if(modtid.length == 0) return $.alert(lang.please_choose_thread);
		var radios = '';
				//var htmladd = '<br><br><label class="text-small"><input type="checkbox" name="logic" value="0" /> 物理删除</label>';
		//htmladd += '<br><label class="text-small"><input type="checkbox" name="logic" value="0" /> 恢复删除</label>';
		$.confirm(xn.lang('confirm_delete_thread', {n:modtid.length}) + '<br><br>'+radios, function() {
			var tids = xn.implode('_', modtid);
			var type = $('input[name="type"]').checked();
			$.xpost(xn.url('mod-delete-'+tids), {type: type}, function(code, message) {
				if(code != 0) return $.alert(message);
				$.alert(message).delay(1000).location('');
			});
		});
	})

	// 恢复逻辑删除的帖子
	$('body').on('click', '.post_recover', function() {
		var jthis = $(this);
		var href = jthis.data('href');
		var isfirst = jthis.attr('isfirst');
		if(window.confirm('确定恢复删除的帖子？')) {
			$.xpost(href, function(code, message) {
				var isfirst = jthis.attr('isfirst');
				if(code == 0) {
					if(isfirst == '1') {
						$.location('forum-150.htm');
					} else {
						window.location.reload();
					}
				} else {
					$.alert(message);
				}
			});
		}
		return false;
	});

})

</script>



<div class="modal fade appeal" id="appeal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                        </button>
                        <h4 class="modal-title" id="exampleModalLabel">求助问答申诉</h4>
                        </div>
                        <form id="form_appeal" action="https://bbs.pediy.com/post-appeal.htm" method="post">
	                        <div class="modal-body">
	                                <div class="form-group">
	                                	<input id="pid" name="pid" value="0" type="hidden">
	                                        <textarea class="form-control" id="brief" name="brief" rows="6" placeholder="请填写内容，注意: 请写明申诉的原因"></textarea>
	                                </div>
	                        </div>
	                        <div class="modal-footer">
	                                <button id="appeal_submit" type="button" class="btn btn-primary" data-loading-text="正在提交...">申请提交</button>
	                        </div>
	                </form>
                </div>
        </div>
</div><div class="modal fade report" id="report" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                        
                        <h4 class="modal-title" id="exampleModalLabel">举报此帖</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                        </button>
                        </div>
                        <form id="form_report" action="https://bbs.pediy.com/post-report.htm" method="post">
                                <div class="modal-body">
                                        <div class="form-group">
                                                <input id="tid" name="tid" value="0" type="hidden">
                                                <input id="pid" name="pid" value="0" type="hidden">
                                                <textarea class="form-control" id="brief" name="brief" rows="6" placeholder="请填写内容，注意: 请确认您所举报此帖的内容涉及到语言挑衅和违犯论坛版规的内容， 版主将收到举报后审核该帖！"></textarea>
                                        </div>
                                </div>
                                <div class="modal-footer">
                                        <button id="report_submit" type="button" class="btn btn-primary" data-loading-text="正在提交...">发送报告</button>
                                </div>
                        </form>
                </div>
        </div>
</div>

<div class="modal fade sqtj" id="sqtj" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                        
                        <h4 class="modal-title" id="exampleModalLabel">申请推荐此帖</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                        </button>
                        </div>
                        <form id="form_sqtj" action="https://bbs.pediy.com/post-sqtj.htm" method="post">
                                <div class="modal-body">
                                        <div class="form-group">
                                                <input id="tid" name="tid" value="0" type="hidden">
                                                <input id="pid" name="pid" value="0" type="hidden">
                                                <textarea class="form-control" id="brief" name="brief" rows="6" placeholder="请填写推荐的理由，注意: 请确认您所申请推荐的内容， 版主将收到申请后审核该帖！"></textarea>
                                        </div>
                                </div>
                                <div class="modal-footer">
                                        <button id="sqtj_submit" type="button" class="btn btn-primary" data-loading-text="正在提交...">发送申请</button>
                                </div>
                        </form>
                </div>
        </div>
</div>

<script src="./AFL二三事 -- 源码分析 1/iconfont.js"></script>

<script src="./AFL二三事 -- 源码分析 1/face.js"></script>

<script src="./AFL二三事 -- 源码分析 1/qqLevel.js"></script>

<script>

var thread_uid = '779730';

var passport_domain = 'passport.kanxue.com';

// 回复 操作按钮 手机端 显示隐藏方法 开始

function mobile_more_operate(e){

	$(".mobile_more_operate").hide();

	$(e.target).siblings(".mobile_more_operate").fadeIn();

}

$(document).scroll(function(){

	$(".mobile_more_operate").hide();

})

$(document).on("click", function(e){



	if ($(e.target).parents(".mobile_more_operate_btn").length == 0 && !$(e.target).hasClass('mobile_more_operate_btn')) {

		$(".mobile_more_operate").hide();

	}

	

})

// 回复 操作按钮 手机端 显示隐藏方法 结束



function show_level(event) {

	var el = event.target;

	

	var usergid = $(el).attr("data-gid");

	$.tips('<span class="level-'+usergid+' level"></span>', $(el), {

		tips: [3, '#fff'],

		time: 2000

	});

}



function show_online_level(event) {

	var el = event.target;

	

	var userdesc = $(el).attr("data-desc");



	$.tips('<span class="text-muted">'+userdesc+'</span>', $(el), {

		tips: [3, '#fff'],

		time: 2000

	});

}

function online_time_imgs(v) {



	var online_time = $(v).data('online_time');

	var level = qqLevel.getLevel(online_time);

	var imgs = qqLevel.getImg(level, [

		'//'+passport_domain+'/pc/view/img/star_0.gif',

		'//'+passport_domain+'/pc/view/img/star.gif',

		'//'+passport_domain+'/pc/view/img/moon.gif',

		'//'+passport_domain+'/pc/view/img/sun.gif',

		'//'+passport_domain+'/pc/view/img/king.gif',

	]);

	var desc = qqLevel.getDescBbs(online_time);

	$(v).attr('data-desc', desc);



	$(v).next(".post_online_time1").html('( '+desc+' )');

	$(v).html(imgs);

}

$(".post_online_time").each(function(k, v) {

	online_time_imgs(v)

})



// 快速回帖切换到高级回复时，编辑框文字保存一下来

$('.senior_reply').on('click', function(){

	var  quick_reply_message = $('#quick_reply_form').find('#message').val().trim();



	// quick_reply_message = quick_reply_message.replace(/\[em_([0-9]+)\]/g, '<img src="/view/img/face/$1.gif" class="face" style="cursor: pointer;">');

	

	function senior_reply_pdata(return_obj) {

		if(quick_reply_message.length == 0) {

			$.pdata('quick_reply_message', '');

		} else {

			$.pdata('quick_reply_message', quick_reply_message);

		}

		return return_obj();

	}

	function senior_reply_return(){

		window.location.href= 'post-create-269534.htm';

	};

	senior_reply_pdata(senior_reply_return);

	

})





function shareTo(stype){

	var ftit = '';

	var flink = '';

	var lk = '';

	//获取文章标题

	ftit = $('.subject').text();

	//获取网页中内容的第一张图片

	flink = $('.message img').eq(0).attr('src');



	if(typeof flink == 'undefined'){

		flink='';

	}

	//当内容中没有图片时，设置分享图片为网站logo

	if(flink == ''){

		lk = 'http://bbs.pediy.com/plugin/kanxue/img/kanxuelogo.png';

	}

	//如果是上传的图片则进行绝对路径拼接

	if(flink.indexOf('upload/') != -1) {

		lk = 'http://bbs.pediy.com/'+flink;

	}

	//qq空间接口的传参

	// if(stype=='qzone'){

		//弹出窗口的宽度;

		// var iw=800; 

		//弹出窗口的高度;

		// var ih=500; 

		//获得窗口的垂直位置;

		// var it = (window.screen.availHeight-30-ih)/4; 

		//获得窗口的水平位置;

	// 	var il = (window.screen.availWidth-10-iw)/4; 

	// 	var openurl = 'https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url='+document.location.href+'?sharesource=qzone&title='+ftit+'&pics='+lk+'&summary='+document.querySelector('meta[name="description"]').getAttribute('content');

	// 	window.open(openurl,"","height="+ih+", width="+iw+", top="+it+", left="+il);

	// }

	

	//新浪微博接口的传参

	if(stype=='sina'){

		var iw=500; //弹出窗口的宽度;

		var ih=500; //弹出窗口的高度;

		var it = (window.screen.availHeight-30-ih)/4; //获得窗口的垂直位置;

		var il = (window.screen.availWidth-10-iw)/4; //获得窗口的水平位置;

		var openurl = 'http://service.weibo.com/share/share.php?url='+document.location.href+'?sharesource=weibo&title='+ftit+'&pic='+lk;

		window.open(openurl,"","height="+ih+", width="+iw+", top="+it+", left="+il);

	

	}

	//qq好友接口的传参

	if(stype == 'qq'){

		var iw=800; //弹出窗口的宽度;

		var ih=500; //弹出窗口的高度;

		var it = (window.screen.availHeight-30-ih)/4; //获得窗口的垂直位置;

		var il = (window.screen.availWidth-10-iw)/4; //获得窗口的水平位置;

		var openurl = 'http://connect.qq.com/widget/shareqq/index.html?url='+document.location.href+'?sharesource=qzone&title='+ftit+'&pics='+lk+'&summary='+document.querySelector('meta[name="description"]').getAttribute('content')+'&desc=看雪，一个有情怀的安全开发者交流的网站'

		window.open(openurl,"","height="+ih+", width="+iw+", top="+it+", left="+il);

	}

	//生成二维码给微信扫描分享，php生成，也可以用jquery.qrcode.js插件实现二维码生成

	if(stype == 'wechat'){

		

		$.tips('<img width="150" src="bbs_qrcode-http_3A_2F_2Fbbs_2epediy_2ecom_2Fthread_2d269534_2ehtm.htm">',$("#wxshare"),{ tips: [2, '#eee'],time: 5000});

	}

}

$(function() {

	var jform = $('#quick_reply_form');

	var jsubmit = $('#submit');

	jform.on('submit', function() {

		jform.reset();

		jsubmit.button('loading');

		var postdata = jform.serialize();

		$.xpost(jform.attr('action'), postdata, function(code, message) {

			if (code == 0) {

				var s = '<table>' + message + '</table>';

				var jtr = $(s).find('tr');

				jtr.insertBefore($('table.postlist tr').last());

				jsubmit.button('reset');

				$('#message').val('');



				// 楼层 +1

				var jfloor = jform.find('.floor');

				jfloor.html(xn.intval(jfloor.html()) + 1);



				// 回复数 +1

				var jposts = $('.posts');

				jposts.html(xn.intval(jposts.html()) + 1);



			} else if (code < 0) {

				$.alert(message);

				jsubmit.button('reset');

			} else {

				jform.find('[name="' + code + '"]').alert(message).focus();

				jsubmit.button('reset');

			}

		});

		return false;

	});



	//  显示隐藏 点赞收藏等功能

	var offset_top = $("#collection_thumb").offset().top - $(document).scrollTop();

	if (offset_top < document.documentElement.clientHeight) {

		$(".collection_thumb_left").hide();

	} else {

		$(".collection_thumb_left").show();

	}

	$(document).on("scroll",function(){

		var offset_top = $("#collection_thumb").offset().top - $(document).scrollTop();

		if (offset_top < document.documentElement.clientHeight) {

			$(".collection_thumb_left").hide();

		} else {

			$(".collection_thumb_left").show();

		}

	})

	//收藏功能

	var jfavorite = $('.favorite');

	var jlikesFirst = $('.likes:first');

	var jlikes = $('.likes');

	var jlikes_box = $('.likes_box');

	var likenums = jlikesFirst.text();

	if (parseInt(likenums) > 0) jlikes_box.removeClass("likes_box_hide").addClass("likes_box_show");

	jfavorite.on('click', function() {

		var likenum = jlikesFirst.text();

		likenum_plus = parseInt(likenum) + 1;

		likenum_sub = parseInt(likenum) - 1;

		if(likenum_sub < 0) likenum_sub = 0;

		$.xpost('thread-favorite-269534.htm', function(code, message) {

			if(code == 0) {

				var s = '<i class="icon-star" style="color: #0099ee;"></i>';

				jfavorite.html(s);

				jfavorite.css("border-color",'#0099ee');

				jlikes.text(likenum_plus);

				jlikes_box.removeClass("likes_box_hide").addClass("likes_box_show");



			}else if(code == 1) {

				var s = '<i class="icon-star-o color4A4A4A"></i>';

				jfavorite.html(s);

				jfavorite.css("border-color",'#DDDDDD');

				jlikes.text(likenum_sub);

				if(likenum_sub == 0) jlikes_box.removeClass("likes_box_show").addClass("likes_box_hide");

			} else {

				$.alert(message);

			}

		});

		return false;

	});



	// 点赞

	var page = '1';

	var thumbs_num_box = $('.thumbs_num_box');

	var thumbs_num_first = $(".thumbs_num:first").text();

	if (parseInt(thumbs_num_first) == 0) thumbs_num_box.hide();



	$('.thumb').click(function() {

		var threadid = `269534`;

		var type = 1;

		var num = parseInt(thumbs_num_first);

		var postdata = 'threadid=' + threadid + '&type=1&page='+page;

		var that = this;

		$.xpost('thumbs_up-thumbs.htm', postdata, function(code, message) {

			if(code == 0) {

				thumbs_num_box.show();

				var s = '<i class="icon-thumbs-up" style="color: #0099ee;"></i>';

				$(that).html(s);

				$(that).css("border-color",'#0099ee');

				$('.thumbs_num').text(num + 1);

				$.tips('感谢您的赏识！您已向主题帖作者发送 '+message+' 个雪币，表达感谢', $(that), {

					tips:1,

					time: 2000,

					tips: [1,'#748691']

				});

			} else if(code == 1){

				thumbs_num_box.show();

				$.tips(message, $(that), {

					tips: 1,

					time: 2000,

					tips: [1,'#748691']



				});

			} else {

				$.tips(message, $(that), {

					tips: 1,

					time: 2000,

					tips: [1,'#748691']



				});

			}

		})

	})



	// 缩放图片，适应屏幕大小。

	function resize_image() {

		var jmessagelist = $('div.message');

		var first_width = jmessagelist.width(); // 815 : 746; //  734 746

		jmessagelist.each(function() {

			var jdiv = $(this);

			var maxwidth = jdiv.attr('isfirst') ? first_width : first_width - 79; //  734 746

			var jmessage_width = Math.min(jdiv.width(), maxwidth);

			jdiv.find('img, embed, iframe').each(function() {

				var jimg = $(this);

				//if(jimg.width() < 500) return;

				var img_width = this.org_width;

				var img_height = this.org_height;

				if (!img_width) {

					var img_width = jimg.width();

					var img_height = jimg.height();

					this.org_width = img_width;

					this.org_height = img_height;

				}

				//var percent = xn.min(100, xn.ceil((img_width / jmessage_width) * 100));

				if (img_width > jmessage_width) {

					if (this.tagName == 'IMG') {

						jimg.width(jmessage_width);

						jimg.css('height', 'auto');

					} else {

						jimg.width(jmessage_width);

						var height = (img_height / img_width) * jimg.width();

						jimg.height(height);

					}

				}



			});

			

			jdiv.find('p').each(function() {

				var jp = $(this);

				if($.trim(jp.text()) == '') {

					jp.css('line-height', '1');

				}

			});

		});

	}

	// resize_image();

	// $(window).on('resize', resize_image);





 	//---------by wang start------------------------//

	//取出tr的pid，赋值给tr使name为point_pid

	// $(".post").each(function() {

	// 	var cpid = $(this).attr("pid");

	// 	$(this).attr("id","point_"+ cpid);

	// });

	var url = window.location.toString();

	

	if(url.indexOf("#") != -1){

		var cpid = url.split("#")[1];

		if(cpid) {

			$(".post").each(function(k,v) {

				if($(v).attr("pid") == cpid) {

					var t = $(this).offset() ? $(this).offset().top : 0;

					//$("#frame_right").scrollTop(t);

					$("html,body").animate({scrollTop:t},800)

				}

				

			});

			

		}

	}

	

	//------------by wang end----------------------------//





	

	// 输入框自动伸缩

	var jmessage = $('#message');

	jmessage.on('focus', function() {

		if (jmessage.t) {

			clearTimeout(jmessage.t);

			jmessage.t = null;

		}

		jmessage.css('height', '6rem');

	});

	jmessage.on('blur', function() {

		jmessage.t = setTimeout(function() {

			jmessage.css('height', '2.5rem');

		}, 1000);

	});



	$('#nav_pc li[fid="150"]').addClass('active');

	$('#nav_mobile li[fid="150"]').addClass('active');



	 $(function(){

		$('.emotion').qqFace({

			id : 'facebox',

			assign:'message',

			path:'view/img/face/'

		});

	});



	$("div.message img").css("cursor","pointer");

	$("div.message img").on("click",function() {

		if (window.innerWidth > 768) {

			var img_src = $(this).attr("src");

			var img = new Image();

			img.src = img_src;  

			img.onload = function () {

				window.open(img_src);

			};  

			// img.onerror = function () {

			// 	alert("error!")

			// };  

			

		}

	})

	setTimeout(function() {

		$("div.message img").each(function(index, element) {

			if ($(element).width() >= 100) {

				$(element).addClass("div_message_boxShadow");

			}

		})

	}, 2000);

	

	function IsPC() {

		var userAgentInfo = navigator.userAgent;

		var Agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];

		var flag = true;

		for (var v = 0; v < Agents.length; v++) {

			if (userAgentInfo.indexOf(Agents[v]) > 0) {

				flag = false;

				break;

			}

		}

		return flag;

	}



	// 弹出分享页面

	var outside = true;

	$(".bbsshare_btn").on('click', function(event){

		outside = false;

		$(".bbsshare_modal").show();

	});

	document.body.addEventListener('click', function() {

		outside = true;

	},true)

	document.body.addEventListener('click', function() {

		if(outside){

			$(".bbsshare_modal").hide();

		}

	})

	// $(".bbsshare_btn").on('click', function(event){

	// 	$.open({

	// 		type: 1,

	// 		title: false,

	// 		content: $('.bd-bbsshare-modal-sm'),

	// 		offset: 'auto',

	// 		shadeClose: false,

	// 		shade: false,



	// 	});



	// });



	if ($.pdata('collapse_reward') && $.pdata('collapse_reward') == 1) {

		$("#collapse_reward").removeClass('show');

		$(".collapse_btn").find("span").html("展开");

		$(".collapse_btn").find("i").removeClass("icon-angle-up").addClass("icon-angle-down");

		

	} else if( $.pdata('collapse_reward') == 0 || $.pdata('collapse_reward') == '' || $.pdata('collapse_reward') == null) {

		$("#collapse_reward").addClass('show');

		$(".collapse_btn").find("span").html("收起");

		$(".collapse_btn").find("i").removeClass("icon-angle-down").addClass("icon-angle-up");

	}

	$("#collapse_reward").on('hide.bs.collapse', function () {

		$.pdata('collapse_reward', 1)

		$(".collapse_btn").find("span").html("展开");

		$(".collapse_btn").find("i").removeClass("icon-angle-up").addClass("icon-angle-down");

		

		

	})

	$("#collapse_reward").on('show.bs.collapse', function () {

		$.pdata('collapse_reward', 0)

		$(".collapse_btn").find("span").html("收起");

		$(".collapse_btn").find("i").removeClass("icon-angle-down").addClass("icon-angle-up");

		

	})

	



	// $(".follow_btn_svg").on("click", function(){

	// 	var that = $(this);

	// 	$.xpost("user-follow.htm", {followed_uid: thread_uid}, function(code, message) {

	// 		if (code == 0) {

	// 			$.msg(message);

	// 			that.parent(".follow_btn_span").remove();

	// 		} else if (code == 1) {

	// 			$.msg(message);

	// 		}

	// 	})

	// })



	$(".follow_btn").on("click", function(){

		var that = $(this);

		var cuid = that.attr("data-cuid");

		$.xpost("user-follow.htm", {followed_uid: cuid}, function(code, message) {

			if (code == 0) {

				that.removeClass("btn-0099ee").addClass("btn-followed");

				that.html('已关注');

				$.msg(message);

			} else if (code == 1) {

				that.removeClass("btn-followed").addClass("btn-0099ee");

				that.html('<i class="icon icon-plus"></i> 关注');

				$.msg(message);

			} else if (code == -1) {

				$.msg(message);

			}

		})

	})

	$(".avatar_hover").on("mouseenter",function(){

		$(".thread-poptip-box").hide();

		$(this).find(".thread-poptip-box").show();

	})

	$(".avatar_hover").on("mouseleave",function(){

		$(".thread-poptip-box").hide();

	})



	// 右侧块 滚动到一定位置隐藏 开始

	

	var message_height = 0;

	$(window).scroll(function() {

		var message_height2 = $(".message_card .message").height();

		if (message_height2 != message_height) {

			message_height = message_height2;

		}

		if ((window.pageYOffset) > message_height) {

			$(".rightbox_card_hidden").hide();

		} else {

			$(".rightbox_card_hidden").show();

		}

	});

	// 右侧块 滚动到一定位置隐藏 结束

	//广告



	function ad_count_request(data, type, adkey, num, func) {
		return false;
		$.xpost('//www.kanxue.com/advertisement-request.htm',"data="+data+"&type="+type+"&adkey="+adkey+"&num="+num, function(code, message) {

			if(func) func();

		})

	}

	var adpostdata = $("#thread_ad").data('thread_postdata');

	var adkey = "Far9pdK_2Bs1DZJACfymiwLQ_3D_3D";

	ad_count_request(adpostdata, 1, adkey, 1);

	$("#thread_ad").click(function() {

		var that = $(this);

		var href = $(this).data('href');

		ad_count_request(adpostdata, 2, adkey, 0, function() {

			$(that).attr('target',"_blank");

			$(that).attr('href',href);

			

		});



	});

		

	





	$(".fieldset .attachlist a").on("click",function(){

		var _this = this;

		if ($(".down_golds").length > 0) {

			$.confirm($(".down_golds").text(),function(){

				window.open($(_this).attr("data-href"));

			})

		} else {

			
		}

	})



});



</script>




<div style="position: absolute;top: 50%;left: 50%;transform: translateX(-50%) translateY(-50%);" class="modal fade bd-example-modal-sm" id="wxpay_modal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">

    <div class="modal-content text-center ">
        <div class="" style="height: 55px; border-bottom: 1px solid rgba(204, 204, 204, 0.26); background-image: url(./view/img/pay_s.png); background-repeat: no-repeat; background-position: bottom center;">
            <button type="button" class="close mr-3" style="margin-top: 1.5rem;" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">×</span>
                <span class="sr-only">Close</span>
            </button>
        </div>
        <div class="wxpay_modal_body">

        </div>
    </div>
</div>
</div>
<script>
var jpay_form = $('#pay_kx');
var jkxpay = $('.kx-pay');
var rid = 0;
var check_handle = null;

function topay(){
    clearInterval(check_handle);
    check_handle = null;
    var valtype = $("input[name='reward_type']:checked").val();
    var rmbstype = $("input[name='reward_rmbs']:checked").val();
    if(!valtype) { alert('请您选择一个支付方式!'); return false; }
    if(rmbstype < 1) {
        alert("打赏金额不能少于1雪花");
        return false;
    }else if(valtype == 1){
        if(_is_weixin) {
            $.alert('请用其它浏览器打开再用赞赏功能!');
            return false;
        }

        window.Popup = window.open('about:blank', '_blank','width='+window.screen.width+',height='+window.screen.height+', ...');
        var ptdata = jpay_form.serialize();
        jkxpay.button('loading');
        $.xpost('reward_pay-charge.htm', ptdata, function(code, message) {
            if(code == 0) {
                
                Popup.blur();
                Popup.opener.focus();
                Popup.location = 'reward_pay-reward_alipay-'+ message +'.htm';
                jkxpay.button('reset');
                $('.reward').modal('hide');
                check_setInterval(message);
            } else if(code < 0) {
                Popup.close();
                alert(message);
                jkxpay.button('reset');
            } else {
                Popup.close();
                alert(message);
                jkxpay.button('reset');
            }
        });
        return false;
    }else if(valtype == 2){
        var postdata = jpay_form.serialize();
        jkxpay.button('loading');
        $.xpost('reward_pay-reward_remainder.htm', postdata, function(code, message) {
            if(code == 0) {
                $.alert(message);
                jkxpay.button('reset');
                $('.reward').modal('hide');
                window.location.reload();
            } else if(code < 0) {
               $.alert(message);
                jkxpay.button('reset');
            } else {
                $.alert(message);
                jkxpay.button('reset');
            }
        });
        return false;
    }else if(valtype == 3) {

        // $('#wxpay_modal').modal({backdrop: 'static', keyboard: false});
        var ptdata = jpay_form.serialize();
        jkxpay.button('loading');
        $.xpost('reward_pay-charge.htm', ptdata, function(code, message) {
            if(code == 0) {
                //微信支付
                $.xget('reward_pay-wxpay-'+ message +'.htm',function(cd,msg) {
                    if(cd == 0) {
                        check_setInterval(message);

                        //$(".wxpay_code img").attr('src', 'http://paysdk.weixin.qq.com/example/qrcode.php?data='+ msg);
                        var wx_img = '<div class="pt-3 text-center"><img src="./view/img/wxpay2.png" style="height: 40px;"></div>\
                        <div class="modal-body wxpay_code pt-3 pb-3">\
                            <div  style="width: 80%;text-align:center; margin: 0 auto;">\
                                <span class="wx_img"><img alt="扫码支付" style="width: 60%;" src="//bbs.pediy.com/reward_pay-wxcode-'+ xn.urlencode(msg) +'.htm"/></span>\
                                <span class="pay_success_shadow" style="display: none;"></span>\
                            </div>\
                            <div class="text-center text-muted mt-3">打开微信扫一扫，即可完成支付</div>\
                            <div class="swal2-icon swal2-success swal2-animate-success-icon">\
                                <span class="swal2-success-line-tip "></span>\
                                <span class="swal2-success-line-long "></span></div></div>';  
                        $(".wxpay_modal_body").html(wx_img);
                        jkxpay.button('reset');
                        $(".reward").modal('hide');
                        $('#wxpay_modal').modal({backdrop: 'static', keyboard: false});
                        $('#wxpay_modal').modal('show');
                    } else {
                        $.alert(msg);
                        jkxpay.button('reset');
                    }
                })
                return false;
            } else {
                $.alert(message);
                jkxpay.button('reset');
            }
        });
      
        return false;

    }else{
        $('.reward').modal('hide');
        return false;
    }
}

function check_status(rid) {
  var val_type = $("input[name='reward_type']:checked").val();
  $.xpost('reward_pay-check.htm', {checkid: rid}, function(code, message) {
    if(code == 0) {
      if(val_type == 1) {
        Popup.close();
      }
      $.alert('恭喜您，赞赏成功！');
      setTimeout(function() {
                 window.location.reload();
      }, 3000);
      // if(check_handle) {
        clearInterval(check_handle);
        check_handle = null;
      // }
    } else {
      return false;
    }
  });
}

function check_setInterval(rid) {
  check_handle = setInterval(function() {
    check_status(rid);
  }, 3000);
}

window._is_weixin = function() {
  var _ua = window.navigator.userAgent.toLowerCase();
  if (_ua.match(/MicroMessenger/i) == 'micromessenger') {
      return true;
  } else {
      return false;
  }
}()


$("select.reward_reason").change(function(){

    console.log( $("select.reward_reason option:selected").val());
    var reward_reason = $("select.reward_reason option:selected").val()
    if (reward_reason != 0) {
        $(".reward_reason_textarea").val($("select.reward_reason option:selected").val());
    }
    
    
})

</script><script>
var jform_appeal = $('#form_appeal');
var appeal_submit = $('#appeal_submit');

appeal_submit.on('click', function() {
    jform_appeal.reset();
    appeal_submit.button('loading');
    var postdata = jform_appeal.serialize();
    
    $.xpost(jform_appeal.attr('action'), postdata, function(code, message) {
        if(code == 0) {
       	$.alert(message);
       	appeal_submit.button('reset');
       	setTimeout(function(){window.location.reload();
            }, 2000);
        } else {
    	$.alert(message);
    	appeal_submit.button('reset');
        }
    });
    return false;
});

 $('#appeal').on('show.bs.modal', function (event) {
	var button = $(event.relatedTarget)
	var pid = button.data('pid');
	var modal = $(this);
	modal.find('.modal-body #pid').val(pid);

})
</script><script>

var jform_report = $('#form_report');
var report_submit = $('#report_submit');

report_submit.on('click', function() {
    jform_report.reset();
    report_submit.button('loading');
    var postdata = jform_report.serialize();
    
    $.xpost(jform_report.attr('action'), postdata, function(code, message) {
        if(code == 0) {
       	$.alert(message);
       	report_submit.button('reset');
       	setTimeout(function(){window.location.reload();
            }, 1000);
        } else {
    	$.alert(message);
    	report_submit.button('reset');
        }
    });
    return false;
});

$('#report').on('show.bs.modal', function (event) {
	var button = $(event.relatedTarget)
    var tid = button.data('tid');
    var pid = button.data('pid');
    var modal = $(this);

    modal.find('.modal-body #tid').val(tid);
    modal.find('.modal-body #pid').val(pid);
})

var jform_sqtj = $('#form_sqtj');
var sqtj_submit = $('#sqtj_submit');

sqtj_submit.on('click', function() {
    jform_sqtj.reset();
    sqtj_submit.button('loading');
    var postdata = jform_sqtj.serialize();
    
    $.xpost(jform_sqtj.attr('action'), postdata, function(code, message) {
        if(code == 0) {
        $.alert(message);
        sqtj_submit.button('reset');
        setTimeout(function(){window.location.reload();
            }, 1000);
        } else {
        $.alert(message);
        sqtj_submit.button('reset');
        }
    });
    return false;
});

$('#sqtj').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget)
    var tid = button.data('tid');
    var pid = button.data('pid');
    var modal = $(this);

    modal.find('.modal-body #tid').val(tid);
    modal.find('.modal-body #pid').val(pid);
})
</script><!--游客下载附件关注微信公众号-->
<div class="modal fade download_code" id="download_code" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">游客下载提示</h5>
	                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	                                <span aria-hidden="true">×</span>
	                        </button>
	                        
                        </div>
                        <form id="form_download" action="https://bbs.pediy.com/thread-269534.htm" method="post" target="_blank">
                                <div class="modal-body text-center">
                                    <input id="aid" name="aid" value="0" type="hidden">
                                    <dl class="row">
                                    	<dd class="text-left" style="width:50%">
                                        	<div style="font-size:14px">
                                        		<div>1.请先关注公众号。</div>
                                        		<div>2.点击菜单"更多"。</div>
                                        		<div>3.选择获取下载码。</div>
                                        	</div>
                                    	</dd>
                                    	<dt><img src="./AFL二三事 -- 源码分析 1/wxgz.jpg" width="80%"></dt>
                                    </dl>
                                    <fieldset class="form-group">
                						<input class="form-control" type="text" id="download_code" name="download_code" placeholder="请输入下载码" value="">
                					</fieldset>
                                </div>
                                <div class="modal-footer">
                                        <button id="download_submit" type="button" class="btn btn-primary" data-loading-text="正在提交...">下载</button>
                                </div>
                        </form>
                </div>
        </div>
</div>
<script>

var jform_download = $('#form_download');
var jdownload_submit = $('#download_submit');

    jdownload_submit.on('click', function() {
        jform_download.reset();
        jdownload_submit.button('loading');
        var postdata = jform_download.serialize();

        var aid2 = jform_download.find('.modal-body #aid').val();
        
        $.xpost(jform_download.attr('action'), postdata, function(code, message) {
            if(code == 0) {
    	       	jdownload_submit.button('下载中...');
    	       	var href = "attach-download-"+aid2+"-"+message+".htm";
    		window.location = href;
    		setTimeout(function() {
                        jdownload_submit.button('reset');
                        jform_download.find('.modal-body #download_code').val('');
                    }, 1500);
    		
            } else {
    	    	$.alert(message);
    	    	jdownload_submit.button('reset');
            }
        });
        return false;
    });

    $('#download_code').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget)
        var aid = button.data('aid');
        var modal = $(this);
        var down_action="attach-download_code-"+aid+".htm";

        modal.find('.modal-body #aid').val(aid);
        modal.find('#form_download').attr('action', down_action);
    })
</script><script>
var page = '1';
$('#thumb').click(function() {
	var threadid = '269534';
	var type = 1;
	var num = parseInt($('#thread_thumb_num').text());
	var postdata = 'threadid=' + threadid + '&type=1&page='+page;
	var that = this;
	$.xpost('thumbs_up-thumbs.htm', postdata, function(code, message) {
		if(code == 0) {
			var s = '<i class="icon-thumbs-o-up" style="color: #0099ee;"></i>&nbsp;<span style="color: #0099ee;">已赞</span>';
			$('#thumb').children('a').html(s);
			$('#thread_thumb_num').text(num + 1);
			$.tips('感谢您的赏识！您已向主题帖作者发送 '+message+' 个雪币，表达感谢', $(that), {
				tips:1,
				time: 2000,
				tips: [1,'#748691']

			});
		} else {
			$.tips(message, $(that), {
				tips: 1,
				time: 2000,
				tips: [1,'#748691']

			});
		}
	})
})
</script>

<script>
$(document).on('click','.reply_thumb',function(){
	
	var index = $('.reply_thumb').index(this);
	var threadid = $(this).find('input').eq(0).val();
	var praised_uid = $(this).find('input').eq(1).val();
	var pid = $(this).find('input').eq(2).val();
	var num = parseInt($('.thumb_num').eq(index).text());
	
	var postdata = 'threadid=' + threadid + '&praised_uid=' + praised_uid +'&pid=' + pid + '&type=2&page='+page;
	var that = this;
	$.xpost('thumbs_up-thumbs.htm', postdata, function(code, message) {
    	if(code == 0) {
            var s = '<i class="icon-thumbs-o-up" style="color: #0099ee;"></i>';
            var new_num = num + 1;
            $('.reply_thumb').eq(index).children('a').html(s);
	    $('.thumb_num').eq(index).text(num + 1);
	    	$.tips('英雄所见略同！您已向该回帖发送  '+message+' 个雪币，表达感谢', $(that), {
			tips: [1,'#748691'],
			time: 4000,
			
		});
        } else {
		$.tips(message, $(that), {
			
			time: 4000,
			tips: [1,'#748691']
		});
	}
	})
})
</script><script>
xn_read_unread({"269534": "1632794530"}, 269534);
</script><script>
jsearch_form = $('#search_form');
jsearch_form.on('submit', function() {
	var keyword = jsearch_form.find('input[name="keyword"]').val();
	var url = xn.url('search-'+xn.urlencode(keyword));
	window.location = url;
	return false;
});
</script><script>
// 语法高亮
if($('div.message pre').length > 0) {
	$.require_css('plugin/xn_syntax_hightlighter/syntax_hightlighter/syntax.css');
	$.require('plugin/xn_syntax_hightlighter/syntax_hightlighter/syntax.js', function() {
		SyntaxHighlighter.all();
	});
}
</script>



<!-- 目录生成JS -->

<script src="./AFL二三事 -- 源码分析 1/tocbot.min.js"></script>

<script>

	$(function() {

		// 目录生成 start

		var header_div = ['h1','h2','h3'];

		var show_tocbot = 0;

		for (var i = 0; i < header_div.length; i++) {

			var h_ob = $(".message_card .message "+header_div[i]);

			

			if (h_ob.length > 0) show_tocbot = 1;

			h_ob.each(function(index){

				$(this).attr("id","msg_header_"+header_div[i]+"_"+index);

			});

		}

		if (show_tocbot == 1) {

			$(".show_tocbot").show();

		}

		tocbot.init({

			// Where to render the table of contents.

			tocSelector: '.js-toc',

			// Where to grab the headings to build the table of contents.

			contentSelector: '.message_card .message',

			// Which headings to grab inside of the contentSelector element.

			headingSelector: 'h1, h2, h3',

			// For headings inside relative or absolute positioned containers within content.

			hasInnerContainers: true,

		});

		// $(window).on("scroll",function(){

		// 	console.log(1);

		// })



		// 选择需要观察变动的节点

		const targetNode = document.getElementById('js-toc');



		// 观察器的配置（需要观察什么变动）

		const config = { attributes: true, childList: true, subtree: true };



		// 当观察到变动时执行的回调函数

		const callback = function(mutationsList, observer) {

			// Use traditional 'for loops' for IE 11

			for(let mutation of mutationsList) {

				// if (mutation.type === 'childList') {

				// 	console.log('A child node has been added or removed.');

				// }

				// else 

				if (mutation.type === 'attributes') {

					targetNode.scrollTo(0,document.getElementsByClassName("is-active-li")[0].offsetTop);

				}

			}

		};



		// 创建一个观察器实例并传入回调函数

		const observer = new MutationObserver(callback);

		// 以上述配置开始观察目标节点

		observer.observe(targetNode, config);

		// 目录生成 end



		

		

	})

</script>
</body></html>